FROM debian:buster
RUN apt-get update && apt-get install -y \
        ccache \
        clang \
        doxygen \
        python3-sphinx \
        python3-sphinxcontrib.bibtex \
        wget \
        ${PISM_DEBIAN_PACKAGE_LIST}

RUN useradd --create-home --system --shell=/bin/false builder && usermod --lock builder
USER builder

# Install parallel HDF5, NetCDF, and ParallelIO by building them from sources.
#
# Uses wget installed above.
COPY hdf5.sh /tmp/
RUN /tmp/hdf5.sh

COPY pnetcdf.sh /tmp/
RUN /tmp/pnetcdf.sh

COPY netcdf.sh /tmp/
RUN /tmp/netcdf.sh

COPY parallelio.sh /tmp/
# RUN /tmp/parallelio.sh

# Add a flag needed to use OpenMPI in a Docker container.
# See https://github.com/open-mpi/ompi/issues/4948
# Tested with OpenMPI version 3.1.3 on Debian 10 (buster)
#
# Allow oversubscribing (i.e. running more MPI processes than the number of cores
# available). Run "ompi_info --all" to get the list of MCA parameters.
ENV OMPI_MCA_btl="^vader" \
    OMPI_MCA_rmaps_base_oversubscribe=yes
