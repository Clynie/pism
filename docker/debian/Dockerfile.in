FROM debian:buster
RUN apt-get update
# Tools and libraries needed to build PISM
RUN apt-get install -y git cmake g++ netcdf-bin libgsl-dev libnetcdf-dev libfftw3-dev libudunits2-dev libproj-dev libpnetcdf-dev petsc-dev python-petsc4py swig
# Tools needed to run test scripts
RUN apt-get install -y python-netcdf4 python-numpy python-scipy python-nose
RUN apt-get install -y nco
RUN apt-get install -y wget

RUN useradd -m --shell=/bin/false builder && usermod -L builder
USER builder

# Install parallel HDF5 and NetCDF by building them from sources.
COPY build_netcdf.sh /tmp/
RUN /tmp/build_netcdf.sh

# Add a flag needed to use OpenMPI in a Docker container.
# See https://github.com/open-mpi/ompi/issues/4948
# Tested with OpenMPI version 3.1.3 on Debian 10 (buster)
ENV OMPI_MCA_btl="^vader"

# Allow oversubscribing (i.e. running more MPI processes than the number of cores
# available). Run "ompi_info --all" to get the list of MCA parameters.
ENV OMPI_MCA_rmaps_base_oversubscribe=yes
