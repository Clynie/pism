\documentclass[11pt,final]{amsart}

\newcommand{\PISMREV}{\input{revision.tex} (stable0.2)}
\newcommand{\PETSCREL}{2.3.3 or 3.0.0}

%\addtolength\topmargin{-.1in}
\addtolength\textheight{0.4in}
\addtolength{\oddsidemargin}{-.4in}
\addtolength{\evensidemargin}{-.4in}
\addtolength{\textwidth}{0.9in}
\newcommand{\normalspacing}{\renewcommand{\baselinestretch}{1.1}\tiny\normalsize}
\newcommand{\tablespacing}{\renewcommand{\baselinestretch}{1.0}\tiny\normalsize}
\normalspacing

\usepackage{bm,url,xspace,verbatim}
\usepackage{amssymb,amsmath}
\usepackage[pdftex]{graphicx}
\usepackage[pdftex]{hyperref}

%% uncomment to see locations of index entries
%\usepackage{showidx}

\newcommand{\ddt}[1]{\ensuremath{\frac{\partial #1}{\partial t}}}
\newcommand{\ddx}[1]{\ensuremath{\frac{\partial #1}{\partial x}}}
\newcommand{\ddy}[1]{\ensuremath{\frac{\partial #1}{\partial y}}}
\renewcommand{\t}[1]{\texttt{#1}}
\newcommand{\Matlab}{\textsc{Matlab}\xspace}
\newcommand{\bq}{\mathbf{q}}
\newcommand{\bU}{\mathbf{U}}
\newcommand{\eps}{\epsilon}
\newcommand{\grad}{\nabla}
\newcommand{\Div}{\nabla\cdot}

%% macros having to do with documentation for options; note these appear in the index
\newcommand{\und}{\_\!\_}

%\newcommand{\alphaoptionindex}[1]{\index{alphabetical list of options for PISM (and PETSc)!\texttt{-#1}}}
\newcommand{\pismoptionindex}[1]{\index{options for PISM (and PETSc)!\texttt{-#1}}}
\newcommand{\intextoption}[1]{\texttt{-#1}\pismoptionindex{#1}}

%\newcommand{\rawopt}[1]{\vspace{1mm}\noindent \large\texttt{-#1}\normalsize\pismoptionindex{#1}\alphaoptionindex{#1}}
\newcommand{\rawopt}[1]{\vspace{1mm}\noindent \Large\texttt{-#1}\normalsize\pismoptionindex{#1}}
\newcommand{\opt}[1]{\rawopt{#1}\,:\quad}
\newcommand{\optdef}[2]{\rawopt{#1}\,[\textsl{#2}]:\quad}
\newcommand{\optrestrict}[2]{\rawopt{#1}\,[\texttt{#2} \textsl{only}]:\quad}
\newcommand{\optdefrestrict}[3]{\rawopt{#1}\,[\textsl{#2}]\,[\texttt{#3} \textsl{only}]:\quad}


% preamble:

\makeindex

\title[PISM User's Manual]{\protect{\Large \emph{PISM}, a Parallel Ice Sheet Model:\normalsize} \\ \protect{\Large \bigskip \bigskip User's Manual\normalsize}}

\author[]{Ed Bueler \\ Constantine Khroulev \\ Jed Brown \\ Nathan Shemonski}

\date{\today.  Support by email: \texttt{help\@@pism-docs.org}.  Based on PISM revision \PISMREV\,and PETSC release \PETSCREL.  Get development version of PISM source code: \\ \centerline{\texttt{svn co http://svn.gna.org/svn/pism/trunk pism-dev} \quad}} 

\pdfinfo{
/Title (PISM User's Manual)
/Author (Ed Bueler and Constantine Khroulev and Jed Brown and Nathan Shemonski)
/Subject (Using PISM, a Parallel Ice-Sheet Model)
/Keywords (PISM ice sheet modeling)
}

\begin{document}
\maketitle
\thispagestyle{empty}

\vspace{2.0in}
\begin{center}
\includegraphics[width=2.5in,keepaspectratio=true]{figs/greencbar_SSL2}\, \includegraphics[width=3.2in,keepaspectratio=true]{figs/rossquiver}
\end{center}

\newpage
\phantom{bob}
\vspace{1.5in}
\begin{quote}
\textsl{Copyright (C) 2004--2009 Ed Bueler and Constantine Khroulev and Jed Brown and Nathan Shemonski}
\medskip

\noindent \textsl{This file is part of PISM.}
\medskip

\noindent \textsl{PISM is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  PISM is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License\index{GPL (\emph{GNU Public License})} along with PISM; see \emph{\texttt{COPYING}}.  If not, write to the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA}
\end{quote}
\vspace{0.6in}
\normalspacing

\centerline{\textsc{Acknowledgements}}
\bigskip

The NASA Modeling, Analysis, and Prediction program\index{NASA!Modeling, Analysis, and Prediction Program}, funded proposal 08-MAP-0108, supports the development of PISM.  Development from 2003 to 2008 was supported by the NASA Cryospheric Sciences Program\index{NASA!Cryospheric Sciences Program}, grant NAG5-11371.

The Arctic Regional Supercomputer Center has provided significant computational resources and technical help in the development of PISM.

Our research into ice sheet modeling was strongly influenced and constantly motivated by Craig Lingle\index{Lingle, Craig}.  Dave Covey, Don Bahls, and Greg Newby have supported our computers, tools, and and computations.  Thanks to Tolly Adalgeirsdottir, Andy Aschwanden, Torsten Albrecht, Marianne Hasselhoff, Tore Hattermann, Jesse Johnson, Art Mahoney, Anders Levermann, Maria Martin, Kent Overstreet, Martin Truffer, Ben Sperisen, Ricarda Winkelmann, Ryan Woodard and several other PISM users for helpful comments and questions on PISM and this \emph{Manual}.

\newpage
\setcounter{tocdepth}{2}
\small
\tableofcontents
\normalsize

\newpage
\section{Introduction}\label{sect:intro}

Welcome!  All information about PISM is online at
\begin{center}
  \href{http://www.pism-docs.org}{\t{www.pism-docs.org}}
\end{center}
\noindent See the \emph{Installation Manual} for how to download\index{PISM!download source code} the PISM source code and install it\index{PISM!install} and the libraries it needs.  

This \emph{User's Manual} and the \emph{Installation Manual} can be generated from any copy of the PISM source code by doing \verb|make userman installation| in the PISM root directory and then viewing \verb|doc/manual.pdf| and \verb|doc/installation.pdf| with a PDF viewer.

This \emph{User's Manual} describes how to run PISM for certain simplified geometry situations and it illustrates how PISM's numerical approximations are verified.  It documents all the PISM options.  It describes how to use PISM as a Greenland ice sheet model or a Ross ice shelf model, based on certain publicly-available data.

Users who want to advance the science of ice sheets will need to go beyond what is described here.  For such users there are two additional documents to know about:
\begin{enumerate}
 \item  The \emph{C++ Class Browser}\index{PISM!\emph{C++ Class Browser (HTML)}} gives a complete view of the class/object structure of the source code.  It is the best tool for understanding the internals of PISM, and for the job of modifying and supplementing PISM by writing derived classes.  It is online at
   \begin{center}
     \href{http://www.pism-docs.org/doxy/html/index.html}{\t{www.pism-docs.org/doxy/html/index.html}}
   \end{center}
The \emph{Browser} can be generated from the source by doing \verb|make browser| in the PISM root directory and then viewing \verb|doc/doxy/html/index.html|.
 \item  The \emph{Reference Manual}\index{PISM!\emph{Reference Manual}}
documents only the continuum models and numerical methods of PISM.  A current \emph{Reference Manual} can be generated from the source by doing \verb|make refman| in the PISM root directory and then viewing \verb|doc/refman.pdf|.
\end{enumerate}
The \emph{C++ Class Browser} and the \emph{Reference Manual} are automatically generated by \verb|doxygen| (\href{http://www.doxygen.org/}{\t{www.doxygen.org}}) from comments in the PISM source code.

\vspace{1.0in}
\large
\begin{center}
\framebox{\parbox{5.0in}{ \emph{WARNING}:\index{PISM!warning}  PISM is an ongoing project.  Ice sheet modeling is complicated and is generally not mature.  Please don't trust the results of PISM or any other ice sheet model without a fair amount of exploration.  Also, please don't expect all your questions to be answered here.  Write to us with questions.} }

\bigskip

\href{mailto:help@pism-docs.org}{\texttt{help@pism-docs.org}}
\normalsize
\end{center}
\normalsize


\clearpage\newpage
\section{Getting started}\label{sect:start}\index{PISM!getting started}

See the \emph{Installation Manual} to install PISM.  Once installed, the \verb|pgrn|, \verb|pismd|, \verb|pismr|, \verb|pisms|, and \verb|pismv| executables will be in the \verb|bin| subdirectory of the PISM root directory.  The \emph{User's Manual} addresses the use of all five executables.  This \emph{Getting started} section only uses \verb|pisms|.
 
\subsection{Running an EISMINT simplified geometry experiment}\index{EISMINT}  PISM's purpose is the simulation of actual ice sheets.  But actual ice sheet simulations require actual data.  Ice sheet and ice shelf data \emph{are} freely available as part of the EISMINT intercomparison efforts.  Section \ref{sect:green} is a tutorial on the use of PISM as a Greenland ice sheet evolution model and section \ref{sect:ross} is a tutorial on using PISM as a Ross ice shelf diagnostic model.  Both use the EISMINT data sets.

For now, to avoid issues of data formats, flaws and data-handling scripts in a first use of PISM, this section describes how to use PISM for experiment A in the ``EISMINT II'' simplified-geometry, thermomechanically-coupled ice sheet model intercomparison \cite{EISMINT00}.  This experiment models an angularly-symmetric shallow, grounded ice sheet on a flat bed with moderately cold surface temperatures.

In EISMINT II the prescribed grid has 60 subintervals in each direction, with each subinterval of length 25km.  Thus the total width of the computational box is 1500 km in both $x$ and $y$ directions.  However, PISM always allows choice of the grid in all three dimensions.  A runtime option chooses the number of grid points in each direction, and the number of points is one greater than the number of subintervals (grid spaces).  The vertical grid is not prescribed in EISMINT II.  For a demonstration we choose a 25km grid in the horizontal and we use 41 grid points in the vertical with unequal spacing.  The spacing is finest at the bottom of the ice column (34 m) and coarsest at the top (216 m).  The computational box is 5000 m high by default for EISMINT II experiment A in PISM, so no runtime option is needed to set that.

Experiment A starts with zero ice, all EISMINT II runs are for 200,000 model years.  The center thickness of the ice sheet grows to a peak near 4100 m, at about 9,000 model years, before decaying to its equilibrium center thickness of about 3750 m.  Here we start with a short 6000 year run for a quick illustration.  The executable is ``\t{pisms}''\index{pisms}, for the ``simplifed geometry mode'' of PISM:\index{pisms}\pismoptionindex{eisII}\pismoptionindex{Mx}\pismoptionindex{My}\pismoptionindex{Mz}\pismoptionindex{quadZ}\pismoptionindex{y}

\small
\begin{quote}
\begin{verbatim}
$ pisms -eisII A -Mx 61 -My 61 -Mz 41 -quadZ -y 6000
PISMS stable0.2 (simplified geometry mode)
setting parameters for EISMINT II experiment A ... 
initializing EISMINT II experiment A ... 
[computational box for ice:  1500.00 km x  1500.00 km x  5000.00 m]
[hor. grid cell dimensions:    25.00 km x    25.00 km
 vertical grid spacing in ice not equal; range 33.594 m < dz < 216.406 m]
running EISMINT II experiment A ...
P         YEAR:     ivol   iarea    meltf     thick0     temp0
U        years 10^6_km^3 10^6_km^2 (none)          m         K
S      0.00000:  0.00000  0.0000   0.0000      0.000  273.1500
 $$ SIA        vath 0m  +60.00000
S     60.00000:  0.01704  0.6281   0.0000     30.000  238.1500
. . .
 $$ SIA        vath 0e  +2.05570
S   6000.00000:  1.68054  0.7506   0.0100   3000.000  248.6280
done with run ...
Writing model state to file `simp_exper.nc'
\end{verbatim}
\end{quote}
\normalsize
\noindent This should take less than one minute.

In a moment we will address the standard output information provided by PISM, as shown above, but for now we simply illustrate how to continue and complete the 200,000 year run.  The model state was stored in a NetCDF file with the (default) name \verb|simp_exper.nc|.  The next run will use a ``\intextoption{o}'' option to name the output file.  The above was a single processor run, but let's suppose we have a four processor (e.g.~four cores on a single processor, or other arrangement) machine.  It should also work fine on a single processor machine but there is no speed-up, naturally.  Let's also run things in the background so we can continue to experiment:\pismoptionindex{skip}\pismoptionindex{i}\index{mpiexec}\pismoptionindex{o}

\small
\begin{quote}
\begin{verbatim}
$ mpiexec -n 4 pisms -eisII A -i simp_exper.nc -skip 5 -y 194000 \
          -o eisIIA200k.nc >> out.eisIIA &
\end{verbatim}
\end{quote}\normalsize

You can also use \verb|-ye 200000| instead of \verb|-y 194000| --- if you don't know how long the first run was, for example. This run will take less than one wall clock hour, and perhaps much less.  PISM being parallel, it can be sped up by using more processes.  The standard output in \verb|out.eisIIA| can be tracked as the job is running in the background using \verb|less|\index{less}, for instance.  Also, \verb|top|\index{top} is a Linux tool to watch CPU and memory usage during the run.

The run generates a NetCDF file \verb|eisIIA200k.nc| at the end.  The final results for ice volume, area, melt fraction, center thickness, and center basal temperature (2.29575 $10^6 \text{km}^3$, 1.0356 $10^6 \text{km}^2$, 0.6156, 3743.075 m, 257.2799 K, respectively) are typical of EISMINT II intercomparison results shown in Table 4 of \cite{EISMINT00}.  The correctness of PISM's approximations of the equations for ice flow is mostly addressed by measuring its errors relative to exact solutions to those equations, and not through comparison to average behavior of other ice flow models.  See section \ref{sect:verif} on verification.

To get the model state in the midst of a PISM run, send all running \verb|pisms| processes (the PISM executable used here) a signal which causes PISM to write out the model state: \verb|pkill -USR1 pisms|.\index{PISM!catches signals -TERM and -USR1}\index{USR1}\index{pkill}  The PISM model state is then saved in a NetCDF file with name \verb|pism-|\emph{year}\verb|.nc|, using the year at that time step.  On the other hand, terminating the run with \verb|pkill -TERM pisms| will cause PISM to stop, but only after saving the model state using the specified output name.  See subsection \ref{subsect:signal} for a more complete description of how PISM catches signals.

While the complete run continues in the background, let's view the intermediate result stored in \verb|simp_exper.nc|.  An important fact to know is that a PISM output NetCDF file contains a ``history'' with the command that produced it.  For instance, 

\verb|$ ncdump -h simp_exper.nc|

\noindent shows the structure (``header'') of the output NetCDF file, with lines like these near the bottom:
\small
\begin{verbatim}
:history = "user@host 2009-02-19 20:28:18 AKST:  PISM done.  PETSc MFlops = 1.23.\n",
        " pisms -eisII A -Mx 61 -My 61 -Mz 41 -quadZ -y 6000\n",
        "user@host 2009-02-19 20:27:42 AKST:  PISM (...) started on 1 procs.\n",
\end{verbatim}
\normalsize
\noindent This kind of ``history'' is convenient for understanding what you have done, once it all works!

\begin{figure}[ht]
\includegraphics[height=3.5in,keepaspectratio=true]{figs/eisIIA_ncviewshot}
\caption{\texttt{ncview} shows an intermediate stage of an EISMINT II experiment A run.}
\label{fig:ncviewshot}
\end{figure}

Another way to view the output file is graphically.  One of the most convenient tools is \verb|ncview|; see Table \ref{tab:NetCDFview}.  Running ncview on the output file (\verb|ncview simp_exper.nc|) and viewing the ``\t{thk}'' variable gives a figure like \ref{fig:ncviewshot}.

Alternatively, one can use PISM's ``diagnostic viewers'' for a time-dependent view of the evolving modeled ice sheet.  Note this requires X Windows:\index{pisms}\pismoptionindex{eisII}\pismoptionindex{d}

\verb|$ pisms -eisII A -i simp_exper.nc -y 1000 -d HTt|

\noindent Three figures should appear and be refreshed at each time step.  One figure is a map-plane view of thickness, another is a map-plane view of the basal temperature in Kelvin, and the third is a graph of temperature versus height above the bedrock.  When the full 200,000 year run finishes, one may watch its evolving, though essentially steady, state.  A view that includes the ice flow speed is:

\verb|$ pisms -eisII A -i eisIIA200k.nc -d HTc|

\noindent for example.  Figure \ref{fig:screenshot} will appear.

\begin{figure}[ht]
\includegraphics[height=3.5in,keepaspectratio=true]{figs/eisIIAshot}
\caption{Screenshot of diagnostic figures for an EISMINT II experiment A run.}
\label{fig:screenshot}
\end{figure}

As shown by the ``\verb|-d|'' options above, runtime viewers can be specified by options of the form \intextoption{d} \emph{letters} or \intextoption{dbig} \emph{letters}.  The latter option shows larger windows but is otherwise identical.  See Appendix \ref{sect:viewers} for the single letter names of viewers.  These viewers are updated at each time step and are not used for runs in batch mode or where efficiency is needed.  (As they work under Xwindows, MPI must be told how to send data to the window, so PISM options are usually followed by ``\verb|-display :0|''\pismoptionindex{display} when PISM is run under MPI and runtime viewers are needed.)


\subsection{PISM's standard output}   As seen already, at each time step PISM shows a summary\index{PISM!standard output summary of each time step} of the model state using a few numbers and some single character flags.  The format of the summary is partly explained by two lines near the beginning of the run:

\small\begin{quote}
\begin{verbatim}
P         YEAR:     ivol   iarea    meltf     thick0     temp0
U        years 10^6_km^3 10^6_km^2 (none)          m         K
\end{verbatim}
\end{quote}\normalsize

The ``\t{P}'' line is the prototype for the summary which appears at each time step.  The ``\t{U}'' line gives units for this summary.  From then on, the ``\t{S}'' lines give values for the quantities specified by the  ``\t{P}'' and ``\t{U}'' lines.

The EISMINT II runs above illustrate how the time-stepping in PISM adapts in order to maintain stability for its (mostly) explicit methods.  At the beginning of the EISMINT II run, for instance, the ice has small thickness so the time step is 60 years, simply because that is the default maximum time step.  Later in that run, after about 5000 years, the time step is made smaller because the flow is faster.

After the year, the next three entries in the summary report the volume of the ice in $10^6 \,\text{km}^3$, the area covered by the ice in $10^6\,\text{km}^2$, and the basal melt fraction, that is, the fraction of the ice area where the basal temperature is at the pressure-melting temperature.  This melted-base-fraction is a pure number without units.  The next two columns ``\texttt{thick0}'' and ``\texttt{temp0}'' are values at the center of the computational domain of the map plane, namely the ice thickness in meters and the absolute temperature of the ice at its base, in Kelvin.  These five numbers are the ones reported in the tables in \cite{EISMINT00}, which explains why they are the default quantities for reporting to standard output.  For more on the EISMINT II experiments see section \ref{sect:simp}.

The summary of the model state can be made more verbose by using the option \verb|-verbose|.  

In addition to the ``\t{S}'' lines, there are lines, starting with a space character, which give flags, both cryptic and compact, describing the PISM model choices made at each time step.  Most of these relate to decisions of the adaptive time-stepping scheme.  That scheme is described in subsection \ref{subsect:adapt}

If the standard output from PISM is saved in a text file then it can always be converted to a NetCDF file with corresponding time series.  For the 200,000 year run above,

\verb|$ series.py -f out.eisIIA -o ser.eisIIA.nc|

\verb|$ ncview ser.eisIIA.nc|

A look at these time series shows the convergence to equilibrium of this non-sliding thermomechanically coupled modeled ice sheet.  We see, characteristically, that there is a longer relaxation time for temperature at the base of the ice than for any geometric quantity (volume, area, thickness).

\subsection{Handling NetCDF files}  At a trivial level, PISM is just a program which takes a NetCDF file as input, does some computation, and produces a NetCDF file as output.  (An exception is that \verb|pisms| knows formulas to initialize EISMINT II experiments, for example.)  The user is in charge of creating NetCDF input files containing data on ice sheets worth modeling\footnote{See the section \ref{sec:bootstrapping-format} and table \ref{tab:modelhierarchy} for a hint about data necessary for modeling.}, and extracting some meaning from the NetCDF output files.

The most basic tools for converting NetCDF files to and from a standard text representation are called \verb|ncdump| and \verb|ncgen|.  A glance at Unix \verb|man| pages for these tools might be wise at this time.

As suggested earlier, we regularly use \verb|ncview| to look at NetCDF files.  The NetCDF tools most frequently used by the PISM developers are shown in Table \ref{tab:NetCDFview}.  This website gives additional NetCDF-related tools:

\centerline{ \href{http://www.unidata.ucar.edu/software/netcdf/docs/software.html}{\t{www.unidata.ucar.edu/software/netcdf/docs/software.html}} } 

\begin{table}[ht]
\caption{Some tools for viewing and modifying NetCDF files.}\label{tab:NetCDFview} 
\small
\begin{tabular}{@{}llll}\hline
\textbf{Tool} & \textbf{Site} & \textbf{Function}\\ \hline
\verb|ncdump| & \emph{included with any NetCDF distribution} & dump binary NetCDF as \texttt{.cdl} (text) file \\
\verb|ncgen| & \emph{included with any NetCDF distribution} & convert \texttt{.cdl} file to binary NetCDF \\
\verb|ncview|\index{ncview} & \href{http://meteora.ucsd.edu/~pierce/ncview_home_page.html}{\texttt{meteora.ucsd.edu/$\sim$pierce}} & quick graphical view \\
IDV & \href{http://www.unidata.ucar.edu/software/idv/}{\t{www.unidata.ucar.edu/software/idv/}} & more complete visualization \\
VisIt & \href{http://visit.llnl.gov}{\t{visit.llnl.gov}} & advanced parallel visualization \\
NCO\index{NCO (NetCDF Operators)} & \href{http://nco.sourceforge.net/}{\t{nco.sourceforge.net/}} & ``NetCDF Operators'': manipulations \\
\quad  & & \quad at command line
\end{tabular}
\normalsize
\end{table}



\clearpage
\newpage
\section{Ice dynamics, the PISM view}\label{sect:dynamics}

\subsection{Principles}\index{PISM!principles}  The main goal of the current section is to give an overview of ice dynamics models in PISM, but we list some high-level organizing principles for PISM generally:
\begin{enumerate}
\item source code is open, free, and actually usable with free software tools,
\item science is done with publicly-available data,
\item numerical methods are verifiable by comparison with exact solutions of the modeled equations,
\item models are shallow,
\item the availability of a hierarchy of simplifying ice dynamics assumptions is more important than any particular set of dynamical equations,
\item everything available diagnostically (instantaneously) is available for evolution,
\item climate inputs affect ice dynamics by a well-defined interface.
\end{enumerate}

\noindent We do not claim to follow these principles perfectly.  We hope, however, that the user will see these principles reflected in PISM and this \emph{Manual}.

Principle (2) is illustrated by sections \ref{sect:green} and \ref{sect:ross}.  Principle (3) is addressed in section \ref{sect:verif}.  Principles (4), (5), (6), and (7) are explained next.


\subsection{Two main shallow models, SIA and SSA}\index{PISM!SIA}\index{PISM!SSA}  PISM can (currently) numerically solve two significantly different sets of partial differential equations which determine the velocity field within the ice.  In each case the geometry of the ice, the temperature of the ice, and the stress condition at the base of the ice are included into balance of momentum equations to determine the flow.  But there are two different versions of the balance of momentum equations:\begin{itemize}
\item the shallow ice approximation (SIA)\index{SIA (shallow ice approximation)} \cite{Hutter}, which describes ice as flowing by shear in planes parallel to the geoid, a lubrication approximation \cite{Fowler}, with such shearing a local function of the driving stress of classical glaciology \cite{Paterson}, and
\item the shallow shelf approximation (SSA)\index{SSA (shallow shelf approximation)} \cite{WeisGreveHutter}, which describes a membrane-type flow with the ice floating, or sliding over a weak base \cite{Morland,MacAyeal,SchoofStream}.
\end{itemize}
PISM numerically solves both the SIA and SSA equations in parallel.  Time-stepping solutions of the mass continuity equation are possible for both models.

The SIA\index{SIA (shallow ice approximation)!applicability} equations are, as a rule, easier and quicker to numerically solve than the SSA.  The SIA equations are also easier to parallelize.\index{parallelization!relative ease of, between SIA and SSA}  They can confidently be applied to those grounded parts of ice sheets for which the basal ice is frozen to the bedrock and the bed topography is relatively slowly-varying in the map-plane \cite{Fowler}.  (We recommend solving the SIA with a non-sliding base because the ad hoc addition of a ``sliding law''\index{SIA (shallow ice approximation)!sliding law} which switches on at the pressure-melting temperature tends to have unavoidable bad numerical consequences \cite[appendix B]{BBssasliding}.  In PISM the SSA can be used as a sliding law, however.)

The SSA\index{SSA (shallow shelf approximation)!applicability} equations can confidently be applied to large floating ice shelves because such shelves have small depth-to-width ratio and because there is negligible shear stress at the base of the floating ice \cite{Morland,MorlandZainuddin}.

Ice sheets also have fast-flowing \emph{grounded} parts, however, called ``ice streams'' or ``outlet glaciers''.  Such features appear at the margin of, and even well into the interior of, the Greenland \cite{Joughinetal2001}\index{Greenland ice sheet} and Antarctic \cite{BamberVaughanJoughin}\index{Antarctic ice sheet} ice sheets.  Describing these faster-flowing grounded parts of ice sheets requires something more than the non-sliding SIA.  Ultimately one might use the full Stokes equations which represent the balance of \emph{all} tensor components \cite{Fowler}, but there is still the issue of the appropriate sliding boundary condition.  Similarly one might use a ``higher-order'' but still shallow stress balance \cite{Blatter,Pattyn03}, but again a proper choice of boundary condition is important.

One may apply the SSA equations with additional basal resistance terms to describe fast-flowing grounded ice.  This is demonstrated in the context of the Siple Coast ice streams of Antarctica by MacAyeal\index{MacAyeal, Doug} \cite{MacAyeal,HulbeMacAyeal} using a linearly-viscous model for the underlying till, and in many other referenes.  A free boundary problem with essentially the same (SSA) balance equations is the Schoof\index{Schoof, Christian} \cite{SchoofStream} model of ice streams.  In Schoof's model ice streams emerge in those parts of the ice sheet where there is plastic till failure \cite{Paterson}.

As noted, both the SIA and SSA models are \emph{shallow} approximations.  That is, the respective partial differential equations are derived by different small-parameter arguments, both based on a small depth-to-width ratio, from the Stokes equations of a non-Newtonian fluid.  For this small-parameter argument in the SIA case see \cite{Fowler}.  For the corresponding SSA argument, see \cite{WeisGreveHutter} or the appendices of \cite{SchoofStream}.  See \cite{SchoofHindmarsh} on connections between these shallowest models and ``higher order'' models.\footnote{The references are, of course, the right place to see serious discussion of continuum equations and their physical motivation.}

By default, PISM does not numerically solve the SSA.  The user must add the option \intextoption{ssa}.  (An exception is the use of the executable \verb|pismv| for verifying the SSA balance of momentum equations, as addressed in section \ref{sect:verif}.)


\subsection{A hierarchy of simplifying assumptions for ice flow}\index{PISM!hierarchy of simplifying assumptions}   Table \ref{tab:modelhierarchy} describes a hierarchy of models, applicable to grounded ice, which are implemented in PISM or are planned.  Essentially, this hierarchy is listed in order of increasing effectiveness in modeling whole ice sheets with fast flow features.  It is also listed in order of increasing need for data to serve as boundary and initial conditions, an important consideration for the scientific user.

\begin{table}[ht]
\caption{Hierarchy of current and planned flow models in PISM, for the grounded parts of ice sheets, from most to fewest simplifying assumptions.  (\emph{Italicized} are planned for future versions of PISM but are not implemented in \texttt{stable0.2}.)}\label{tab:modelhierarchy} 
\small
\begin{tabular}{|l|l|l|l|}\hline
\textbf{Model} & \textbf{Assumptions} & \textbf{Needed data} & \textbf{Refs.} \\ \hline
\emph{balance velocities} & \emph{steady state, ice flows down} & surf.~mass balance, ice & \cite{JoughinetalGrBal97} \\
 & \quad \emph{surface gradient} & \quad thickness, bed elevation & \\ \hline
isothermal SIA & non-sliding lubrication flow, fixed & same, but possibly time- & \cite{EISMINT96,BLKCB} \\
 & \quad softness & \quad dependent &  \\ \hline
thermomechanically & non-sliding lubrication flow, & same, plus surf.~temperature, & \cite{BBL} \\
\quad -coupled SIA & \quad temperature-dependent softness & \quad geothermal flux &  \\ \hline
SIA + SSA hybrid & SSA as a sliding law for thermo-  & same, plus basal layer (till) & \cite{BBssasliding} \\
  & \quad mechanically-coupled SIA & \quad strength &  \\ \hline
\emph{Blatter-Pattyn} & \emph{``higher-order'', bridging stresses} & same & \cite{Blatter,Pattyn03} \\ \hline \hline
full Stokes & not planned; ice is a fluid & same & \cite{Hutter,Fowler} \\ \hline
\end{tabular}
\normalsize
\end{table}

It does make sense to also talk about an \emph{ice shelf} model hierarchy, and even about a special hierarchy of models for the transition from grounded to floating ice \cite{SchoofMarine1}, but this would take us too far afield.  Currently, ice shelves are modeled by the SSA equations in PISM.


\subsection{Evolutionary versus diagnostic ice shelf modeling} \label{subsect:basicmodes}\index{PISM!evolution run}\index{PISM!diagnostic run}    The main goal of a numerical ice sheet model like PISM is to be a dynamical system which evolves over time as similarly as possible to the modeled ice sheet.  Such a goal assumes one has the right climate inputs and parameter choices at each time step.  Such a goal also assumes one starts with the right initial conditions, adequately describing an instantaneous state of the ice sheet, and this need for initial conditions is rarely met in practical ice sheet modeling.  

Indeed, underlying an ice sheet model like PISM are evolution-in-time partial differential equations, and PISM generally solves these by taking small time steps\footnote{``Small'' time steps vary from hundredths to many model years, depending primarily on grid resolution, but also on modeled ice flow speed.} in approximating these differential equations.  We will describe this usual time-stepping behavior as an ``evolution run.''

Much modeling, especially of streams and shelves, uses only instantaneous ``diagnostic'' solution of the partial differential equations which determine the velocity field.  The existence of such ``instantaneous'' velocity fields follows fromt the slowness of ice, an important simplifying assumption underlying all models in the Table \ref{tab:modelhierarchy} hierarchy.  See \cite{Fowler}, for example.  In a diagnostic computation the temperature field and certain basal conditions, such as strength parameters for the till for instance, are held fixed.  So the goal of a ``diagnostic run'' is to compute the velocity field, including the instantaneous rate of surface movement.  This will be the definition of that phrase used from now on.

Sections \ref{sect:green} and \ref{sect:ross} illustrate the evolutionary versus diagnostic modeling modes.  The first is a time-stepping SIA-only model for the Greenland ice sheet while the second is a diagnostic SSA model for the Ross ice shelf.


\subsection{Separation of climate inputs from ice dynamics}\label{subsect:separateclimate}  
PISM's job is to approximate ice flow.  In addition, as described in subsection \ref{subsect:beddef}, PISM includes an optional bed deformation component approximating the movement of the Earth's crust and upper mantle in response to changing ice load.  Also, the temperature of a thin layer of bedrock is included in the conservation of energy model for the ice and the till layer.

Thus PISM ``handles'' the ice and bedrock, when used with other models for the atmosphere and ocean, as cartooned in Figure \ref{fig:climatecartoon}.  ``Other models'' may be anything from trivially-parameterized surface mass balance to full GCMs of astonishing complexity.

\begin{figure}[ht]
\vspace{0.2in}
\includegraphics[height=1.75in,keepaspectratio=true]{figs/climate_cartoon}

\vspace{0.1in}
\caption{PISM approximates ice flow and bed deformation, so it ``handles'' the region below the dashed curve.  Components called \t{PISMAtmosphereCoupler} and \t{PISMOceanCoupler} provide climate inputs at the ice upper surface and under ice shelves, respectively.}
\label{fig:climatecartoon}
\end{figure}

In fact, within the ice dynamics/bed deformation PISM core code, there is no parameterization or other model for boundary mass or energy balance.\footnote{This principle is a change from \t{stable0.1}.}  This is a structural principle for PISM.  Instead, boundary mass or energy balance computations are handled by non-core interface components called \t{PISMAtmosphereCoupler} and \t{PISMOceanCoupler}.   The former type is for the ice upper surface while the latter type is special to the undersides of ice shelves.  The advantage of this arrangement is that ``attaching'' PISM to other components of a global or regional climate (circulation) model is intended to be a matter only of changing a small amount of the PISM interface source code---primarily addition of \t{PISM...Coupler} derived classes along with a new driver---without any change to the ice dynamics core.

The dashed line in Figure \ref{fig:climatecartoon} suggests that there is a thin layer on the ice surface not modeled by PISM.  This is true.  ``Ice dynamics'' must include the mass of the snow/firn layer, but it cannot include the processes which transform this layer into ice with a certain temperature, below that layer.  Similarly, the undersides of ice shelves include (relatively poorly-understood, but very important!) processes \emph{not} modeled by core PISM, though potentially modeled in a \t{PISMOceanCoupler}.  In any case, the job of the \t{PISM...Coupler} components is, as already stated, provide definitive boundary mass or energy balance to the ice dynamics core.

The PISM source code already contains instances of \t{PISM...Coupler} components.  For example, instances of \t{PISMAtmosphereCoupler} exist for the simplified geometry experiments in section \ref{sect:simp}, and for the Greenland model in section \ref{sect:green}.

Actually, most of this is invisible to the PISM user.  Options given to the PISM executables (e.g.~\t{pismr} or \t{pisms}) are passed internally to the \t{PISM...Coupler} components, so it looks to the user as if command line control of climate inputs is the same as command line control of ice dynamics.  For example, an important kind of \t{PISMAtmosphereCoupler}, namely a positive degree day scheme for surface mass balance, is described in subsection \ref{subsect:pdd} as a part of PISM.  It \emph{is} part of PISM, but it is outside a well-defined ice dynamics core.

This structure is important to describe here because, on the one hand, some users may be interested in coupling PISM to other models.  On the other hand, the PISM authors do not claim expertise in modeling atmosphere, ocean, or even snow processes, and so separation has a code-reliability purpose as well.  ``Users'' need to know that they are ultimately responsible for providing the climate inputs they intend.


\clearpage
\newpage
\section{Initialization and bootstrapping}\label{sect:boot}  

\subsubsection*{``Initialization from a saved model state''}  This phrase\index{initialization!from saved model state} has a simple meaning in PISM.  If a previous PISM run has saved a NetCDF file using ``\verb|-o|'' then that file will contain complete initial conditions for continuing the run.  The output file from the last run can be loaded with ``\intextoption{i}'':\index{pisms}

\begin{verbatim}
$ pisms -eisII A -y 100 -o foo.nc
$ pisms -eisII A -i foo.nc -y 100 -o bar.nc
\end{verbatim}
\smallskip

Note that simplified-geometry experiments (section \ref{sect:simp}) and verification tests (section \ref{sect:verif}) do not need input files at all because they initialize from formulas in the source code.  They can be continued from saved model states using \verb|-i|.  As in the above example, however, specifying the simplified geometry experiment or verification test \emph{is} necessary, so that the run can continue with the climate inputs for that experiment or test.  For instance, it is an error to replace the second line above with ``\verb|$ pisms -i foo.nc -y 100 -o bar.nc|''.  It is valid to do ``\verb|$ pismr -i foo.nc -y 100 -o bar.nc|'' but the climate and other parameters default to the core PISM default values, and thus not (necessarily) the values specified in EISMINT II.

As a technical but important note about saved states, a PISM run with \intextoption{ssa}
also saves the last SSA velocities to the output file, in variables 
\verb|vubarSSA| and \verb|vvbarSSA|.  A \verb|ssa_velocities_are_valid| global
attribute shows if the data present in these variables is valid.  The presence
of these velocities adds efficiency in restarting.  If you want a PISM restart to
ignor these velocities use \intextoption{dontreadSSAvels}.


\subsubsection*{``Bootstrapping''}  This phrase\index{bootstrapping}\index{initialization!by bootstrapping} means starting a modeling run with less than sufficient data, and letting the model fill in needed values according to heuristics.  These heuristics are applied before the first time step is taken, so they are part of an initialization process.  Bootstrapping uses the option \intextoption{boot\und from}.

The need for an identified stage like ``bootstrapping'' comes from the fact that initial conditions, for the evolution equations describing an ice sheet, are not typically observable.  As a principal example of this problem, these equations require the temperature within the ice at the time the run is started.  Glaciological observations, specifically remote-sensed observations which cover a large fraction or all of an ice sheet, never include this temperature field in practice.

Instead, evolutionary ice sheet modeling necessarily does something like this to get ``reasonable'' initial fields within the ice: \begin{enumerate}
\item start only with observable quantities like surface elevation, ice thickness, and ice surface temperature,
\item ``bootstrap'' as defined here, using heuristics to fill in temperatures at depth and to give a preliminary estimate of the basal sliding condition, and thus of the three-dimensional velocity field, and
\item \emph{either} do a long run holding the current geometry and surface temperature steady,  to evolve toward a ``more physical'' steady state which will have compatible temperature field, velocities, and age field,
\item \emph{or} do a long run using an additional spatially-imprecise historical record from an ice core or a sea bed core (or both), to apply forcing to the surface temperature or sea level (for instance), but with the same functional result of filling in a temperature, velocity, and age.
\end{enumerate}

The heuristics used by PISM are, for now, only documented in the source code file \verb|src/base/iMbootstrap.cc|.

When using \intextoption{boot\und from} you will need to specify both grid dimensions (using \intextoption{Mx}, \intextoption{My} and \intextoption{Mz}) and the height of the computational box for the ice with \intextoption{Lz}.  The data read from the file can determine the horizontal extent of the model, if options \intextoption{Lx}, \intextoption{Ly} are not set.  The additional specification of vertical extent by \verb|-Lz| is reasonably natural because realistic data used in ``bootstrapping'' are two-dimensional.  Not specifying all four options \verb|-Mx|, \verb|-My|, \verb|-Mz|, \verb|-Lz| \emph{when bootstrapping with} \verb|-boot_from| is an error.

Subsection shows bootstrapping for the \ref{sect:green} does EISMINT-Greenland intercomparison \cite{RitzEISMINT,HuybrechtsEISMINT}.


\subsubsection*{\texttt{-i} file format}
PISM produces CF-1.4 compliant NetCDF\index{PISM!NetCDF file format}\index{NetCDF} files.  The easiest way to learn the output format \emph{and} the \verb|-i| format is to do a simple run and then look at the metadata in the resulting file, like this:
\begin{verbatim}
$ pisms -eisII A -y 10 -o foo.nc
$ ncdump -h foo.nc | less
\end{verbatim}

Note that variables have a \verb|pism_intent|\index{PISM!\texttt{pism\und intent} attribute} attribute.  When that attribute is \verb|diagnostic|, the variable can be deleted from the file without affecting whether PISM can use it as a \verb|-i| input file.  Variables with \verb|pism_intent| = \verb|model_state|, by contrast, must be present for use with \verb|-i|.

Regarding the automatically produced time variable, which has a \verb|units| attribute like \verb|"years since 1-1-1"|, note that CF metadata conventions require using a reference date in the units string of a time (\verb|t|) variable.  PISM completely ignores this reference date.


\subsubsection*{\texttt{-boot\und from} file format}
\label{sec:bootstrapping-format}  Allowed formats for a bootstrapping file are relatively simple to describe. 
\begin{enumerate}
\item The NetCDF dimensions \verb|x| and \verb|y| and corresponding variables must be present and have the meanings of projection X coordinate and projection Y coordinate.
\item All three-dimensional variables (depending on \verb|x,y,z| or \verb|x,y,zb|) will be ignored in bootstrapping.
\item The \verb|standard_name| attribute is used to identify a variable, so the names of variables do not need to match the corresponding variables in a PISM output file.
\item PISM expects all the input fields (NetCDF variables) to be in MKS \emph{or} to have the units specified using the \verb|units| attribute.  PISM uses a library called UDUNITS\index{PISM!uses UDUNITS when reading NetCDF files}\index{UDUNITS} to convert data present in an input file to MKS.   This means that having ice thickness in feet or kilometers, or temperature in Celsius for example, is allowed.
\item Any two-dimensional variable (depending on \verb|x,y|) may be missing.  For those missing variables some heuristic will be applied.  See table \ref{tab:modelhierarchy} for a sketch of the data necessary for bootstrapping, and \verb|src/base/iMbootstrap.cc| for all further details.
\item Surface elevation is ignored if present.  Users with surface elevation and bed elevation data should produce an ice thickness variable, with \verb|standard_name| = \verb|land_ice_thickness| for bootstrapping.  The bed elevation (topography) is read by \verb|standard_name| = \verb|bedrock_altitude|.
\end{enumerate}

\subsubsection*{Initialization sequence}  As described already, there are three ways to start PISM,\begin{itemize}
\item executables \verb|pisms| and \verb|pismv| initialize experiments and verification tests, respectively, from formulas in the source code,
\item \verb|-i| reads a previously-saved PISM model state in NetCDF form, and
\item \verb|-boot_from| reads a NetCDF file and uses heuristics to fill in needed fields.
\end{itemize}
As a consequence of these options, and generally from the complexity of getting a computation started on a parallel computer, we observe that initializing PISM is one of the most error-prone parts of maintaining it.

Thus initialization sequence is also an error-prone part of writing a derived class of \verb|IceModel| to modify PISM's function.  The reader interested in doing so should see method \verb|IceModel::init()| and also view the flow chart in \verb|doc/initialization-sequence.png|.  Note that \verb|init()| is \emph{not} \verb|virtual|.  Derived classes can redefine the several methods which are called by \verb|init()|, which are \verb|virtual|.  The EISMINT-Greenland derived class \verb|IceGRNModel| is an example.


\clearpage
\newpage
\section{Usage}\label{sect:usage}

\subsection{Computational box} \label{subsect:coords} PISM does all simulations in a computational box\index{PISM!computational box} which is rectangular in the PISM coordinates.

The coordinate system has horizontal coordinates $x,y$ and a vertical coordinate $z$.  The $z$ coordinate is measured positive upward from the base of the ice and it is exactly opposite to the vector of gravity.  The surface $z=0$ is the base of the ice, however, and thus is usually not horizontal in the sense of being parallel to the geoid.   The surface $z=0$ is the base of the ice both when the ice is grounded and when the ice is floating.

Bed topography is, of course, allowed.  In fact, when the ice is grounded, the true physical vertical coordinate $z'$, namely the coordinate measure relative to a reference geoid, is given by $z'=z+b(x,y)$ where $b(x,y)$ is the bed topography.  The surface $z'=h(x,y)$ is the surface of the ice.

In the grounded case the equation $h(x,y)=H(x,y)+b(x,y)$ always applies if $H(x,y)$ is the thickness of the ice.  In the floating case, the physical vertical coordinate is $z'=z-(\rho_i/\rho_s) H(x,y)$ where $\rho_i$ is the density of ice and $\rho_s$ the density of sea water.  Again $z=0$ is the base of the ice, which is the surface $z' = -(\rho_i/\rho_s) H(x,y)$.  The surface of the ice is $h(x,y) = (1-\rho_i/\rho_s) H(x,y)$.  All we know about the bed elevations is that they are below the base of the ice when the ice is floating.  That is, the \emph{floatation criterion} $-(\rho_i/\rho_s) H(x,y) > b(x,y)$ applies.

The computational box can extend downward into the bedrock.  As $z=0$ is the base of the ice, the bedrock corresponds to negative $z$ values regardless of the sign of its true (i.e.~$z'$) elevation.

The extent of the computational box, along with its bedrock extension downward, is determined by four numbers \t{Lx}, \t{Ly}, \t{Lz}, and \t{Lbz}.  The first two of these are half-widths and have units of kilometers when set by options or displayed.  The extent of the computational box for the ice is directly controlled by the options \intextoption{Lx}, \intextoption{Ly}, and \intextoption{Lz} as described in Appendix \ref{sect:options}.  In particular, \t{-Lx} and \t{-Ly} options should include values in kilometers while \t{-Lz} should be in meters.  (Option ``\verb|-Lbz|'' is not used, as explained next.)  See Figure \ref{fig:rectilinearbox}.

\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/rectilinearbox}
\caption{PISM's computational box.}
\label{fig:rectilinearbox}
\end{figure}


\subsection{Grid} \label{subsect:grid} The PISM grid\index{PISM!grid} covering the computational box is equally spaced in each of the three dimensions.

FIXME: non-equal spacing in vertical allowed with \verb|-quadZ|; need to document

Because of the bedrock extension, the grid of points is described by four numbers, namely the number of grid points in the $x$ direction, the number in the $y$ direction, the number in the $z$ direction within the ice, and the number in the $z$ direction within the bedrock.  These are specified by options \intextoption{Mx}, \intextoption{My}, \intextoption{Mz}, and \intextoption{Mbz}, respectively, as described in the Runtime options section.  The defaults for these four values are 61, 61, 31, and 1, respectively.  Note that \verb|Mx|, \verb|My|, \verb|Mz|, and \verb|Mbz| all indicate the number of grid \emph{points}.  Therefore the number of grid \emph{spaces} are, respectively, 60, 60, 30, and 0 (zero) in the default case.  Note that the lowest grid point in a column of ice, that is the one at $z=0$, coincides with the highest grid point in the bedrock.  Also \verb|Mbz| must always be at least one.

The distance \t{Lbz} is controlled by specifying the number \verb|Mbz| of grid points in the bedrock, noting that the vertical spacing \t{dz} is the same within the ice and within the bedrock.  To avoid conflicts, the distance \t{Lbz} cannot be set directly by the user.  In particular, $\text{\t{Lbz}}=\text{\t{dz}}\,(\text{\t{Mbz}}-1)$ while $\text{\t{dz}} = \text{\t{Lz}} / (\text{\t{Mz}}-1)$, and so the distance \t{Lbz} into the bedrock is determined by setting \t{Lz}, \t{Mz}, and \t{Mbz}.

If one initializes PISM from a saved model state using \intextoption{i} then the input model state controls the parameters \t{Mx}, \t{My}, \t{Mz}, and \t{Mbz}.  For instance, the command

\verb|$  pisms -eisII A -i foo.nc -y 100|

\noindent should work fine if \verb|foo.nc| was a valid PISM model file, while the command

\verb|$  pisms -eisII A -i foo.nc -Mz 201 -y 100|

\noindent will give a warning that ``\verb|PISM WARNING: ignoring command-line option '-Mz'|.''

Otherwise, one is allowed to specify the grid when PISM is started.  In particular, the user should specify the grid when using \intextoption{boot\und from} or when initializing a simplified geometry experiment or a verification test.  See sections \ref{sect:start} and \ref{sect:boot} for examples and explanation.



\subsection{Regridding}  It is common to want to interpolate a coarse grid model state onto a finer grid or vice versa.  For example, one might want to do the EISMINT II experiment on the default grid, producing output \verb|foo.nc|, but then interpolate both the ice thickness and the temperature onto a finer grid.  The basic idea of ``regridding'' in PISM is that one starts over from the beginning on the finer grid, but one extracts the desired variables stored in the coarse grid file and interpolates these onto the finer grid before proceeding with the actual computation.

The transfer from grid to grid is reasonably general---one can go from coarse to fine or vice versa in each dimension $x,y,z$---but the transfer must always be done by \emph{interpolation} and never \emph{extrapolation}.  (An attempt to do the latter will always produce a PISM error.)

Such ``regridding'' is done using the \intextoption{regrid\und from} and \intextoption{regrid\und vars} commands as in this example:\index{pisms}

\begin{verbatim}
$  pisms -eisII A -Mx 101 -My 101 -Mz 201 -y 1000 \
         -regrid_from foo.nc -regrid_vars HT -o bar.nc
\end{verbatim}
\noindent By specifying regridded variables ``\verb|HT|'', the ice thickness and temperature values from the old grid are interpolated onto the new grid.  Here one doesn't need to regrid the bed elevation, which is set identically zero as part of the EISMINT II experiment A description, nor the ice surface elevation, which is computed as the bed elevation plus the ice thickness at each time step anyway.

A slightly different use of regridding occurs when ``bootstrapping'', as described in section \ref{sect:boot} and illustrated by example in section \ref{sect:green}.

See table \ref{tab:regridvar} for the regriddable variables using \intextoption{regrid\und from}.  Only model state variables are regriddable, while climate and boundary data generally are not explicitly regriddable.  (Bootstrapping, however, allows the same general interpolation as this explicit regrid.)

\begin{table}[ht]
\caption{Regriddable variables.\index{regrid}\index{regrid\und vars}  Use \texttt{-regrid$\underline{\phantom{b}}$vars} with given flag.}\label{tab:regridvar}
\begin{tabular}{@{}llll}\hline
\textbf{Flag} & \textbf{Name in NetCDF file} & \textbf{Description}\\ \hline
\verb|b| & \texttt{topg}       & bed elevation \\
\verb|B| & \texttt{litho\und temp} & temperature in bedrock \\
\verb|e| & \texttt{age}        & age of ice \\
\verb|H| & \texttt{thk}        & thickness \\
\verb|L| & \texttt{bwat}       & effective (notional) thickness of basal melt water \\
\verb|T| & \texttt{temp}       & temperature in ice \\
\hline
\normalsize
\end{tabular}
\end{table}

Here is another example: suppose you have an output of a PISM run on a fairly coarse grid (stored in \verb|foo.nc|) and you want to continue this run on a finer grid. This can be done using \intextoption{regrid\und from} along with \intextoption{boot\und from}:
\begin{verbatim}
$ pismr -boot_from foo.nc -Mx 201 -My 201 -Mz 21 -Mbz 21 -Lz 4000 -quadZ \
        -regrid_from foo.nc -regrid_vars BeT -y 100 -o bar.nc
\end{verbatim}
In this case all the model-state 2D variables present in \verb|foo.nc| will be interpolated onto the new grid during bootstrapping, which happens first, while three-dimensional variables are filled using heuristics mentioned in section \ref{sect:boot}.  Then temperature in bedrock (\verb|B|)\footnote{Assumes that foo.nc has \t{Mbz}$>1$.}, age of the ice (\verb|e|) and ice temperature (\verb|T|) will be interpolated from \verb|foo.nc| onto the new grid during the regridding stage, overriding values set at the bootstrapping stage.  All of this, bootstrapping and regridding, occurs before the first timestep.


\subsection{Adaptive time-stepping} \label{subsect:adapt}\index{PISM!adaptive time stepping scheme} Recall that at each time step the PISM standard output includes flags and a summary of the model state using a few numbers:
\begin{verbatim}
%ybp SIA SSA  # vgatdh Nr  +STEP
S         YEAR:     ivol   iarea    meltf     thick0     temp0
\end{verbatim}
Here we explain what `\verb|Nr|' and `\verb|STEP|' in the flag line mean.

\verb|STEP| is the time step just taken by PISM, in model years.  This time step is determined by a somewhat complicated adaptive mechanism.  Note PISM does each step explicitly when numerically approximating mass conservation in the map-plane.  This, and the modeling of horizontal advection in conservation of energy and age evolution \cite{BBL}, requires an adaptive time-stepping scheme.

If the option \verb|-skip| is used then `\verb|N|' in the flag line will be non-zero.  If \verb|-skip| $M$ then \verb|N| will be at most $M-1$.  The flag \verb|N| will countdown the mass conservation steps, in the case that the adaptive scheme determines that a long temperature/age evolution time step can be taken.  To see an example, do:\index{pismv}

\verb|$  pismv -test G -Mx 141 -My 141 -Mz 51 -skip 4|

Table \ref{tab:adaptiveflag} explains the meaning of the additional one character adaptive-timestepping ``reason'' flag `\verb|r|'.

\begin{table}[ht]
\caption{Meaning of the adaptive time-stepping ``reason'' flag `\texttt{r}' in standard output flag line.}\label{tab:adaptiveflag}
\begin{tabular}{@{}llll}\hline
\textbf{Flag} & \textbf{Active adaptive constraint} \\ \hline
\verb|c| & three-dimensional CFL for temperature/age advection \cite{BBL} \\
\verb|d| & diffusivity for SIA mass conservation \cite{BBL} \\
\verb|e| & end of prescribed run time \\
\verb|f| & \verb|-dt_force| set; generally option \verb|-dt_force|, which overrides \\
 & the adaptive scheme, should not be used  \\
\verb|m| & maximum allowed $\Delta t$ applies; set with \verb|-max_dt| \\
\verb|t| & maximum $\Delta t$ was temporarily set by a derived class \\
\verb|u| & 2D CFL for mass conservation in SSA regions (upwinded; \cite{BBssasliding})\\
\hline
\normalsize
\end{tabular}
\end{table}



\subsection{Signals, to control a running PISM model} \label{subsect:signal} \index{signals} \index{PISM!catches signals -TERM and -USR1}  Ice sheet model runs sometimes take a long time, so the state of a run may need checking.  Sometimes the run needs to be stopped, but with the possibility of restarting.  PISM implements these behaviors using ``signals'' from the POSIX standard, included in Linux and most flavors of Unix.  Table \ref{tab:signals} summarizes how PISM responds to signals.

\newcommand\pid{\textsl{pid}}
\newcommand\same{(\textsl{same})}
\begin{table}[ht]
\caption{Signalling PISM.  \pid~stands for list of all identifiers of the running PISM processes.  The signals are POSIX but \t{pkill} is a Linux extension.}\label{tab:signals}
\begin{tabular}{@{}llll}\hline
\textbf{Command}\phantom{bobbob} & \textbf{Signal}\phantom{bobbob} & \textbf{PISM behavior} \\ \hline
\texttt{kill -KILL} \pid & \texttt{SIGKILL} & terminate with extreme prejudice; PISM  \\
 & & cannot catch it and no state is saved \\
Ctrl-C &  & typically the same for foreground process(es)  \\ \hline
\texttt{kill -TERM} \pid & \texttt{SIGTERM} & end process(es) but PISM will save the last  \\
 &  & model state using \verb|-o| name or default name \\
\texttt{kill} \pid &  & typically the same \\
\texttt{pkill -TERM pismv} &  & convenient form for MPI runs with multiple \\ 
 &  & processes needing signal \\ \hline
\texttt{kill -USR1} \pid & \texttt{SIGUSR1} & allow process(es) to continue but PISM will save  \\
 &  & its model state at current time as ``\texttt{pism-}\textsl{year}\texttt{.nc}'' \\
\texttt{pkill -USR1 pismv} &  & convenient form for MPI runs \\
\hline\normalsize
\end{tabular}
\end{table}

Here is an example.  Suppose we start a long verification run in the background, with standard out redirected into a file:\index{pismv}

\verb|pismv -test G -Mz 101 -y 1e6 -o testGmillion.nc >> log.txt &|

\noindent This run gets a Unix process id (``\verb|pid|''),\index{signals!the pid} and we will need that number, which we assume is ``8920''.  (Get it using \verb|ps| or \verb|pgrep|.)  If we want to observe the run without stopping we send the \verb|USR1| signal:\index{signals!usr1}

\verb|kill -USR1 8920|

\noindent where ``\verb|8920|'' happened to be the \verb|pid| of the running PISM process.  It happens that we caught the run at year 31871.5 or so because a NetCDF file \verb|pism-31871.495239.nc| is produced.  This intermediate state file can be viewed by \verb|ncview pism-31871.495239.nc|.  Note also that in the standard out log file \verb|log.txt| the line

\begin{verbatim}
...
Caught signal SIGUSR1: Writing intermediate file `pism-31871.495239.nc'.
...
\end{verbatim}
\noindent appears around time step (i.e.~\verb|YEAR|) 31900.

Suppose, on the other hand, that the run needs to be stopped.  One may use the interrupt ``\verb|kill -KILL 8920|''\index{signals!kill}\index{killing runs} for this process, which is running in the background.  (Foreground processes can be interrupted by Ctrl-C.)  This brutal method, which a process cannot catch or block, stops the process but does not allow it to save the model state.  Therefore one cannot restart at the same place, nor inspect the model state.  For that ability, use the \verb|TERM|\index{signals!term} signal,

\verb|kill -TERM 8920|

\noindent Then the PISM run is stopped and the lines

\verb|Caught signal SIGTERM: exiting early.|

\verb|...|

\verb|Writing model state to file `testGmillion.nc' ... done|

\noindent appear in the log file \verb|log.txt|.  The \verb|history| global attribute \verb|testGmillion.nc| records the point at which the run was stopped.  One can restart and finish the run by the command (for example)

\begin{verbatim}
$ pismv -test G -i testGmillion.nc -ye 1e6 \
        -o testGmillion_finish.nc >> log_cont.txt &
\end{verbatim}

\smallskip

Finally we consider a multiple process (MPI) run of PISM.  Here each of the processes must be sent the same signal at the same time.  For example, consider the dialog
\begin{quote}
\begin{verbatim}
	$ mpiexec -n 4 pismv -test C -y 100000 -o foo.nc >> log.txt &
	$ ps
	PID TTY          TIME CMD
	6761 pts/0    00:00:00 mpiexec
	6762 pts/0    00:00:00 pismv
	6763 pts/0    00:00:00 pismv
	6764 pts/0    00:00:00 pismv
	6765 pts/0    00:00:00 pismv
	6770 pts/2    00:00:00 ps
	$ kill -TERM 6762 6763 6764 6765
\end{verbatim}
\end{quote}
Here the \verb|kill| command sent the signal to all four of the running PISM processes simultaneously.  It causes all four processes to end, and PISM writes \verb|foo.nc| for possible restart.  Efficiency motivates using the Linux tool \verb|pkill|\index{pkill}, which avoids the need to list process ids:

  \verb|pkill -TERM pismv|

\noindent See \verb|man pkill| and \verb|man pgrep|.



\subsection{Saving snapshots of the model state}
\label{sec:snapshots}  Sometimes you want to check the model state every 1000 years, for example.  One possible solution is to run PISM for a thousand years, have it save all the fields at the end of the run, then restart, run for another thousand, etc.  Note this forces the adaptive time-stepping mechanism to stop \emph{exactly} at multiples of 1000 years, which may be desireable in some cases.

If saving exactly at specified times is not critical, then use of \verb|-save_to| and \verb|-save_at| options is recommended.  For example
\begin{verbatim}
$ pismr -i foo.nc -y 10000 -o output.nc -save_to snapshots.nc \
        -save_at 1e3:1e3:1e4
\end{verbatim}
starts a PISM evolution run, initializing from \verb|foo.nc|, running for
10000 years and saving snapshots to \verb|snapshots.nc| at the first time-step
after years 1000,2000,...,10000.

We use a MATLAB-style range specification, $a:\Delta t:b$, where $a,\Delta t,b$ are in years.  The time-stepping scheme is not affected.  (As a consequence we cannot guarantee producing the exact number of snapshots requested, but this is not a problem if snapshot spacing is much greater than the length of a typical timestep.  One may use \verb|-max_dt| to limit time-steps if needed.)

It is also possible to save snapshots at intervals that are not equally-spaced
by giving the \verb|-save_at| option a comma-separated list. For example,
\begin{verbatim}
$ pismr -i foo.nc -y 10000 -o output.nc -save_to snapshots.nc \
        -save_at 1000,1500,2000,5000
\end{verbatim}
will save snapshots on the first time-step after years 1000,1500,2000 and 5000.
The list given to the \verb|-save_at| option can be at most 200 numbers long.

Another possible use of snapshots is for restarting runs on a batch system which kills jobs.  Suppose that we know that we have a 8 wall-clock hours limit and a 1000 year long run will complete in this time.  We may run PISM with option \verb|-y 1500 -save_at 1000:100:1400|, in which case if the job is killed before completing the 1500 year run, we can restart from near the last multiple of 100 years.  Restarting with option \intextoption{ye} will hit target years.

It is possible to save snapshots to separate files using the
\verb|-split_snapshots| option.  For example, the run above can be changed to
\begin{verbatim}
$ pismr -i foo.nc -y 10000 -o output.nc -save_to snapshots \
        -save_at 1000,1500,2000,5000 -split_snapshots
\end{verbatim}
for this purpose.  This will produce files called \verb|snapshots-|year\verb|.nc|.  This option is generally faster if many snapshots are needed, apparently because of the time necessary to reopen a large file at each snapshot in the \emph{sans} \verb|-split_snapshots| case.

Note that tools like NCO and \verb|ncview| usually behave as desired with wildcards like ``\verb|snapshots-*.nc|''.


\subsection{Positive degree-day model}  \label{subsect:pdd} \index{positive degree day model} \index{PDD (positive degree day model)} \index{PISM!default positive degree day model}  FIXME  By default the accumulation/ablation map in PISM is treated as net surface mass balance.  (We are referring to the variable \verb|acab| in saved model states.)  The mass conservation equation for the ice sheet requires this surface balance, which is in units of meters ice-equivalent per time.

Also, the surface temperature variable in PISM is assumed to be the mean annual surface temperature, and without an additional model or input there is no yearly temperature cycle.

If the input data actually includes the annual snow-fall accumulation then one must \emph{compute} the surface mass balance according to some model of how much of the snow is melted in each model year and according to a yearly temperature cycle.  We call such a model a \emph{positive degree day} model \cite{CalovGreve05}.

The model used by PISM in computing the amount of melting first assumes a sinusoidal temperature cycle over the course of the year, where the difference between the peak of this temperature cycle and its mean (average) is called the ``summer warming.''  The default temperature cycle has a constant amount of summer warming.  This constant is specified by \intextoption{pdd\und summer\und warming}.  Note that the mean temperature is grid-point dependent, as specified by the input surface temperature map (data), so the cycle is different at each map-plane grid location, though the amplitude is the same at each grid point (in this default case).  The peak of the cycle occurs on August 1, which is Julian day 243, but the option \intextoption{pdd\und summer\und peak\und day} can override this.

It is common to add ``white noise'' to the temperature cycle to simulate both the daily temperature cycle and additional variability associated to the vagaries of weather.  More precisely, a normally-distributed, mean zero random temperature increment is added (or subtracted) from the temperature for each day.  These increments are independent over the days of the year, though of course we only have pseudo-randomness \dots, but they are the same over the whole sheet.  Their standard deviation is controlled by \intextoption{pdd\und std\und dev}.

The number of positive degree days, denoted PDD, is computed as the sum of the product of the amount by which this temperature cycle, including the white noise variability, exceeds $0\!\phantom{|}^\circ \text{C}$ times the time (in days) during which it is above zero.  In PISM there are two methods for computing PDD.  The first is the expected value computed by the method described in \cite{CalovGreve05}; this option is chosen by \intextoption{pdd}.  The second is a monte carlo simulation of the white noise itself, chosen by \intextoption{pdd\und rand}.  (If one wants runs with repeatable randomness, use \intextoption{pdd\und repeatable} instead of \verb|-pdd_rand|.)

The PDD is multiplied by a coefficient (set by \intextoption{pdd\und factor\und snow}) to compute the amount of snow melted.  Of this melted snow, a fraction (\intextoption{pdd\und refreeze}) is kept as ice.  This ice, plus all unmelted snow (measured as ice-equivalent) is added to the mass balance unless the PDD exceeds that required to melt all of the snow-fall in the year.  In this latter case, in which there are excess PDD available for melting, the excess PDD is multiplied by a coefficient (\intextoption{pdd\und factor\und ice}) to compute how much ice is melted.  In this latter case, ablation occurs at that location.

The PDD model is applied in section \ref{sect:green} to modeling the Greenland ice sheet.

To directly compare the two methods, try\index{pgrn}

\begin{verbatim}
$ pgrn -boot_from eis_green_smoothed.nc -Mx 83 -My 141 -Mz 201 -Lz 4000 \
       -ocean_kill -y 50 -o green_50yr_pdd.nc
\end{verbatim}
\noindent versus
\begin{verbatim}
$ pgrn -boot_from eis_green_smoothed.nc -Mx 83 -My 141 -Mz 201 -Lz 4000 \
       -ocean_kill -y 50 -o green_50yr_pdd_rand.nc -pdd_rand
\end{verbatim}
\noindent (See section \ref{sect:green} on how to create the file \verb|eis_green_smoothed.nc| from publically available data.  See the same section for the meaning of ``\verb|-boot_from|''.)


\subsection{Floatation criterion and mask} \label{subsect:floatmask}  The most basic decision about ice dynamics made internally by PISM is whether to apply the ``floatation criterion'' to determine whether the ice is floating on the ocean or not.  In an evolution run this decision is made at each time step and the result is stored in the \t{mask}.

The possible values of the \t{mask}\index{mask} are given in Table \ref{tab:maskvals}.  The mask does not by itself determine ice dynamics.  For instance, when ice is floating (either value \verb|MASK_FLOATING| or \verb|MASK_FLOATING_OCEAN0|) the usual choice for ice dynamics is SSA, but the user can choose not to apply that model by leaving off the option \verb|-ssa|.

\begin{table}[ht]
\caption{The PISM mask\index{mask}, in combination with user options, determines the dynamical model.}\label{tab:maskvals} 
\small
\begin{tabular}{@{}llll}\hline
\textbf{Mask value} & \textbf{Meaning}\\ \hline
1=\verb|SHEET| & ice is grounded (and only the SIA is always applied) \\
2=\verb|DRAGGING| & ice is grounded (and the SSA is applied if option \verb|-ssa| is given) \\
3=\verb|FLOATING| & ice is floating (and the SSA is applied if option \verb|-ssa| is given) \\
7=\verb|FLOATING_OCEAN0| & same as \verb|FLOATING|, but the grid point was ice free ocean at  \\
 & initialization of the model by \verb|-boot_from|; ice with this value\\
 & will calve off if option \verb|-ocean_kill| is given.\\
\hline\end{tabular}
\normalsize
\end{table}

Assuming the geometry of the ice evolves (which can be turned off by option \intextoption{no\und mass}), and assuming an ocean exists (which can be turned off by option \intextoption{dry}), then at each time step the mask can change.  Ice which becomes floating is marked as \verb|FLOATING| while ice which becomes grounded is either marked as \verb|SHEET| or \verb|DRAGGING|.  The decision between \verb|SHEET| or \verb|DRAGGING| is made by a vote-by-neighbors scheme in the most general case.  When both \intextoption{ssa} and \intextoption{super} are given all grounded ice is \verb|DRAGGING|, however.


\subsection{Earth deformation models} \label{subsect:beddef} \index{earth deformation} \index{PISM!earth deformation models, using}   FIXME: add this section, which explains use of options
\intextoption{bed\und def\und iso} and \intextoption{bed\und def\und lc}  Based on papers by Lingle and Clark \cite{LingleClark}\index{Lingle, Craig} \index{Clark, J.} and \cite{BLKfastearth}.  Example runs to compare are is
\begin{verbatim}
$ pisms -eisII A -quadZ -y 6000 -o eisIIA_nobd.nc
$ pisms -eisII A -quadZ -bed_def_iso -y 6000 -o eisIIA_bdiso.nc
$ pisms -eisII A -quadZ -bed_def_lc -y 6000 -o eisIIA_bdlc.nc
\end{verbatim}
Also refer to test H.


\subsection{Diagnostic computations}  As a diagnostic example, using the EISMINT II final state computed in section \ref{sect:start}, try\index{pismd}

\verb|pismd -i eisIIA200k.nc -o eisIIA200k_diag.nc|

\noindent The result is a NetCDF file \verb|eisIIA200k_diag.nc| which contains the full three-dimensional velocity field in the scalar NetCDF variables \verb|uvel|, \verb|vvel|, and \verb|wvel|.

The velocity field saved by \verb|pismd| is the one which would be computed at the \emph{next} time step in an evolution run.  That is, if we also run\index{pisms}

\verb|pisms -eisII A -i eisIIA200k.nc -y 0 -o eisIIA200k_plus.nc|

\noindent then the horizontal velocity field computed in this single time step run is the same as that saved in \verb|eisIIA200k_diag.nc|.\footnote{For this example, one can use a NetCDF Operator\index{NCO (NetCDF Operators)} to check that the two saved NetCDF files contain the same vertically-averaged horizontal velocity field; just do \t{ncdiff -v cbar} \dots}

This diagnostic mode is most frequently associated to the modeling of ice shelves and ice streams.  Subsection \ref{sect:ross} describes using \verb|pismd| to model the Ross ice shelf \cite{MacAyealetal}.  Verification tests I and J, section \ref{sect:verif}, are diagnostic calculations using the SSA.

Note that the NetCDF model state saved by PISM at the end of an \emph{evolution} run does not, by default, contain the three-dimensional velocity field.  Instead, it contains just the variables which are needed to restart the run, especially the ice geometry and temperature field.  One can also force PISM to save the full velocity field at the end of a time-stepping run using the option \intextoption{f3d}.  The diagnostic executable \verb|pismd| saves the full three-dimensional velocity field by default.  Either way, saving the full velocity field roughly doubles the size of the saved NetCDF file.


\subsection{Schoof's plastic till free boundary problem for ice streams}   SSA\index{SSA (shallow shelf approximation)} equations with additional basal resistance are used in PISM to describe sliding, grounded ice.  The SSA version of the balance of momentum equations with linearly-viscous till are solved as a fixed-boundary problem (at a particular time step), and thus the locations and extent of ice streams must be determined by some other criterion.  By contrast, for the SSA with plastic till the locations of ice streams is determined as part of the free boundary problem.  We believe that the plastic till SSA of Schoof \cite{SchoofStream} should be regarded as the best currently implementable ``sliding law'' for the SIA \cite{BBssasliding}.\index{SIA (shallow ice approximation)!sliding law}

Schoof's model \cite{SchoofStream} describes emergent ice streams within a larger ice sheet and ice shelf system.  It explains the existence of ice streams by a combination of the plastic failure of the till and the SSA approximation of the balance of momentum.  PISM implements Schoof's SSA-based model among others.  The user gives the options \verb|-ssa -plastic| to turn it on.  All grounded points are immediately marked as SSA (i.e.~as \verb|DRAGGING|).  At these points a yield stress is computed from the amount of stored basal water, a thermodynamic quantity, and from a (generally) spatially-varying till strength.  See \cite{BBssasliding} and the description of option \intextoption{plastic} in Appendix \ref{sect:options} for a more detailed description of the yield stress computation.

Test I in the verification suite\index{verification tests} is an instance of the exact solution to the Schoof model.

In examples/pst

FIXME:  \intextoption{topg\und to\und till}



\subsection{Visualizing the climate inputs, without ice dynamics} FIXME: pcctest


\clearpage\newpage
\section{Verification}\label{sect:verif}

\bigskip
\begin{quote}  Two types of errors may be distinguished: modeling errors and numerical errors.  modeling errors arise from not solving the right equations.  Numerical errors result from not solving the equations right.  The assessment of modeling errors is \emph{validation}, whereas the assessment of numerical errors is called \emph{verification} \dots  Validation makes sense only after verification, otherwise agreement between measured and computed results may well be fortuitous.
\end{quote}\index{validation versus verification}
\hfill P.~Wesseling, (2001)  \emph{Principles of Computational Fluid Dynamics}, pp.~560--561 \cite{Wesseling}
\bigskip

\subsubsection*{Ideas}  Verification is a crucial task for a code as complicated as PISM.\index{PISM!verification of}  It is the exclusively mathematical and numerical task of checking that the predictions of the numerical code are close to the predictions of the continuum model (the one which the numerical code claims to approximate).  In verification there is no comparison between model output and observations of nature.  Instead, one compares exact solutions of the continuum model, in circumstance in which they are available, to the numerical approximations of those solutions.

See \cite{BLKCB} and \cite{BBL} for discussion of verification issues for the isothermal and thermomechanically coupled shallow ice approximation (SIA), respectively, and for exact solutions to these models.  See \cite{SchoofStream} and \cite{BBssasliding} for an exact solution to the SSA equations for ice streams using a plastic till assumption.  Reference \cite{Roache} gives a broad discussion of verification (and validation) in computational fluid dynamics.

In PISM there is a separate executable \verb|pismv| which is used for verification.  The source codes which are verified by \verb|pismv| are, however, exactly the same, in exactly the same source files, as is run by the non-verification executables \verb|pismr|, \verb|pisms|, \verb|pgrn|, etc.  (In technical terms, \verb|pismv| runs a derived class of the base class \verb|IceModel|\index{IceModel C++ class!derived class for verification}.  All PISM executables run \verb|IceModel|, but derived classes add bits of code, in this case the exact solutions.)

\begin{table}[ht]
\caption{Exact solutions for verification.}\label{tab:tests}
\small
\begin{tabular}{@{}llll}\hline
\textbf{Test} & \textbf{Continuum model tested} & \textbf{Comments} & \textbf{Reference} \\ \hline
A & isothermal SIA, steady, &  & \cite{BLKCB} \\
 & flat bed, constant accumulation &  &  \\
B & isothermal SIA, flat bed, zero accum & similarity soln & \cite{BLKCB,Halfar83} \\
C & isothermal SIA, flat bed, growing accum & similarity soln & \cite{BLKCB} \\
D & isothermal SIA, flat bed, oscillating accum & compensatory accum & \cite{BLKCB} \\
E & isothermal SIA; as A &  compensatory accum & \cite{BLKCB} \\
 & but with sliding in a sector &  &  \\
F & thermomechanically coupled SIA (mass &  compensatory accum & \cite{BB,BBL} \\
 & and energy cons.), steady, flat bed & and comp~heating &  \\
G & thermomechanically coupled SIA; as F  & ditto & \cite{BB,BBL} \\
 & but with oscillating accumulation &  &  \\
H & bed deformation coupled with isothermal SIA & joined similarity & \cite{BLKfastearth} \\
I & stream velocity computation using SSA (plastic till) &  & \cite{SchoofStream,BBssasliding} \\
J & shelf velocity computation using SSA  &  & [IN PREP] \\
K & pure conduction in ice and bedrock & & \cite{BuelerTestK} \\
L & isothermal SIA, steady, non-flat bed & numerical ODE soln & [IN PREP] \\
M & velocity solution for circular, constant-thickness  & numerical ODE soln & [NOT READY] \\
 & ice shelf with grounding line and calving front &  &  \\
\hline
\normalsize
\end{tabular}
\end{table}

\begin{table}[ht]
\caption{Canonical PISM\index{pismv!options to run verification tests}\index{verification tests} verification runs using the exact solutions listed in table \ref{tab:tests}.}\label{tab:tests_exec}
\small
\begin{tabular}{@{}llll}\hline
\textbf{Test} & \textbf{Example invocation}  \\ \hline
A & \verb|pismv -test A -Mx 61 -My 61 -Mz 11 -y 25000| \\
B & \verb|pismv -test B -Mx 61 -My 61 -Mz 11 -ys 422.45 -y 25000|  \\
C & \verb|pismv -test C -Mx 61 -My 61 -Mz 11 -y 15208.0|  \\
D & \verb|pismv -test D -Mx 61 -My 61 -Mz 11 -y 25000|  \\
E & \verb|pismv -test E -Mx 61 -My 61 -Mz 11 -y 25000|  \\
F & \verb|pismv -test F -Mx 61 -My 61 -Mz 61 -y 25000|  \\
G & \verb|pismv -test G -Mx 61 -My 61 -Mz 61 -y 25000|  \\
H & \verb|pismv -test H -Mx 61 -My 61 -Mz 11 -y 40034 -bed_def_iso| \\
I & \verb|pismv -test I -Mx 500 -My 5 -ssa_rtol 1e-6 -ksp_rtol 1e-11| \\
J & \verb|pismv -test J -Mx 60 -My 60 -Mz 11 -ksp_rtol 1e-12| \\
K & \verb|pismv -test K -Mx 6 -My 6 -Mz 401 -Mbz 101 -y 130000| \\
L & \verb|pismv -test L -Mx 61 -My 61 -Mz 31 -y 25000| \\
M & \emph{not ready} \\
\hline
\normalsize
\end{tabular}
\end{table}

Table \ref{tab:tests} summarizes the many exact solutions currently available in PISM.  Most of these exact solutions are solutions of \emph{free boundary problems} for partial differential equations; only Tests A, E, J, K are fixed boundary value problems.  Table \ref{tab:tests_exec} shows how to run each of them on minimally-refined grids (for relatively quick execution time).


\subsubsection*{Refinement}  To meaningfully verify a numerical code one must go down a grid refinement path and measure numerical error for each grid \cite{Roache}.  By ``a refinement path''\index{refinement path!definition} we mean the specification of a sequence of grid cell sizes which decrease toward the refinement limit of zero size.  For example, in the two spatial and one time dimension case this means a sequence of triples $(\Delta x,\Delta y,\Delta t)$ which decrease toward the (unreachable!) limit $(0,0,0)$.  By ``measuring the error for each grid'' we will mean computing a norm (or norms) of the difference between the numerical solution and the exact solution.   Concretely, we usually compute both the maximum and average numerical error of the measured quantity over the whole grid.

The goal is not to see that the error is zero at any stage on the refinement path, or even that the error is small in a predetermined absolute sense (generally).  Rather the goals are \begin{itemize}
\item to see that the error is decreasing,
\item to measure the rate at which it is decreasing,
\item and to develop a realistic sense of the magnitude of numerical error, compared to other errors, in a realistic ice sheet model run.
\end{itemize}
Knowing the error decay rate may even give a prediction of how fine a grid is necessary to achieve a desired smallness for the numerical error.  ``Other errors'' include the error from using the wrong (e.g.~over-simplified or incorrectly-parameterized) continuum model, and also observational or pre-processing errors present in the data used in the realistic run.

For an example of a refinement path, consider the runs\index{refinement path!example}\index{pismv}
\begin{quote}\small
\begin{verbatim}
pismv -test B -ys 422.45 -y 25000 -Mx 31 -My 31 -Mz 11
pismv -test B -ys 422.45 -y 25000 -Mx 61 -My 61 -Mz 11
pismv -test B -ys 422.45 -y 25000 -Mx 121 -My 121 -Mz 11
pismv -test B -ys 422.45 -y 25000 -Mx 241 -My 241 -Mz 11
\end{verbatim}
\normalsize\end{quote}
Here we seek to evaluate the isothermal shallow ice approximation components of PISM.  The exact solution is the Halfar similarity solution \cite{Halfar83}, with zero accumulation.  One specifies the number of grid points when running PISM, but this is equivalent to specifying the grid cell sizes if the overall dimensions of the computational box is fixed; see subsection \ref{subsect:coords}.  The refinement path is the sequence of triples $(\Delta x,\Delta y,\Delta t)$ with $\Delta x = \Delta y = 80,40,20,10$ and where $\Delta t$ is determined adaptively by a stability criterion (see subsection \ref{subsect:adapt}).  Note that the vertical grid spacing $\Delta z$ is fixed because this test is isothermal.  The error should not depende on changing $\Delta z$.  The above four runs produce (parts of) figures 7, 8, 9, and 10 of \cite{BLKCB}.  We see there that the isothermal mass conservation scheme does a reasonable job of approximating the evolving surface.  Future improvements in the numerical scheme may make the error decrease faster or be smaller.

For thermocoupled tests one refines in three dimensions.  For example, the runs\index{refinement path!example}
\begin{quote}\small
\begin{verbatim}
pismv -test G -max_dt 10.0 -y 25000 -Mx 61 -My 61 -Mz 61
pismv -test G -max_dt 10.0 -y 25000 -Mx 91 -My 91 -Mz 91
pismv -test G -max_dt 10.0 -y 25000 -Mx 121 -My 121 -Mz 121
pismv -test G -max_dt 10.0 -y 25000 -Mx 181 -My 181 -Mz 181
pismv -test G -max_dt 10.0 -y 25000 -Mx 241 -My 241 -Mz 241
pismv -test G -max_dt 10.0 -y 25000 -Mx 361 -My 361 -Mz 361
\end{verbatim}
\normalsize\end{quote}
produced figures 13, 14, and 15 of \cite{BBL}.  (The last two runs, especially, require a supercomputer!  The $361\times 361\times 361$ run involves more than $100$ million unknowns, updated at each of millions of time steps.  Appropriate use \verb|-skip 10| and \verb|-quadZ| accelerates such runs.  See subsection \ref{sect:usage}.)

\subsubsection*{Sample verification results}  Figures \ref{fig:thickerrsG} through \ref{fig:temperrsK} show a sampling of the results of verifying PISM using the tests described above.\index{PISM!verification results and reporting}  These figures were produced more-or-less automatically using Python scripts \verb|test/verifynow.py|\index{verifynow.py} and \verb|test/vnreport.py|\index{vnreport.py}.  See appendix \ref{sect:scripts}.

It must be pointed out that, to the experienced eye, these figures \emph{do not} show outstanding rates of convergence.  For the errors in test G, a partial explanation comes in the discussion of margin shape in \cite{BLKCB}, and also from presumably imperfect numerical analysis choices.  For the errors in test I, a partial explanation is low degree of smoothness present for solutions in the Sobolev space used in \cite{SchoofStream}, but again perhaps from imperfect numerical choices.  We believe, however, that the free boundary nature of the continuum problems addressed by tests G and I (and most other tests, not shown) is the underlying difficulty.  Test K, as a fixed boundary problem, does a little better \cite{BuelerTestK}.

\begin{comment}
SHOWING THIS CLEARLY WITHOUT LOG-LOG PLOT (A PYLAB PROBLEM) OR WITHOUT INVOKING $\eta=H^{8/3}$ BECAME A PROBLEM:
\begin{figure}[ht]
\includegraphics[width=4.8in,keepaspectratio=true]{figs/thickerrs_B}
\caption{Numerical thickness errors in test B.  Vertical axis is in meters. ``maxH error'' is the maximum thickness error anywhere on the grid, ``avH error'' is the average thickness error anywhere on the grid, and ``centerH error'' is the error at the center of the ice sheet.  See \cite{BLKCB} for discussion.}
\label{fig:thickerrsB}
\end{figure}
\end{comment}

\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/thickerrs_G}
\caption{Numerical thickness errors in test G.  Vertical axis is in meters. ``maxH error'' is the maximum thickness error anywhere on the grid, ``avH error'' is the average thickness error anywhere on the grid.  See \cite{BBL} and \cite{BLKCB}n.}
\label{fig:thickerrsG}
\end{figure}

\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/temperrs_G}
\caption{Numerical temperature errors in test G.  Vertical axis in Kelvin.  ``maxT'' and ``basemaxT'' errors are maximum over all points within the ice and over all the basal points, respectively.  Similarly for ``avT'' and ``baseavT'', but average errors.  See \cite{BBL}.}
\label{fig:temperrsG}
\end{figure}

\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/surfvelerrs_G}
\caption{Numerical errors in computed surface velocities in test G.  Vertical axis is in meters per year.  ``avUvec'' is the average error in the surface value of the horizontal velocity, a two-vector, while ``avW'' is the error in the surface value of the vertical velocity.}
\label{fig:surfvelerrsG}
\end{figure}

\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/velerrs_I}
\caption{Numerical errors in horizontal velocities in test I, an ice stream.  Vertical axis is in meters per year.  ``maxu'' and ``avu'' are errors in scalar velocity (because of symmetries in test I).  See \cite{SchoofStream,BBssasliding}.}
\label{fig:velerrsI}
\end{figure}

\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/temperrs_K}
\caption{Numerical temperature errors in test K, which tests the thermal bedrock model.  Vertical axis in Kelvin.  ``maxT'' and ``avT'' are errors within the ice, while ``maxTb'' and ``avTb'' are in the bedrock.  See \cite{BuelerTestK} for a discussion.}
\label{fig:temperrsK}
\end{figure}


\clearpage\newpage
\section{Simplified geometry experiments}\label{sect:simp}

\subsection{Historical note}  There have been three stages of ice sheet model intercomparisons based on simplified geometry experiments since the early 1990s \cite{BuelerSpray}.\index{EISMINT!defined}

EISMINT I \cite[ European Ice Sheet Modeling INiTiative]{EISMINT96}\footnote{See \texttt{http://homepages.vub.ac.be/\%7Ephuybrec/eismint.html}.} was the first of these and involved only the isothermal shallow ice approximation (SIA).  Both fixed margin and moving margin experiments were performed in EISMINT I, and various conclusions were drawn about the several numerical schemes used in the intercomparison.  EISMINT I is superceded, however, by verification using the full variety of known exact solutions to the isothermal SIA, as shown in \cite{BLKCB}.  The ``rediscovery'', since EISMINT I, of the Halfar similarity solution with zero accumulation \cite{Halfar83} is a particular reason why good performance on the moving margin experiment in EISMINT I is, roughly speaking, irrelevant.  For this reason there has been no attempt to support the EISMINT I experiments in PISM, although it would be easy derived class to write.

EISMINT II \cite{EISMINT00} pointed out interesting and surprising properties of the thermocoupled SIA.  References \cite{BBL,Hindmarsh04,Hindmarsh06,PayneBaldwin,SaitoEISMINT} each interpret the EISMINT II experiments and/or describe attempts to add more complete physical models to ``fix'' the (perceived and real) shortfalls of ice sheet model behavior on EISMINT II experiments.  PISM has built-in support for all of the published and unpublished EISMINT II experiments; these are described in the next subsection.

The ISMIP (Ice Sheet Model Intercomparison Project)\footnote{See \texttt{http://homepages.vub.ac.be/\%7Ephuybrec/ismip.html}.}\index{ISMIP!defined} round of intercomparisons is still ongoing at this time (2009).  There are two components of ISMIP substantially completed, namely HOM = Higher Order Models \cite{HOMtcd,HOMelmer} and HEINO = Heinrich Event INtercOmparison \cite{GreveTakahamaCalov}.  Of these, PISM participated in HEINO, but this ability is unmaintained.   We believe\index{ISMIP!interpretation of HEINO results} the continuum problem described by HEINO is not easily approximate-able because of a (large) discontinuous jump in the basal velocity field.  The continuum problem predicts infinite vertical velocity \cite[Appendix B]{BBssasliding}  The same phenomenon occurs in the EISMINT II experiment H continuum problem.  Details of the numerical schemes and their results are irrelevant if the continuum model makes such a prediction.  In essence, PISM offers the physical continuum model described in \cite{BBssasliding}, an SIA/SSA hybrid, as an alternative to the continuum model used in ISMIP-HEINO.

There is no current plan to support ISMIP-HOM, but comparison of shallow PISM results to exact Stokes solutions is a goal for PISM evaluation.

A third ISMIP part is the Marine Ice Sheet Model Intercomparison Project (MISMIP)\index{ISMIP!MISMIP}.  It is supported in PISM, as described in subsection \ref{subsect:MISMIP}.


\subsection{EISMINT II in PISM}\label{subsect:EISMINTII}  There are seven experiments described in the published EISMINT II writeup \cite{EISMINT00}.\index{EISMINT}  They are labeled A, B, C, D, F, G, and H.  As specified in the writeup, the common features of all of these experiments are:\begin{itemize}
\item runs are of 200,000 years, with no prescribed time step;
\item runs are on a prescribed $61\times 61$ horizontal grid;
\item the boundary conditions always have angular symmetry around the center of the grid;
\item the bed is flat and does not move (there are no isostasy effects);
\item the temperature in the bedrock is not modeled;
\item only shallow ice approximation physics is included;
\item the change in the temperature of ice is described by the shallow approximation of the conservation of energy \cite{Fowler};
\item thermomechanical coupling is included, both because of the temperature dependence of the softness of the ice, \emph{and} through the strain-heating (dissipation-heating) term in the conservation of energy equation;
\item the ice is \emph{cold} and not \emph{polythermal} \cite{Greve}; and finally
\item though basal melt rates may be computed diagnostically, they do not affect the evolution of the ice sheet.
\end{itemize}
The experiments differ from each other in their various combinations of surface temperature and mass balance parameterizations.  Also, experiments H and G involve basal sliding, under the dangerous SIA sliding rubric \cite[Appendix B]{BBssasliding}, while the others don't.  Four experiments start with zero ice (A,F,G,H), while the other experiments (B,C,D) start from the final state of experiment A.

In addition to the seven experiments published in \cite{EISMINT00}, there were an additional five experiments described in the EISMINT II intercomparison description 
\cite{EISIIdescribe}, labeled E, I, J, K, and L.\index{EISMINT!unpublished additional EISMINT II experiments}  These experiments share most features, itemized above, but with the following differences.  Experiment E is the same as experiment A except that the peak of the accumulation, and also the low point of the surface temperature, are shifted by 100 km in both $x$ and $y$ directions; also experiment E starts with the final state of experiment A.  Experiments I and J are similar to experiment A but with non-flat topography.  Experiments K and L are similar to experiment C but with non-flat topography.  See table \ref{tab:eisII} for how to run these experiments.

The vertical grid is not specified in the EISMINT II writeup.  It seems that good simulation of the complex thermomechanically coupled conditions near the base of the ice requires relatively fine resolution there.  One option in PISM is an equally-spaced grid, in which case we recommend the use of about 200 vertical levels.  With a quadratically spaced unequal grid one can use far fewer levels.  Reasonable experiment A runs, with basal layers of thickness 25 m or less, are:

\verb|pisms -eisII A -Mx 61 -My 61 -Mz 201 -skip 5 -y 2e5 -o eisIIA_equal.nc|

\verb|pisms -eisII A -Mx 61 -My 61 -Mz 61 -quadZ -skip 5 -y 2e5 -o eisIIA_quadZ.nc|

\noindent The latter run is faster for memory reasons.  These SIA-only simulations parallelize well, and we see speedups up to at least 30 processors for the standard $61\times 61$ horizontal grid.

Table \ref{tab:eisII} shows how all EISMINT II experiments are done in PISM.  Experiments below the horizontal line in Table \ref{tab:eisII} are only documented in \cite{EISIIdescribe}.

\begin{table}[ht]
\caption{Running the EISMINT II experiments in PISM.\index{PISM!running the EISMINT II experiments in}  Replace \t{-Mz 201} with \t{-Mz 61 -quadZ} for unequal vertical spacing.  Use \t{-skip 5} for significant speedup.}\label{tab:eisII}
\small
\begin{tabular}{@{}llll}\hline
\textbf{Command: ``\t{pisms}'' $+$} & \textbf{Relation to experiment A} \\ \hline
\verb|-eisII A -Mx 61 -My 61 -Mz 201 -y 200000 -o eisIIA.nc| & \\
\verb|-eisII B -i eisIIA.nc -y 2e5 -o eisIIB.nc| & warmer \\
\verb|-eisII C -i eisIIA.nc -y 2e5 -o eisIIC.nc| & less snow (lower accumulation)\\
\verb|-eisII D -i eisIIA.nc -y 2e5 -o eisIID.nc| & smaller area of accumulation \\
\verb|-eisII F -Mx 61 -My 61 -Mz 201 -y 2e5 -o eisIIF.nc| & colder; famous spokes \cite{BBL} \\
\verb|-eisII G -Mx 61 -My 61 -Mz 201 -y 2e5 -o eisIIG.nc| & sliding (regardless of temperature) \\
\verb|-eisII H -Mx 61 -My 61 -Mz 201 -y 2e5 -o eisIIH.nc| & melt-temperature activated sliding \\ \hline
\verb|-eisII E -i eisIIA.nc -y 2e5 -o eisIIE.nc| & shifted climate maps \\
\verb|-eisII I -Mx 61 -My 61 -Mz 201 -y 2e5 -o eisIII.nc| & trough topography \\
\verb|-eisII J -i eisIII.nc -y 2e5 -o eisIIJ.nc| & trough topography and less snow \\
\verb|-eisII K -Mx 61 -My 61 -Mz 201 -y 2e5 -o eisIIK.nc| & mound topography \\
\verb|-eisII L -i eisIIK.nc -y 2e5 -o eisIIL.nc| & mound topography and less snow \\
\hline\normalsize
\end{tabular}\end{table}

The EISMINT II experiments can be run with various modifications of the default settings.  Of course the grid can be refined.  For instance, a twice as fine grid in the horizontal is ``\t{-Mx 121 -My 121}''.  Table \ref{tab:eisIIoptions} lists some optional settings which are particular to the EISMINT II experiments.

\begin{table}[ht]
\caption{Changing the default settings for EISMINT II.\index{PISM!special options for EISMINT II experiments}}\label{tab:eisIIoptions}
\small
\begin{tabular}{@{}llll}\hline
\textbf{Option} & \textbf{Default values [expers]} & \textbf{Units} & \textbf{Meaning} \\ \hline
\verb|-Mmax| & 0.5 [ABDEFGHIK], 0.25 [CJL] & m$/$a & max value of accumulation rate \\
\verb|-Rel| & 450 [ABEFGHIK], 425 [CDJL] & km & radial distance to equilibrium line \\
\verb|-Sb| & $10^{-2}$ [\emph{all}] & (m/a)/km & radial gradient of accumulation rate \\
\verb|-ST| & $1.67 \times 10^{-2}$ [\emph{all}] & K/km & radial gradient of surface temperature\\
\verb|-Tmin| & 238.15 [ACDEGHIJKL], & K & max of surface temperature \\
 & 243.15[B], 223.15[F] & & \\
\verb|-track_Hmelt| &  &  & compute effective thickness of basal melt \\
 &  &  & water (override default for EISMINT II) \\
\hline\normalsize
\end{tabular}\end{table}

Note that in PISM the height \verb|Lz| of the computational box is fixed at the beginning of the run.  On the other hand, changing the boundary conditions of the flow, as for instance by setting option \verb|-Mmax| to a larger than default value (see table \ref{tab:eisIIoptions}), may cause the ice sheet to thicken above the \verb|Lz| height.  If the ice grows above the height of the computational box then a ``\verb|Vertical grid exceeded!|'' or ``\verb|thickness overflow in SIA velocity: ks>Mz!|'' error occurs.  This can be fixed by restarting with a larger value for option \verb|-Lz|.  (Automatic rescaling of, or expansion of, the vertical grid is appropriate, but not yet implemented.)



\subsection{MISMIP in PISM}\label{subsect:MISMIP}  This intercomparison addresses grounding line dynamics by considering an idealized one-dimensional stream-shelf system.  The intercomparison process is described at the website

\centerline{\url{http://homepages.ulb.ac.be/~fpattyn/mismip/}}

\noindent Find a full text description there.  These references are essential reading for understanding MISMIP results generally, and for appreciating many of the comments in this subsection.

PISM's version of MISMIP includes an attached ice shelf even though modeling the shelf is theoretically unnecessary in the MISMIP flow line case.  The analysis in \cite{SchoofMarine1} shows that the only effect of an ice shelf, in the flow line case, is to transfer the force imbalance at the calving front directly to the ice column at the grounding line.  But this analysis does not apply to ice shelves with two horizontal dimensions, of course.  Real ice shelves have ``buttressing'' and ``side drag'' and other forces not present in flow line circumstances.  See the Ross ice shelf example in section \ref{sect:ross}, for example.

We use the usual PISM ice shelf model, with two horizontal dimensions, to do MISMIP.  This intercomparison therefore looks at the grounding line dynamics results from the usual PISM code, though in a highly symmetric case without side drag.

Because PISM is a model with two horizontal dimensions, we must adapt it to do a flow line problem.  The flow direction for MISMIP is arbitrarily taken to be ``$x$''.  We periodize the cross-flow direction ``$y$'', and use the minimum number of points in this direction which maintains function.  This number turns out to be ``\verb|-My 3|''; fewer points than this in the cross-flow direction confuses the finite difference scheme.

PISM has two applicable ice dynamics models corresponding to the \verb|-model 1| and \verb|-model 2| options in Table \ref{tab:MISMIPoptions}.  Model 1 is a pure SSA model.  It is ``category 2'' in the MISMIP classification.  Model 2 combines SIA and SSA velocities as described in \cite{BBssasliding}, and is ``category 3'' because it resolves ``vertical'' shear (i.e.~using SIA flow).

There are many runs for a complete MISMIP intercomparison submission.  There are $62$ runs for each model and grid choice, and there are two models and three (suggested) grid choices, so a full suite is $6 \times 62 = 372$ runs.  The finest grid runs account for all the compute time, however.  ``Grid mode 2'' in the MISMIP description is 1500 grid spaces in the flow line direction, a very fine grid which imposes severe time-step restrictions on the explicit methods in PISM.  For the PISM MISMIP submission in Sept.~2008 we chose to only submit runs for a grid with 150 (``grid mode 1'') and 600 (``grid mode 3'') grid spaces in the flow line direction.  This was still 248 runs to submit, with 3 files each for a total of 744 text files.
 
\begin{table}[ht]
\caption{Special MISMIP run options in PISM.  Below the line are special interpretations of standard PISM options (Appendix \ref{sect:options}).\index{PISM!special options for MISMIP experiments}}\label{tab:MISMIPoptions}
\small
\begin{tabular}{@{}lll}\hline
\textbf{Option} & \textbf{Default} & \textbf{Meaning} \\ \hline
\verb|-extras| &  & if this flag is set then, once steady state is reached, surface \\
               &  & and bed elevation are written to an extra file with name \\
               &  & ending ``\verb|_extras|''; script \verb|figsMISMIP.py| reads them \\
\verb|-initials| & \verb|ABC| & initials to prepend to ASCII output file names \\
\verb|-initialthk| & 10.0 & initial thickness (m) at start of run \\
\verb|-mismip| & \verb|1a| & experiment number followed by sliding flag; allowed values \\
               &  & are \verb|1a,1b,2a,2b,3a,3b| \\
\verb|-model| & 1 & model 1 is SSA only and model 2 combines SIA and SSA  \\
              &   & velocities; see text \\
\verb|-no_shelf_drag| &  & flag to turn off small drag on shelves \\
\verb|-steady_atol| & \verb|1.0e-4| & m/a; tolerance for steady state; criterion is \\
                    & & $\|dH/dt\|_\infty <$(\verb|steady_atol| value) \\
\verb|-step| & 1 & allowed values are $\{1,\dots,9\}$ for experiments 1 and 2, $\{1,\dots,13\}$ for \\
             &  & exper.~3a, and $\{1,\dots,15\}$ for exper.~3b; note typo in table 6 in  \\
             &  & \verb|mismip_4.pdf|: ``step 15'' skipped \\
\verb|-try_calving| &  & flag to turn on experimental calving law which keeps  \\
                    &  & calving front thickness in range $[100\text{ m},200\text{ m}]$ \\
\hline
\verb|-Mx| &  & this option gets additional interpretation: \verb|-Mx 151| makes grid \\
           &  & mode 1 so output files have ``\verb|_M1_|''; \verb|-Mx 1501| is grid mode 2 \\
           &  & (``\verb|_M2_|''); any other value is grid mode 3 (``\verb|_M3_|'') \\
\verb|-shelves_drag_too| &  & using this option has no effect because shelf drag is on \\
                         &  & by default in MISMIP; see \verb|-no_shelf_drag| to turn off  \\
\hline\normalsize
\end{tabular}\end{table}

To do an actual MISMIP run, one uses \verb|pisms -mismip| with additional options.  See Table \ref{tab:MISMIPoptions}.  A first run is:

\verb|$ cd examples/mismip/|  \hfill \scriptsize(directory where some MISMIP-related scripts are)\normalsize

\verb|$ pisms -mismip 1a -model 1 -step 1 -My 3 -Mz 15 -Mx 151|

\noindent This will produce ASCII files \verb|ABC1_1a_M1_A1_t|, \verb|ABC1_1a_M1_A1_ss|, and \verb|ABC1_1a_M1_A1_f|, as well as a standard NetCDF output file \verb|ABC1_1a_M1_A1.nc|, in about 3 minutes.  Using a few processors speeds things up a little, and a little extra output is nice, so re-doing it:

\verb|$ mpiexec -n 4 pisms -model 1 -mismip 1a -step 1 -My 3 -Mz 15 -Mx 151 -extras|

\noindent This run takes about 2 minutes on an 8 core machine.  In addition to the same files as before, now we get an additional ASCII file \verb|ABC1_1a_M1_A1_extras|.  The \verb|_ss| file with thickness and the \verb|_extras| file with bed and surface elevation allow us to produce a figure showing the profile for the final steady state, Figure \ref{fig:MISMIPmodel1exper1aM1A1}:

\verb|$ ./figsMISMIP.py -p ABC1_1a_M1_A1 --extras|

\noindent The script \verb|makefigs.sh| will apply \verb|figsMISMIP.py| to each MISMIP output in the current directory.

\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/profile_EBU1_1a_M1_A1}
\caption{A marine ice sheet profile in the MISMIP intercomparison; PISM model 1, experiment 1a, grid mode 1, step 1.}
\label{fig:MISMIPmodel1exper1aM1A1}
\end{figure}

MISMIP runs are done in sequence using the result of a previous run but with a step change in ice hardness.  That is, you initialize as usual in PISM from a saved \verb|.nc| file.  The next run is

\verb|$ mpiexec -n 4 pisms -model 1 -mismip 1a -extras -step 2 -i ABC1_1a_M1_A1.nc|

\noindent The result is \verb|ABC1_1a_M1_A2_t|, etc.

Running \verb|pisms -mismip ...| with options as shown here is practical for a few examples.  The script \verb|mismip.sh| automates the process for the hundreds of runs in the intercomparison.  Setting variables \verb|MODELRANGE| and \verb|GRIDRANGE| at the top of the file will mostly configure what you want.  Do ``\verb|./mismip.sh 4 D|'', or similar, to see what calls will happen \emph{before} actually starting them; ``\verb|D|'' stands for ``debug''.  The script \verb|mismip.sh| also illustrates how to reverse the order of steps in experiments 2a and 2b.

For significantly finer grids than mode 1, it becomes more critical to set the tolerance parameters for the SSA velocity calculation.  Apparently adding option \verb|-ksp_rtol 1.0e-7| is effective.

The implementation of MISMIP in PISM conforms fairly closely to the intercomparison description.  However, that document specifies
\begin{quotation}
\dots we require that the rate of change of grounding line position be $0.1$ m/a or less, while the rate of change of ice thickness at each grid point at which ice thickness is defined must be less than $10^{-4}$ m/a \dots
\end{quotation}
as a standard for ``steady state''.  Because the grounding line undergoes only discrete jumps on the grid, because it shows great stability, and because in two horizontal dimensions there is no well-defined ``rate of change of grounding line position'' which would be generally implementable in PISM, we do not check the grounding line movement criterion.  Steady state is achieved if the ice thickness criterion holds.  However, we report enough information, in the required ASCII files with names ending in \verb|_t|, to compute a grounding line rate.

Also, two physical parameters regarding PISM's ice shelf model need comment.  First, we make the base of the ice shelves have very small resistance, using $10^{-4}$ times the linear drag typical of a Siple coast ice stream \cite{HulbeMacAyeal}, because this seems to have the effect of stabilizing the ice shelf.  Second, there is no direct implementation of the calving front force imbalance associated to the calving front.  Instead, an ice shelf extension of strength equivalent to a $5$ m ice shelf is added at points which have zero thickness ice.


\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/SM_1a_A1}
\caption{Analytical profile for steady state of experiment 1a, grid mode 1, step 1, from theory in \cite{SchoofMarine1}.  This is a boundary layer asymptotic matching result, but not the exact solution to the equations solved numerically by PISM.  The grounding line is at $1052.5$ km.  Compare Figures \ref{fig:MISMIPmodel1exper1aM1A1} and \ref{fig:MISMIPmodel1exper1aM3A1FROMSM} generated by PISM.}
\label{fig:SMexper1aM1A1}
\end{figure}

There is an additional script \verb|solverSM.py| which computes the profile from the Schoof's \cite{SchoofMarine1} asymptotic-matching boundary layer theory.  This script is a Python translation, using \verb|scipy| and \verb|pylab|, of the \Matlab codes in \url{http://homepages.ulb.ac.be/~fpattyn/mismip/MISMIP_distribution.tar}.  For example,

\verb|$ ./solverSM.py -e 1 --sliding=a -s 1|

\noindent produces Figure \ref{fig:SMexper1aM1A1}.

We see immediately that the PISM result does not put the grounding line in the same location as Schoof's boundary layer theory.  We believe the problem is with PISM's numerical solution, not with that theory.  More evidence that the problem is numerical can be found by looking at the ice flux.  Using \verb|ncview| to examine the diagnostic variable \verb|cflx| (magnitude) in \verb|ABC1_1a_M1_A1.nc| we see Figure \ref{fig:cflx1aM1A1}.  \emph{This is a problem with PISM}.  The flux should be a linear function.  Indeed, at steady state the flux $\bq$ solves $a=\Div\bq$ where $a$ is the accumulation rate.  In MISMIP, $a$ is the constant $0.3$ m/a, so at steady state $|\bq| = a x$, a line.

\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/cflx_EBU1_1a_M1_A1}
\caption{Numerically computed flux $\bq = \bar\bU\, H$, where $\bar\bU$ is the vertically-averaged horizontal velocity and $H$ the thickness, for steady state of experiment 1a, grid mode 1, step 1.  Illustrates a significant numerical problem; it should be the dotted line, which has slope $a = 0.3$ m/a.}
\label{fig:cflx1aM1A1}
\end{figure}

We can learn more about the problem.  It turns out that the numerical flaw in the flux also keeps the grounding line from moving properly, we think.  The problem is that the numerical result doesn't move the grounding line to its correct location if the ice sheet and shelf are initially 10 m as specified in MISMIP.  On the other hand, the correct location for the grounding line is also approximately a steady state for PISM numerics; the grounding line stays where you put it (compare \cite{SchoofMarine2} and \cite{VieliPayne}).

But \verb|solverSM.py| has an option which allows the asymptotic-matching thickness result from the \cite{SchoofMarine1} theory to be written into a NetCDF file.  We can then initialize the PISM thickness from it, using \verb|-regrid_from| (section \ref{sect:usage}).

The effect when we do this at higher resolution (grid mode 3 with 6km spacing, instead of 24 km), is a step forward:

\verb|$ ./solverSM.py  --My=601 -e 1 --sliding=a -s 1 -n SM.nc|

\verb|$ mpiexec -n 4 pisms -model 1 -mismip 1a -step 1 -extras -regrid_from SM.nc \|

\verb|  -regrid_vars H -ksp_rtol 1.0e-7 -My 3 -Mz 15 -Mx 601|

\noindent The result, Figure \ref{fig:MISMIPmodel1exper1aM3A1FROMSM}, is more satisfactory.  On the other hand, inspection of the flux for this new run shows a smaller, but similarly worrying, jump in flux.

\begin{figure}[ht]
\includegraphics[width=4.0in,keepaspectratio=true]{figs/profile_EBU1_1a_M3_A1}
\caption{A marine ice sheet profile in the MISMIP intercomparison; PISM model 1, experiment 1a, grid mode 3, step 1, but on a run started from the corresponding asymptotic-matching result.  At least the location of the grounding line agrees closely with that in Figure \ref{fig:SMexper1aM1A1}.}
\label{fig:MISMIPmodel1exper1aM3A1FROMSM}
\end{figure}


\clearpage\newpage

\section{Example: Modeling the Greenland ice sheet}\label{sect:green} \index{PISM!running the EISMINT Greenland intercomparison}\index{Greenland ice sheet}\index{EISMINT!intercomparison of Greenland models} 

[FIXME: I think EISMINT-Greenland is supposed to have bedrock thermal!  There is no mention in the text \cite{RitzEISMINT}, but there are bedrock thermal parameter values mentioned.  Easy to fix \dots]

In this section we give an extended example of how to use PISM to model the Greenland ice sheet.  We use somewhat stale data from the 1990s ice sheet modelling intercomparison known as EISMINT-Greenland \cite{HuybrechtsEISMINT,RitzEISMINT}.  Though based on old data, EISMINT-Greenland serves as an excellent tutorial example.

The data for performing this experiment are freely available at
\medskip

\centerline{\protect{\textbf{\url{http://homepages.vub.ac.be/~phuybrec/eismint/greenland.html}}}}
\medskip

\noindent The snow-fall accumulation map, ablation parameterization, surface temperature formula, surface elevation, and bedrock elevation maps are essentially as in the 1991 papers \cite{Letreguillyetal1991,OhmuraReeh}.  Note that in the ice and sea floor-core driven ``forced climate'' CCL3 run described below the ice sheet is forced by changes in temperature from the GRIP core \cite{Dansgaardetal1993} and by changes in sea level from SPECMAP \cite{Imbrieetal1984}.  A parameter-sensitivity study of a EISMINT-Greenland type ice sheet model is described in \cite{RitzFabreLetreguilly}.

Substantial developments have occurred in modeling the Greenland ice sheet since the EISMINT-Greenland intercomparison.  For example, the relation between a Greenland ice sheet flow model, Earth deformation under ice sheet loads, and the reconstruction of global ice loading is analyzed in \cite{TarasovPeltier}.  The response of Greenland ice sheet models to climate warming is addressed in \cite{HuybrechtsdeWolde,Huybrechts02, Greve00}, among other references.

The rest of this section is a step-by-step illustration of using PISM.  The details can be typed in by hand, or the user can invoke the bash scripts \verb|preprocess.sh|, \verb|bootstrap.sh|, \verb|ssl2.sh|, and \verb|ccl3.sh| in the directory \verb|examples/eisgreen|.  These scripts execute the commands in the next four subsections, respectively.

\subsubsection*{Obtaining and converting EISMINT-Greenland data}  We use two Python scripts to convert the EISMINT-Greenland data, which is in the form of several ASCII text files, into NetCDF files usable by PISM.  The Python libraries \href{http://numpy.scipy.org/}{\texttt{numpy}} and \href{http://code.google.com/p/netcdf4-python/}{\texttt{netcdf4-python}} must be present for the scripts to work.

First, \verb|cd examples/eisgreen/| from the PISM directory, and download these text (ASCII) files from the EISMINT-Greenland web site above: 

\verb|grid20-EISMINT,  suaq20-EISMINT,  specmap.017,  sum89-92-ss09-50yr.stp|

\noindent One method for the download is: \scriptsize

\verb|$  for name in "grid20-EISMINT" "suaq20-EISMINT" "specmap.017" "sum89-92-ss09-50yr.stp"|

\verb|>   do  wget http://homepages.vub.ac.be/~phuybrec/eismint/$name;  done|

\normalsize\noindent Once all four files have been downloaded, run

\verb|$ ./eisgreen.py|

\noindent The NetCDF file \verb|eis_green20.nc| will be created from the data in \verb|grid20-EISMINT| and \verb|suaq20-EISMINT|.  It contains variables for the gridded latitude (\verb|lat|), longitude (\verb|lon|), surface altitude (``\verb|usurf|'' for \emph{u}pper \emph{surf}ace elevation), bedrock altitude (\verb|topg|), ice thickness (\verb|thk|), and snow accumulation rate (\verb|acab|).  These values can be viewed graphically with \verb|ncview|.  The header (metadata) can be viewed by \verb|ncdump -h eis_green20.nc|.

\begin{comment}
As an exercise, the \href{http://nco.sourceforge.net/}{\texttt{NCO}} can be used on \verb|eis_green20.nc| to compare the putative ice surface elevation to the sum of the ice thickness and the bed elevation:

\verb|$ ncap -O -vs "check=usurf-(thk+topg)" eis_green20.nc eis_green_check.nc|

\noindent The variable \verb|check| in the output file holds the difference of \verb|usurf| and the sum $\verb|topg|+\verb|thk|$.  Viewing \verb|check| in \verb|ncview| will show that \verb|usurf| is within 1 meter of $\verb|topg|+\verb|thk|$.  Thus the surface elevation \verb|usurf| is consistent.  It is also redundant because at bootstrapping, described below, PISM reads ice thickness and bed elevation and computes ice surface elevation as the sum of these two.
\end{comment}

The bed elevation \verb|topg| in the original data (\verb|suaq20-EISMINT|) effectively contains missing values.  These are locations where \verb|topg| is \emph{exactly} $0.0$, presumably because in these locations the observed bed elevation was not measured or the measured value was not trusted.  We think these are deep fjords locations, mostly.  When viewing \verb|eis_green20.nc| with \verb|ncview|, these values show as white spots.  If these missing values are left in then the bed elevation map is extraordinarily rough and this makes reasonable ice flow predictions more difficult.  We therefore smoothly fill the holes in the bed elevations.  This is done with another script named \verb|fill_missing.py|,\footnote{Requires \href{http://code.google.com/p/netcdf4-python/}{\texttt{netcdf4-python}}.  It is a general tool for smoothly filling patches of missing values in variables in NetCDF files.  It looks for attributes defining missing values and then fills in specified variables essentially by averaging the neighboring non-missing values.  See Appendix \ref{sect:scripts}.} found in directory \verb|pism/util/|:

\verb|$ fill_missing.py -f eis_green20.nc -v topg -o eis_green_smoothed.nc|

\begin{figure}[ht]
\includegraphics[width=2.4in,keepaspectratio=true]{figs/EISgreen_thick}\quad\includegraphics[width=2.4in,keepaspectratio=true]{figs/EISgreen_bed}
\caption{Views of the thickness (left) and smoothed bed elevation (right) for EISMINT-Greenland.  The coastal topography around several fjords has been smoothed.}
\label{fig:greendata}
\end{figure}

In addition to getting the EISMINT gridded data into NetCDF format and filling missing values, there is an issue with Ellesmere Island.  Ellesmere Island is very close to Greenland, and so it would be possible for the modeled ice sheet to flow onto it.  (This may have occurred at the last glacial maximum.)  Since we don't, however, have correct topography or accumulation rates for Ellesmere Island, among the downloaded data \cite{RitzEISMINT}, we want to prevent this from happening.  Therefore special code is executed by the PISM executable \verb|pgrn| which we use below.  It says that all points northwest of the line connecting the points $(68.18^\circ E, 80.1^\circ N)$ and $(62^\circ E, 82.24^\circ N)$ are removed from the flow simulation.  The same applies to anything east of $30^\circ E$ and south of $67^\circ N$ so that the flow could not spread to the tip of Iceland (not likely anyway \dots).  The phrase ``removed from the flow simulation'' actually means that the points are marked as ice-free ocean.

Next we use the script which converts the time series data files \verb|specmap.017| and \verb|sum89-92-ss09-50yr.stp| to  PISM readable NetCDF form:

\verb|$ ./eiscore.py|

\noindent Two NetCDF files with one-dimensional time series data are created, namely \verb|grip_dT.nc| and \verb|specmap_dSL.nc|.  The executable \verb|pgrn| will be called with options \verb|-dTforcing| and \verb|-dSLforcing| for these two \verb|.nc| files in the ``CCL3'' run below.  That is, in CCL3 PISM will read the GRIP data \cite{Dansgaardetal1993} for the surface temperature forcing and the SPECMAP data \cite{Imbrieetal1984} for sea level forcing.  Figure \ref{fig:gripDeltaT} shows the GRIP temperature offsets.

\begin{figure}[ht]
\includegraphics[width=5.6in,keepaspectratio=true]{figs/gripDeltaT}
\caption{Change in temperature from present, from the GRIP core.  A famous graph reproduced by applying \texttt{doc/gripdeltaT.py} to \texttt{grip\und dT.nc}}
\label{fig:gripDeltaT}
\end{figure}


\subsubsection*{Bootstrapping from EISMINT-Greenland data}  Once the EISMINT Greenland data is obtained and converted to NetCDF, as above, ``bootstrapping'' can begin.  By ``bootstrapping'' we mean the creation, by heuristics and simplified models, of the full initial conditions needed for the continuum model (differential equations describing ice dynamics) inside PISM.\footnote{Section \ref{sect:boot} will explain, once written, that ``bootstrapping'' is a form of inverse modeling, and that we must inevitably do inverse modeling to do prognostic ice sheet modeling.}

Table \ref{bootstrapEISgreen} shows the entire PISM output for a one model year run using option \verb|-boot_from| to ``bootstrap'' from file \verb|eis_green_smoothed.nc|\index{pgrn}
\begin{verbatim}
$ pgrn -boot_from eis_green_smoothed.nc -My 141 -Mx 83 -Lz 4000 -Mz 51 \
       -quadZ -skip 1 -y 1 -o green20km_y1.nc
\end{verbatim}
\noindent The run takes a few seconds of real time.

\begin{table}
\scriptsize
\begin{quote}
\begin{verbatim}
$  pgrn -boot_from eis_green_smoothed.nc -My 141 -Mx 83 -Lz 4000 -Mz 51 \
        -quadZ -skip 1 -y 1 -o green20km_y1.nc
PGRN stable0.2 (PISM EISMINT-Greenland mode)
  time dimension was not found; setting current year to t = 0.0 years
EISMINT-Greenland mode (IceGRNModel) setting flags equivalent to:
  '-e 3 -ocean_kill -skip 20', but user options will override
initializing positive degree-day model (PDD) for atmospheric climate ... 
  not reading mean annual temperature at ice surface from a file; formulas must fill it ... 
  reading mean annual ice-equivalent snow accumulation rate 'snowaccum' from eis_green_smoothed.nc ... 
  FOUND  snowaccum / mean annual ice-equivalent snow accumulation rate           
                   \ min,max =     0.030,    2.820 (m year-1)
using PDD based on standard yearly surface temp cycle ...
bootstrapping by PISM default method from file eis_green_smoothed.nc
  rescaling computational box for ice from -boot_from file and
    user options to dimensions:
    [-1400.00 km, 1400.00 km] x [-820.00 km, 820.00 km] x [0 m, 4000.00 m]
  polar stereographic variable found; attributes present: svlfp=1, lopo=1, sp=1
     values: svlfp = -41.14, lopo =  71.65, sp =  71.00
  WARNING: surface elevation 'usurf' found; IGNORING IT!
processing 2D model state variables...
  FOUND  lon       / longitude                                                   
                   \ min,max =   -94.194,   12.889 (degrees_east)
  FOUND  lat       / latitude                                                    
                   \ min,max =    58.275,   84.458 (degrees_north)
  FOUND  thk       / land ice thickness                                          
                   \ min,max =     0.000, 3200.000 (m)
  FOUND  topg      / bedrock surface elevation                                   
                   \ min,max = -3859.000, 2151.000 (m)
  absent bwat      / effective thickness of subglacial melt water                
                   \ not found; using default constant    0.00 (m)
  absent tillphi   / friction angle for till under grounded ice sheet            
                   \ not found; using default constant   15.00 (degrees)
  absent bheatflx  / upward geothermal flux at bedrock surface                   
                   \ not found; using default constant   42.00 (mW m-2)
  absent dbdt      / bedrock uplift rate                                         
                   \ not found; using default constant    0.00 (m year-1)
  determining surface elevation by  usurf = topg + thk  where grounded
    and by floatation crit  usurf = (1-rho_i/rho_w) thk  where floating
  determining mask:  grounded ice and ice-free land marked as 1,
    floating ice as 3, and ice free ocean as 7 (from -ocean_kill)
  filling in temperatures at depth using quartic guess
done reading eis_green_smoothed.nc; bootstrapping done
geothermal flux set to EISMINT-Greenland value 0.050000 W/m^2
computing surface temps by EISMINT-Greenland elevation-latitude rule
filling in temperatures AGAIN at depth using quartic guess (for EISMINT-Greenland)
removing extra land (Ellesmere and Iceland) using EISMINT-Greenland rule
\end{verbatim}
\end{quote}
\normalsize
\bigskip

\caption{Bootstrapping from the EISMINT-Greenland data and running for one model year continued on next page.}
\label{bootstrapEISgreen}
\end{table}

\begin{table}
\scriptsize
\begin{quote}
\begin{verbatim}
[computational box for ice:  2800.00 km x  1640.00 km x  4000.00 m]
[hor. grid cell dimensions:    20.00 km x    20.00 km
 vertical grid spacing in ice not equal; range 21.200 m < dz < 138.800 m]
P         YEAR:     ivol   iarea    meltf     thick0     temp0
U        years 10^6_km^3 10^6_km^2 (none)          m         K
S      0.00000:  2.82500  1.6708   0.2071   3042.000  270.5156
 $$ SIA        vath 0d  +0.18294
S      0.18294:  2.82497  1.6764   0.2073   3041.886  270.5156
 $$ SIA        vath 0d  +0.23543
S      0.41837:  2.82516  2.2300   0.1688   3041.701  270.5157
 $$ SIA        vath 0d  +0.26969
S      0.68806:  2.82529  1.9084   0.1876   3041.456  270.5159
 $$ SIA        vath 0d  +0.29959
S      0.98765:  2.82528  1.7028   0.2060   3041.173  270.5161
 $$ SIA        vath 0e  +0.01235
S      1.00000:  2.82529  2.2248   0.1692   3041.162  270.5163
done with run ... 
Writing model state to file `green20km_y1.nc'
\end{verbatim}
\end{quote}
\normalsize
\bigskip

\caption{Continuation of Table \ref{bootstrapEISgreen}.}
\end{table}

Let's explain what has happened.  The EISMINT-Greenland data, as with \emph{all} real ice sheet data, does not contain certain variables necessary to initialize PISM in the sense of complete initial values for time-dependent partial differential equations.  For instance, the data do not include the temperature of the ice anywhere but at the surface (and only there by a elevation and latitude dependent formula).  The data also do not include the amount of water stored in the till, for instance.  These are not omissions from the data sets but rather inevitable facts; one cannot observe ice sheets as fluids very well.  Therefore PISM fills in the unknown initial conditions based on some default guesses, as indicated by the messages in Table \ref{bootstrapEISgreen}.

Note that EISMINT-Greenland specifies an 83 by 141 point grid, but you may use other numbers for \verb|-Mx| and \verb|-My| if desired.  In such cases the data will be linearly interpolated onto your grid.  Larger values will produce slower runs.

\begin{comment}
But there is a transpose: In order to make the diagnostic viewers described in Appendix \ref{sect:viewers} have the correct orientation, the x and y axes are switched internally in PISM.  Of course the physics approximated by PISM does not care about orientation.  The consequence of using ``\verb|-Mx 83 -My 141|'', instead of the correct pair shown, would be to have grid cells which are far from square, and to have squashed viewers.
\end{comment}

The option \verb|-boot_from| stands for ``bootstrap from''.  This option is an alternative to \verb|-i| (stands for ``input file'') which is used for a file which has full initial conditions.  In practice, \verb|-i| is only used with a NetCDF file which was previously saved by PISM; that is, \verb|-i| is used to continue a run from a saved state.

Note the choice of the height of the computational box (``\verb|-Lz 4000|''), of the number of vertical levels (``\verb|-Mz 51|''), and of a not-equally-spaced grid (``\verb|-quadZ|'').  The messages to standard out show that the vertical spacing is less than 30 m near the base and more than 130 m at the top of the computational box (where it matters less).

Regarding the temperature within the ice, bootstrapping applies an interpolation scheme to the surface temperatures and geothermal fluxes.  It is based on a heuristic for the amount of downward flow in a column.  Bootstrapping creates a temperature field at depth.\footnote{See the PISM \emph{Reference Manual} for a formula.}

This bootstrapping mode also fills in several default values.  For instance, the variables \verb|bheatflx| (geothermal flux), \verb|dbdt| (bed uplift rate), and \verb|bwat| (effective thickness of basal water) were not found in the input file, whereas they would be in a saved PISM model state.  Also, note that the EISMINT Greenland data had redundant surface elevation values; PISM bootstrapping includes the computation ``\verb|usurf = topg + thk|'' of the surface elevation from the ice thickness and the bed elevation.

Continuing with the above output, after default bootstrapping there are additional settings special to EISMINT-Greenland.  For instance, because there is no EISMINT-Greenland gridded data set for surface temperature \cite{RitzEISMINT}, at the surface there is a formula which determines the temperature as a function of latitude and surface elevation.  The code behind \verb|pgrn| knows this formula and uses it.  The constant value for geothermal flux is reset, and the above-mentioned Ellesmere Island issue is resolved.

Before seeking a good steady state for the entire thermo-mechanically-coupled ice sheet, it is helpful to do a better job of filling in the temperatures within the ice.  One way to do this is to have the temperature field and velocity field co-evolve according to the thermomechanical flow model, but while holding the upper ice surface stationary.  This is a continuation of ``bootstrapping''.  The effect is to create a temperature field which is approximately stationary with respect to advection and conduction.  The resulting temperature field is not a fully physical temperature field, however, because it comes from a steadiness assumption about the geometry of the ice sheet.

We create this temperature field by running for 10000 years\footnote{In fact a much longer run might be called for because the exponential time constant for decay of the thermomechanically-coupled system toward equilibrium is on the order of 100k years.} with non-evolving surface, using the option \verb|-no_mass| to turn off the map-plane mass continuity scheme:

\verb|$ mpiexec -n 2 pgrn -i green20km_y1.nc -no_mass -y 10000 -o green20km_Tsteady.nc|

This last run takes on the order of one processor hour.  Parallel processing is effective here, up to perhaps peak real time speed with 40 processors for this coarse 83 by 141 grid.  (Finer grid computations are easier to parallelize in the sense that greater a maximum speedup over one processor is attainable.)

The EISMINT-Greenland experiments \cite{RitzEISMINT} specify a positive degree day (PDD) model which is automatically turned on when using the \verb|pgrn| executable.  (The base executable \verb|pismr| requires option \verb|-pdd| or \verb|-pdd_rand| to turn on the PDD model.)  The PDD model is, by default, implemented by the deterministic scheme described in \cite{CalovGreve05}, but the user can add option \verb|-pdd_rand| to use a stochastic PDD implementation.


\subsubsection*{Running the EISMINT-Greenland steady state experiments}  Now that we have initial conditions including a vaguely-credible temperature field, our first experiment is the steady state run ``SSL2''.  This experiment uses the parameters specified in the EISMINT-Greenland description \cite{RitzEISMINT}.  If 8 processors are used, a ten thousand model year run might look like this:

\begin{verbatim}
$ mpiexec -n 8 pgrn -ssl2 -i green20km_Tsteady.nc -y 10000 -ys 0 \
          -o green_SSL2_10k.nc
\end{verbatim}
\noindent We can continue for another ten thousand years by

\begin{verbatim}
$ mpiexec -n 8 pgrn -ssl2 -i green_SSL2_10k.nc -y 10000 \
          -o green_SSL2_20k.nc
\end{verbatim}
\noindent And so on.   The script \verb|ssh2.sh| is useful to automate this, and we will now assume that the user \emph{actually} did a run like  

\verb|./ssh2.sh 2 >> out.ssl2 &|

\noindent This puts the run in the background and generates a text file logging the whole run.  The whole SSL2 run should take something like 15 processor hours to produce eleven output files with names \verb|green_SSL2_|$N$\verb|k.nc| for $N=10,\dots,110$.

Note that, by default the option \verb|-ocean_kill| is set internally in \verb|pgrn|.  This forces all floating ice to immediately calve off (i.e.~to have thickness zero).  Another default setting is \verb|-skip 20|.

The SSL2 simulation is intended to go until the model reaches a ``steady state'', a phrase which \cite{RitzEISMINT} defines as a small volume change rate, namely less than a .01\% change in volume in 10,000 years.

One can look at the standard output text file by a minimal method like ``\verb|less out.ssl2|''.  The user can more clearly see the behavior over time of the volume, area, basal melt fraction, and a couple of other default quantities, by generating a time series file in NetCDF form from the text (log) file coming from \verb|stdout|.  Then various NetCDF tools can be applied to view and manipulate that file.  To do this, use the Python script \verb|util/series.py|, documented in Appendix \ref{sect:scripts}, like this:

\verb|series.py -f out.ssl2 -o ssl2.ser.nc|

\noindent View \verb|ssl2.ser.nc| using \verb|ncview|, for instance.

One sees that the volume shows a consistent growing-but-leveling-out trend, with a final volume a bit more than $4 \times 10^{6}\,\text{km}^3$.  If we run the SSL2 experiment with the specified ``0.01\% change in 10k years'' criterion, then the run ends at 110k years with a volume change of about 0.001\% between the 100k and 110k model states.

The time series for volume and melt fraction (the fraction of the base where the temperature is at pressure-melting) are shown in Figures \ref{fig:eisgrnvolseries} and \ref{fig:eisgrnmeltfseries}.  The volume time series is boring, but the melt fraction indicates something interesting: measured by basal melt fraction, the temperature field resulting from bootstrapping and relaxing the temperature field (above) gave a pretty good estimate of the basal melt fraction for the fully coupled steady state.

\begin{figure}[ht]
\includegraphics[width=6.0in,keepaspectratio=true]{figs/eisgrn_volseries}
\caption{Volume time series for a 110k model year EISMINT-Greenland SSL2 run; units of $10^{6}\,\text{km}^3$.}
\label{fig:eisgrnvolseries}
\end{figure}

\begin{figure}[ht]
\includegraphics[width=6.0in,keepaspectratio=true]{figs/eisgrn_meltfseries}
\caption{Time series for the fraction of the base which is at the pressure-melting temperature from a 110k model year EISMINT-Greenland run.  See the right hand part of Figure \ref{fig:ssl2thickThomol} for a map of the basal temperature.}
\label{fig:eisgrnmeltfseries}
\end{figure}

We will use the final NetCDF file \verb|green_SSL2_110k.nc| to continue the EISMINT-Greenland experiments below.  The saved ice thickness, basal temperature, and vertically-averaged horizontal velocity maps are shown in Figure \ref{fig:ssl2thickThomol}.

\begin{figure}[ht]
\mbox{\phantom{|}\hspace{-1.0in}\includegraphics[height=3.0in,keepaspectratio=true]{figs/greenH_SSL2}\,\includegraphics[height=3.0in,width=2.3in]{figs/greenThomol_SSL2}\,\includegraphics[height=3.0in,keepaspectratio=true]{figs/greencbar_SSL2}}
%\includegraphics[height=3.7in,width=2.9in]{figs/greenThomol_SSL2}
\caption{Ice thickness (meters; left), basal temperature (degrees C below 0; middle), and vertically-averaged horizontal velocity (m/a; right) at the end (110k model years) of a EISMINT-Greenland SSL2 run.  Note that in the temperature graph the pressure-melting temperature areas are white.}
\label{fig:ssl2thickThomol}
\end{figure}

In addition to the more standardized EISMINT-Greenland intercomparison called ``SSL2'', a ``SSL3'' was proposed to allow each participant to choose additional parameters and adjust other aspects of the model.  (Sliding, for instance, is an outstanding omission here.)  We omit this run for tutorial purposes, however, and proceed to use climate forcing in runs ``CCL3'' and ``GWL3''.


\subsubsection*{Climate forcing from GRIP and SPECMAP}  The next experiment starts from the end of the steady state SSL2 run above.  Recall that the NetCDF files \verb|grip_dT.nc| and \verb|specmap_dSL.nc| contain time series data for change in surface temperature and sea level.  The options \verb|-dTforcing| and \verb|-dSLforcing| include these data for a ``CCL3'' climate forced run \cite{RitzEISMINT,HuybrechtsEISMINT}.  Before every time step, \verb|pgrn| reads the change to the surface temperature and sea level for that time.  The data in \verb|grip_dT.nc| extends 250,000 years into the past, while the data in \verb|specmap_dSL.nc| goes back about 780,000 years, so EISMINT-Greenland specifies that the run will start at the beginning of the GRIP data.  Thus we manually set the starting year using the option \verb|-ys|:\footnote{The run done this way would take a very long time and only produce the final file.  It is recommended, instead, that the user use script \texttt{ccl3.sh} which produces an intermediate file at every 10 ka. Another way of getting intermediate files is by using the \intextoption{save\und at} option. See Appendix \ref{sect:options} for more.}

\begin{verbatim}
$ mpiexec -n 8 pgrn -ccl3 -i green_SSL2_110k.nc -dTforcing grip_dT.nc \
          -dSLforcing specmap_dSL.nc -ys -249900 -ye 0 -o green_CCL3_y-0.nc
\end{verbatim}
\noindent Note option \verb|-ccl3| also turns on the Lingle and Clark \cite{BLKfastearth,LingleClark} two layer, flat earth bed deformation model with an assumption of zero uplift rate at the start of the run.

The resulting thickness difference, relative to the end of the SSL2 run, and the homologous basal temperature, are shown in Figure \ref{fig:cclthickThomol}.

\begin{figure}[h]
\includegraphics[width=2.8in]{figs/Hdiff_CCLSSL}\quad\includegraphics[width=2.8in]{figs/Thomol_CCL}
\caption{Left:  Ice thickness difference between end (year zero) of a CCL3 run and the end of an SSL2 run (meters).  Right:  Ice homologous basal temperature (degrees C below 0; right) at the end of a EISMINT-Greenland CCL3 run.  Compare Figure \ref{fig:ssl2thickThomol}.}
\label{fig:cclthickThomol}
\end{figure}

EISMINT-Greenland also calls for a baseline run for another 500 years which starts from the end of the CCL3 run and has steady current climate forcing (noting no GRIP or SPECMAP data are known from the future!):

\verb|mpiexec -n 8 pgrn -ccl3 -i green_CCL3_y-0.nc -y 500 -o green_CCL3_y500.nc|

A final ``greenhouse warming'' experiment ``GWL3'' is described in the EISMINT-Greenland \cite{RitzEISMINT}.  It runs for 500 years with the temperature increasing by $0.035^\circ C/$year for the first 80 years, then at a rate of $0.0017^\circ C/$year for the last 420 years:

\verb|mpiexec -n 8 pgrn -gwl3 -i green_CCL3_y-0.nc -y 500 -o green_GWL3_y500.nc|




\clearpage\newpage
\section{Example: Validating PISM as a flow model for the Ross ice shelf}\label{sect:ross} \index{PISM!running the EISMINT Ross ice shelf intercomparison in}\index{Antarctic ice sheet!Ross ice shelf} \index{EISMINT!intercomparison of Ross ice shelf models} \index{PISM!validation of ice shelf model} \index{Ross ice shelf} The term ``validation'' describes the comparison of model output with physical observations in cases where those physical observations are believed to be sufficiently complete and of sufficient quality so that the performance of the numerical model can be assessed \cite{Roache,Wesseling}.  Roughly speaking, validation can happen when the observations or data are better than the model, so the comparison measures the quality of the numerical model and not merely errors in, incompleteness of, or lack of confidence in, the data.

As part of the first EISMINT series of intercomparisons, MacAyeal and others \cite{MacAyealetal} validated several ice shelf numerical models using the Ross ice shelf as an example.  We refer to this intercomparison and its associate write-up \cite{MacAyealetal} as ``EISMINT-Ross''.  The models were compared to data from RIGGS (the Ross Ice shelf Geophysical and Glaciological Survey \cite{RIGGS2,RIGGS1}), acquired in the period 1973--1978.   The RIGGS data include the (horizontal) velocity of the ice shelf measured at a few hundred locations in a reasonably regular grid across the shelf; see figure \ref{fig:rosspython} below for an indication of these positions.

Substantial developments have occurred in the modeling of the Ross ice shelf since the EISMINT-Ross intercomparison.  For example, inverse modeling techniques were used to recover depth-averaged viscosity of the Ross ice shelf from the RIGGS data in \cite{RommelaereMacAyeal}. A parameter-sensitivity study was performed for a particular Ross ice shelf numerical model in \cite{HumbertGreveHutter}.

The scripts in this section are found in the directory \verb|examples/eisross/|.  The script \verb|quickstart.sh| in that directory will download the data, build a NetCDF input file, and run \verb|pismd| as described in the next three subsections.

\subsubsection*{Grabbing the data}  Download data files from the website:

\centerline{\url{http://homepages.vub.ac.be/~phuybrec/eismint/iceshelf.html}}
\small

\begin{verbatim}
$ cd examples/eisross/
$ wget http://homepages.vub.ac.be/~phuybrec/eismint/111by147Grid.dat
$ wget http://homepages.vub.ac.be/~phuybrec/eismint/kbc.dat
$ wget http://homepages.vub.ac.be/~phuybrec/eismint/inlets.dat
\end{verbatim}
\normalsize The reader might want to look at these files in a text editor.  Their idiosyncratic format must be handled by a python script, namely \verb|eisross.py| below.  In fact, a significant part of setting up EISMINT-Ross in PISM was the step of converting these text files into a machine-readable and metadata-containing NetCDF file.  That is typical of geophysical modeling generally.  The script\footnote{Requires \href{http://numpy.scipy.org/}{\texttt{numpy}} and \href{http://code.google.com/p/netcdf4-python/}{\texttt{netcdf4-python}}.} reads the above three \verb|.dat| files and it creates a NetCDF file:

\begin{verbatim}
$ ./eisross.py -o ross.nc
\end{verbatim}
Note that the NetCDF file \verb|ross.nc| can be reconverted to text (CDL) using \verb|ncdump| or it can be viewed graphically with \verb|ncview|.  For example, \verb|ncdump -h ross.nc| shows the ``header'' (the metadata) for \verb|ross.nc|.  The script \verb|eisross.py| has added this metadata, much of which can only be found by carefully reading references \cite{RIGGS2,RIGGS1,MacAyealetal}.

\begin{figure}[ht]
\includegraphics[height=2.3in,keepaspectratio=true]{figs/rossmask} \qquad \includegraphics[height=2.3in,keepaspectratio=true]{figs/rossubar}
\caption{Two views from \protect{\texttt{ncview}} of the EISMINT-Ross data in the NetCDF file \protect{\texttt{ross.nc}}.  The floating-versus-grounded mask (left; red areas are floating ice shelf) and the $x$-component of the non-zero kinematic (Dirichlet) boundary condition for velocity (right).}
\label{fig:rossmaskubar}
\end{figure}

The NetCDF file \verb|ross.nc| contains ice thickness, bed elevations, surface temperature, and accumulation.  Values for latitude and longitude from the RIGGS survey grid \cite{RIGGS1} are given.  All of these are typical of ice sheet modeling data, both in evolution and diagnostic runs.  The file also has variables \verb|ubar| and \verb|vbar|.  These give the boundary values which are needed for the diagnostic computation of velocity, and they are only valid at grounding line locations.  They are the measured velocities of the ice flow inputs to the ice shelf.  Also present are integer variables \verb|mask|, which shows the domain where the ice shelf is modeled, and \verb|bcflag|, which shows the locations where the boundary conditions are to be applied.  Finally, \verb|ross.nc| contains variables which allow us to partly validate our computation.  There is an interger variable \verb|accur| which flags the region where the interpolated measured velocities are believed to be accurate enough for validation.\footnote{\texttt{111by147.dat} has a ``Reliable Velocity Obs'' flag.}  The variables \verb|azi_obs| and \verb|mag_obs| are believed to be accurate in this region \cite{MacAyealetal}.

The original EISMINT-Ross data are on a 111 by 147 grid but \verb|eisross.py| extends this grid to a more convenient 147 by 147 grid with the same $6.822$ km spacing.  This grid has ice-free ocean beyond the calving front, which is straightened as described in \cite{MacAyealetal}.  The gridded data have a particular resolution, but the PISM computational grid can be finer or coarser according to runtime options (as illustrated below).

\subsubsection*{Diagnostic computation of ice shelf velocity}  A basic Ross ice shelf velocity computation from these data is:

\begin{verbatim}
$ pismd -ross -boot_from ross.nc -ssa -ssaBC ross.nc \
        -Mx 147 -My 147 -Mz 3 -Lz 1e3
\end{verbatim}
Here we bootstrap (\verb|-boot_from|; see section \ref{sect:boot}) from \verb|ross.nc|.  We also use a special option \verb|-ssaBC| to specify \verb|ross.nc| as the source of the boundary value data for the ice shelf equations, as mentioned in the last paragraph.  The computational grid specified here is the $6.822$ km data grid in EISMINT-Ross with 147 grid points in each direction.  The maximum thickness of the ice is 874 m so we choose a height for the computational box (\verb|-Lz|) large enough to contain the ice.  Note that using a small number of vertical levels (\verb|-Mz 11|) is reasonable because the EISMINT-Ross intercomparison specifies that the temperature at each depth is just the surface temperature \cite{MacAyealetal}.  In fact there is no thermocoupling issue because the ice hardness used here is constant.

At the end of this run the computed velocity field is compared to the interpolated observed velocities stored in \verb|ross.nc|.  The value called ``average relative error in vector vel'' is most relevant.  A value of 0.07 here means that the averaged absolute difference between the computed and the observed velocity, in the ``accurate'' region, is 7\%.

The output file \verb|unnamed_diag.nc| contains vertically-averaged horizontal speed in the variable \verb|cbar|.  Viewing that variable will show a picture like the one on the cover page of this \emph{User's Manual}, and like that in figure \ref{fig:rossspeed}.

\begin{figure}[ht]
\includegraphics[height=3.2in,keepaspectratio=true]{figs/rossspeed}
\caption{Computed horizontal ice speed of the Ross ice shelf.  Color gives velocity in m/a; see scale.}
\label{fig:rossspeed}
\end{figure}

There are many variations on this basic ``\verb|pismd -ross|''\pismoptionindex{ross} run above.  First of all one can get more information during the run by adding diagnostic viewers and a more complete (verbose) report to standard out:\index{pismd} \pismoptionindex{ssaBC}\pismoptionindex{pause} \pismoptionindex{ssa}

\begin{verbatim}
$ pismd -ross -boot_from ross.nc -ssa -ssaBC ross.nc \
        -Mx 147 -My 147 -Mz 3 -Lz 1e3 -d cnmu -verbose -pause 10
\end{verbatim}
Secondly one might want to do the run in parallel and do it on a finer grid.  For example,

\begin{verbatim}
$ mpiexec -n 4 pismd -ross -boot_from ross.nc -ssa -ssaBC ross.nc \
          -Mx 201 -My 201 -Mz 3 -Lz 1e3
\end{verbatim}
The result is very similar, as it should be.  On the other hand, since the data is only on a 6.8 km grid we expect no added accuracy on this new 5km grid.

Alternately one might want to experiment with different values of the hardness parameter.  Its default value is $\bar B = 1.9 \times 10^8 \, \text{Pa}\, \text{s}^{1/3}$ as in \cite{MacAyealetal}.   We can also use smaller (more severe) tolerances for the nonlinear iteration (\intextoption{ssa\und rtol}) and the linear iteration (\intextoption{ksp\und rtol}) to get more confidence in the numerical scheme:

\begin{verbatim}
$ pismd -ross -boot_from ross.nc -ssaBC ross.nc -Mx 147 -My 147 -Lz 1000 \
        -Mz 11 -ssa -ice_type custom -ice_custom_hardness 1.8e8 \
        -o ross_out_1p8.nc -ssa_rtol 1e-6 -ksp_rtol 1e-10
\end{verbatim}
Table \ref{tab:rossoptions} lists some of the options which are useful for this kind of diagnostic velocity computation. %Jed

\small
\begin{table}[ht]
\caption{Non-obvious options available and/or recommended with \texttt{pismd -ross}.\index{PISM!options for \texttt{pismd -ross}}}\label{tab:rossoptions}
\begin{tabular}{@{}llll}\hline
\textbf{Option} & \textbf{Explanation/Comments} \\ \hline
  \verb|-d cnmu| &       a good way to see what is going on \\
  \verb|-mato foo -matv cnmuvH|\pismoptionindex{mato}\pismoptionindex{matv} &  writes some model results to \\
    & Matlab-readable file \verb|foo.m| \\
  \verb|-pause N| &      pause for N seconds when refreshing viewers \\
  \verb|-ross| &         only use with executable \verb|pismd| \\
  \verb|-verbose 4| &      shows information on nonlinear iteration and Krylov solve \\
    & and parameters related to solving the ice shelf equations \\
\hline
\end{tabular}
\end{table}
\normalsize


\subsubsection*{Comparison to RIGGS data}  The file \verb|riggs_clean.dat| is a cleaned-up version of the original RIGGS\index{RIGGS} data \cite{RIGGS1, RIGGS2}.  (See \texttt{README} for more explanation on this RIGGS data.)  To convert this data to a NetCDF file, as needed next, do

\begin{verbatim}
./eisriggs.py -o riggs.nc
\end{verbatim}
A file \verb|riggs.nc| will be created.  This data is one-dimensional; it is just a lists of values which have an index dimension \verb|count| in the NetCDF file \verb|riggs.nc|.

Now, \verb|pismd -ross| can read this data and compute a $\chi^2$ statistic comparing computed PISM output to the data:

\small
\begin{verbatim}
$ pismd -ross -boot_from ross.nc -ssaBC ross.nc -Mx 147 -My 147 -Lz 1000 -Mz 3 \
       -ssa -riggs riggs.nc
PISMD stable0.2 (diagnostic velocity computation mode)
. . .
initializing EISMINT-Ross ice shelf velocity computation ...
. . . 
maximum computed speed in ice shelf is   1364.654 (m/a)
. . .
comparing to RIGGS data in riggs.nc ...
Chi^2 statistic for computed results compared to RIGGS is   3637.016
Writing model state, with full 3D velocities, to file `unnamed_diag.nc'
\end{verbatim}
\normalsize

Naturally, the question is ``does this $\chi^2$ value of $3637.016$ represent a good fit of model result to observations''?  Also naturally, there is no objective answer.  For comparison, Table 1 in \cite{MacAyealetal} is reproduced here as Table \ref{tab:chisqr}.  As noted, all these results are with a constant hardness parameter $\bar B = 1.9 \times 10^8 \, \text{Pa}\, \text{s}^{1/3}$ \cite{MacAyealetal}. The maximum computed horizontal ice speed above of $1364.654$ m/a is slightly lower than the maximum velocities reported by the other models but, on the other hand, the maximum measured speed in the RIGGS data set is $1007$ m/a (near the calving front, of course).  The $\chi^2$ result is essentially as good as the best in the Table, noting smaller $\chi^2$ is better.

\small
\begin{table}[ht]
\caption{Model performance index, $\chi^2$ (non-dimensional).  \protect{\textsl{(Reproduction of Table 1 in \cite{MacAyealetal}.)}}}\label{tab:chisqr}
\begin{tabular}{@{}llll}\hline
\textsl{Model} & $\chi^2$ & \textsl{Maximum velocity} \\
 & & $\text{m}\,\text{a}^{-1}$ \\ \hline
Bremerhaven1 & 3605 & 1379 \\
Bremerhaven2 & 12\,518 & 1663 \\
Chicago1 & 5114 & 1497 \\
Chicago2 & 5125 & 1497 \\
Grenoble & 5237 & 1508 \\
\hline
\end{tabular}
\end{table}
\normalsize

\subsubsection*{Tuning the ice hardness for a better fit to RIGGS}  Because there is a relatively rich data set from RIGGS on ice velocity, it is reasonable to ask whether the PISM computed velocities can fit the data better if the hardness parameter $\bar B$ is adjusted.  In directory \verb|examples/eisross/| there is a Python script \verb|tune.py| which (by default) runs \verb|pismd -ross| with seven values of $\bar B$ ranging from $\bar B = 1.6  \times 10^8$ to $\bar B = 2.2 \times 10^8 \, \text{Pa}\, \text{s}^{1/3}$.  It uses smaller values for the convergence tolerances (by default), yielding slightly different $\chi^2$ values.  It can be run in parallel: ``\verb|$ ./tune.py -n 4|.''

One sees that hardnesses $\bar B = 1.9,2.0 \times 10^8 \, \text{Pa}\, \text{s}^{1/3}$ give the best fits, by the standard of $\chi^2$ relative to RIGGS data.  This fitting exercise is a first small step towards inverse modelling of the spatially-distributed effective viscosity.  Another major tunable parameter, not demonstrated with \verb|tune.py|, is the calving front force boundary condition.  More steps in the inverse modeling direction, for modeled velocity in Antarctic ice shelves, are found in \cite{HumbertGreveHutter,RommelaereMacAyeal}.


\subsubsection*{Additional visualization}  The visualization abilities of PISM's runtime viewers, and of \verb|ncview| for NetCDF files, are limited.  On the other hand, we can produce pretty pictures using Python.  The script \verb|ross_plot.py| uses Python packages \verb|netcdf4-python|, \verb|matplotlib|, and \t{scikits.delaunay} to do this.  Assuming that \verb|rossComputed.nc| was produced by the following PISM run,

\begin{verbatim}
$ pismd -ross -boot_from ross.nc -ssaBC ross.nc -Mx 147 -My 147 -Lz 1000 \
        -Mz 11 -ssa -o rossComputed.nc
\end{verbatim}
and the RIGGS data is in \verb|riggs_clean.dat| described above, then do

\verb|$ ./ross_plot.py --pism-output=rossComputed.nc --riggs=riggs_clean.dat|

\noindent Get Figure \ref{fig:rosspython}.  We have succeeded in modeling a real ice shelf.

\begin{figure}[ht]
\mbox{\includegraphics[width=3in,keepaspectratio=true]{figs/rossquiver}\, \includegraphics[width=3in,keepaspectratio=true]{figs/rossscatter}}
\caption{\protect{\emph{Left}}: Color is speed in m/a.  Arrows are observed (black) and computed (red) velocities at RIGGS points.  \protect{\emph{Right}}: Comparison between modeled and observed speeds at RIGGS points; compare figure 2 in \cite{MacAyealetal}.}
\label{fig:rosspython}
\end{figure}



%         References
\clearpage\newpage
\bibliography{ice_bib}
\bibliographystyle{siam}

\appendix

\newcommand{\subsect}[1]{\bigskip\subsection{#1}\rule{0mm}{2mm}\par\medskip}
%\newcommand{\subsectstar}[1]{\bigskip\subsection*{#1}\rule{0mm}{2mm}\par\medskip}
\newcommand{\subsectstar}[1]{\bigskip\noindent\textbf{#1.}\rule{0mm}{2mm}\par\medskip}
\newcommand{\subsubsect}[1]{\subsubsection{#1}\rule{0mm}{2mm}\par\smallskip}

\clearpage\newpage
\section{PISM command line options}\label{sect:options}

Much of the behavior of PISM can be set at the command line by options.\index{PISM!options available at the command line}\index{options for PISM (and PETSc)!complete list}  For example, the command 

\verb|$  pismv -test C -Mx 61 -e 1.2 -o foo.nc|

\noindent includes four options ``\verb|-test|'', ``\verb|-Mx|'', ``\verb|-e|'', and ``\verb|-o|'',  The first of these options includes a single character argument, the second an integer argument, the third a floating point argument, and the fourth has a string argument.

The format of the option documentation below is

\centerline{``\large\texttt{-optionname} [\texttt{A}][\texttt{B} \emph{only}]: \quad Description.\normalsize''}

\noindent Here ``A'' is the default value and ``\t{B}'' is a list of the allowed executables.  The option applies to all executables (\verb|pismr|, \verb|pisms|, \verb|pismv|) unless the allowed executables are specifically stated by giving ``[\t{B} \textsl{only}]''.

As PISM is a PETSc program \cite{petsc-user-ref}, all PETSc options are available as well.  The last subsection \ref{subsect:petscoptions} recalls some of these PETSc options.

The Index on page \pageref{sect:index} contains an alphabetical list of options.

\subsect{List of PISM-specific options}

\subsectstar{Options turning on and off major physical models}

\opt{bed\und def\und iso} Compute bed deformations by simple pointwise isostasy.  Assumes that the bed at the starting time is in equilibrium with the load so the bed elevation is equal to the starting bed elevation minus a multiple of the increase in ice thickness from the starting time, roughly: $b(t,x,y) = b(0,x,y) - f [H(t,x,y) - H(0,x,y)]$.  Here $f$ is the density of ice divided by the density of the mantle.  See Test H in Verification section.

\opt{bed\und def\und lc} Compute bed deformations, caused by the changing load of the ice, using a viscoelastic earth model.  Uses the model and computational technique described in \cite{BLKfastearth}, based on the continuum model in \cite{LingleClark}.

\opt{float\und kill}  If ice is (or becomes) floating then it is set to thickness zero.  This is calving at the grounding line.

\opt{hold\und tauc}    Keep the current values of the till yield stress $\tau_c$.  That is, do not update them by the default model using the stored basal melt water.  Only effective if \verb|-ssa| and \verb|-plastic| are also set.  See documentation of option \verb|-plastic| for a description of the till yield stress model.

\opt{no\und mass}  Forces PISM to not change the ice thickness.  No time steps of the mass conservation equation are computed.

\opt{no\und temp}  Force PISM to not change temperature or age values within the ice.  No time steps of the energy conservation and age equations are computed.

\opt{ocean\und kill}  If used with input from a NetCDF initialization file which has ice-free ocean mask (value \verb|MASK_FLOATING_OCEAN0|$=7$), will zero out ice thicknesses in areas that were ice-free ocean at time zero.  This is calving at the location of the original calving front.  Has no effect when used in conjunction with \verb|-no_mass|.

\opt{pdd}  Turns on the positive degree day model (which is off by default for \verb|pismr|, \verb|pisms|, and \verb|pismv|).  Use the method described in \cite{CalovGreve05}, which computes the expected number of positive degree days.  See subsection \ref{subsect:pdd}.

\opt{plastic}  Use Schoof's plastic till model for ice streams at all grounded points on the ice sheet.  Must be used along with \verb|-ssa| to turn on the solution of the SSA (shallow shelf approximation).  See subsection \ref{subsect:plastic}.  See options \verb|-plastic_reg|, \verb|-plastic_c0|, \verb|-plastic_phi|, and \verb|-plastic_pwfrac|, all of which control the plastic till model in various ways.

Indeed, we describe the role of the parameters for the plastic till model as follows: The effective pressure $N$ on the till is
	$$N = P - p = (1 - (\mathtt{pwfrac}) \lambda) P$$
where $P = \rho g H$ is the overburden or hydrostatic pressure at the base (see Paterson \cite{Paterson}, pp.~168--169) and $p = (\mathtt{pwfrac}) \lambda P$ is the pore water pressure in the till.  Here $\lambda$ is a pure number, $0\le \lambda \le 1$, measuring the amount of available basal water.  In particular, $\lambda = 0$ if the base is frozen, while $\lambda$ is a linear function of the stored basal melt water (see \verb|-d L|), up to the fixed maximum amount of stored basal melt water.  Thus our model says that when there is a lot (the maximum) amount of available basal water, $p= (\mathtt{pwfrac}) P$; the default value for $\mathtt{pwfrac}$ is 0.95.

Note that Paterson gives this formula for the till yield stress
	$$\tau_c = c_0 + \mu N, \qquad \mu = \tan \phi,$$
while Schoof \cite{SchoofStream} formula (2.4) gives this one
	$$\tau_c = \mu N,$$
with zero till cohesion.  We allow a positive till cohesion, though the default is zero, and we describe $\mu$ as the tangent of the friction angle $\phi$.

\opt{ssa}  Use the equations of the shallow shelf approximation \cite{MacAyeal,Morland,SchoofStream,WeisGreveHutter} for ice shelves and dragging ice shelves (i.e.~ice streams) where so-indicated by the mask.  To view the mask use \verb|-d m|.  See also \verb|-plastic| and \verb|-super|. See also \verb|-dontreadSSAvels|.

\opt{super}  Superpose the velocity fields from the SIA and SSA models.  That is, add the velocity fields which result from the SIA and SSA versions of the balance of momentum equations.  Also has the effect of the option \verb|-mu_sliding 0.0|, that is, the SIA-type sliding law is set to zero so that all basal sliding is controlled by the SSA model.  Only effective if used with \verb|-ssa|.


\subsectstar{Options controlling model run length/start/end}

\optdef{y}{1000} Number of model years to run.

\opt{ye} Model year at which to end the run.  The default value is (\verb|-ys|) start year plus the default or given (\verb|-y|) run length.  If both \verb|-ys| and \verb|-ye| are used then the run length is set to the difference, and any time read from the input file is ignored.  (Using all three of \verb|-ys|, \verb|-y| and \verb|-ys| is not allowed.)

\optdef{ys}{0} Model year at which to start the run.  If both \verb|-y| and \verb|-ys| are used then the start year is set to the \verb|-ys| value, ignoring any time in the input file.


\subsectstar{Options controlling input and output behavior of PISM}

\subsubsect{File input and output from PISM}

\opt{boot\und from}  The model can be ``bootstrapped'' from certain NetCDF files using less than the full initial values for the system of evolution partial differential equations.  See sections \ref{sect:boot} for generalities and \ref{sect:green} for an example.  Compare \verb|-i|.

\opt{dSLforcing}    Use the specified NetCDF file to apply changes in \emph{S}ea \emph{L}evel from a climate ``forcing'' record.  See section \ref{sect:green} for an example.

\opt{dTforcing}    Use the specified NetCDF file to apply changes in surface \emph{T}emperature from a climate ``forcing'' record.  See section \ref{sect:green} for an example.

\opt{f3d}  Save the model state with additional full velocity field.  That is, save all scalar components $u(x,y,z)$, $v(x,y,z)$, $w(x,y,z)$ of the velocity field for $(x,y,z)$ everywhere in the three-dimensional computational box.  These are saved as \verb|uvel|, \verb|vvel|, and \verb|wvel|, respectively.  Also saves \verb|uvelsurf| and \verb|vvelsurf|, the surface values of the $x$ and $y$ components of the velocity.

Has the effect of (very roughly) doubling the size of the output model state NetCDF file.

Not needed when using \verb|pismd|, for which saving the full three-dimensional velocity field is the default.

\opt{i}  The model can be initialized (restarted) from a NetCDF file \verb|foo.nc| written by the model, e.g.~\verb|foo.nc| from \verb|-o foo.nc|.  Compare \verb|-boot_from|.

\optdef{mato}{pism\und views}  Specifies the name of the \Matlab-readable file in which to save the views.  Use with \verb|-matv|, to set which views to save; if \verb|-matv| is not set then \verb|-mato| has no effect.

\opt{matv}  Specifies which \Matlab ``views'' to save at end of run.  See Appendix \ref{sect:viewers} for list of single character names of the views.  The default is for \emph{no} \Matlab views.  See \verb|-mato| for setting the name of the \Matlab-readable file in which to save the views.  Typically the user will write \verb|-mato foo -matv HT0c| to save four views in the \Matlab-readable ASCII file \verb|foo.m|.

\opt{o}  Give name of output file: \verb|-o foo.nc| writes an output file named \verb|foo.nc|.  See the description of option \verb|-i|.  Default name is \verb|unnamed.nc| under \verb|pismr|, \verb|simp_exper.nc| under \verb|pisms|, and \verb|verify.nc| under \verb|pismv|.

\opt{a} Append to the output file.

\opt{regrid\und from}  Give the name of the NetCDF file from which to regrid variables.  See section \ref{sect:usage}.

\optdef{regrid\und vars}{}  Which variables to regrid.  See section \ref{sect:usage}.

\opt{dontreadSSAvels} Turns off reading the \verb|ubarSSA| and \verb|vbarSSA| velocities saved by a previous \verb|-ssa| run.

\opt{save\und to} Give the name of the NetCDF file to which to save PISM model states
(snapshots).  Requires setting \verb|-save_at|.  Saving the
snapshots \emph{does not} affect the time-stepping determined by the adaptive
scheme.

For example,
\begin{verbatim}
$ pismv -test G -y 1000 -save_to foo.nc -save_at 0:100:900 -o bar.nc
\end{verbatim}
produces two files.  File \verb|foo.nc| has snapshots at 10 times, each a time 
following a regular PISM timestep.  File \verb|bar.nc| has the final PISM state,
at time 1000.0 in this case.

Note that in presence of the \verb|-split_snapshots| option
\verb|-save_to| value is interpreted as a \emph{basename}. That is,
\begin{verbatim}
$ pismv -test G -y 1000 -save_to foo -save_at 0:100:900 -split_snapshots
\end{verbatim}
will produce files with names such as \verb|foo-000112.nc|.

Compare option \verb|-o| which merely saves the final state.  
See section \ref{sec:snapshots} for more details. 

\opt{save\und at} Used in combination with option \verb|-save_to| above.
Takes two kinds of input: either a MATLAB-style range in the form
$t_{0}:\Delta t:t_{f}$ or a comma-separated list of times in years.  The
comma-separated list above can be at most 200 numbers long.

Saving the snapshots \emph{does not} affect the time-stepping determined 
by the adaptive scheme.  As a result, snapshots are saved
\emph{on the first time-step after the time requested}, and there is
no guarantee of producing the exact number of snapshots requested.

For example, if in a particular run PISM uses time-steps of
60 years, then \verb|-save_at 50,80,100| might produce snapshots at 60 and 120
years if 0.0, 60.0, 120.0, \dots were the usual PISM timesteps.

See section \ref{sec:snapshots} for more details.

\opt{split\und snapshots} Save model state snapshots to separate files. See the
\verb|-save_to| option documentation above for details.

\subsubsect{Diagnostic viewers}

\opt{d}  Specifies diagnostic (X Windows) viewers.  See Appendix \ref{sect:viewers}.

\opt{dbig}  Specifies larger (about twice linear dimensions) diagnostic viewers.  See Appendix \ref{sect:viewers}.

\opt{id}  Sets the x grid index at which a sounding diagnostic viewer (Appendix \ref{sect:viewers}) is displayed.  The integer argument should be in the range $0,\dots,\text{\t{Mx}}-1$.  The default is $(\text{\t{Mx}}-1)/2$ at the center of the grid.  For example, \verb|pismv -test G -d t -id 10|.

\opt{jd}  Sets the y grid index at which a sounding diagnostic viewer (Appendix \ref{sect:viewers}) is displayed.  The integer argument should be in the range $0,\dots,\text{\t{My}}-1$.  The default is $(\text{\t{My}}-1)/2$ at the center of the grid.  For example, \verb|pismv -test G -d t -jd 10|.

\optdef{kd}{0}  Sets the z grid index at which map-plane diagnostic views are shown.  Compare \verb|pismv -test G -Mz 101 -d T| and \verb|pismv -test G -Mz 101 -d T -kd 50|.  See Appendix \ref{sect:viewers}.


\subsubsect{Verbosity to standard out}

\optdef{verbose}{2}   Increased verbosity of standard output.  Can be given without argument (``\verb|-verbose|'') or with a level which is one of the integers 0,1,2,3,4,5 (``\verb|-verbose 2|'').  The full scheme is given in table \ref{tab:verbosity}.

\opt{vverbose}   See table \ref{tab:verbosity}.

\opt{vvverbose}   See table \ref{tab:verbosity}.

\begin{table}[ht]
\caption{Controlling the verbosity level to standard out.}\label{tab:verbosity}
\begin{tabular}{@{}llll}\hline
\textbf{Level} & \textbf{Option} & \textbf{Meaning} \\ \hline
   0  &  \t{-verbose 0} &   never print to standard out \emph{at all}; no warnings appear  \\
   1  &  \t{-verbose 1} &   only warning messages and other high priority messages \\
      &                 &    will appear  \\
   2  &  [\t{-verbose 2}] & default verbosity    \\
   3  &  \t{-verbose 3} &   somewhat verbose; expanded description of grid at start  \\
      &  or \quad \t{-verbose} &  and expanded information in summary    \\
   4  &  \t{-verbose 4} &     \\
      &  or \quad \t{-vverbose} &  more verbose    \\
   5  &  \t{-verbose 5} &     \\
      &  or \quad \t{-vvverbose} &  maximally verbose \\
\hline
\normalsize
\end{tabular}
\end{table}


\subsectstar{Options controlling parameters for physical models}

\subsubsect{Flow and dynamical parameters}

\optdef{constant\und nuH}{30.0}  If this option is used then the velocities in ice shelves and streams (see \verb|-ssa| below) are computed with a constant value for the product of viscosity $\nu$ and thickness $H$, obtained from the shelf extension (see \verb|-shelfxt|).  This is useful for debugging ice-shelf flow because there is reduces the membrane stress to a linear constant-coefficient term rather than a fully nonlinear one.  The argument is given in units of MPa a, and the default value is $30$ MPa a, the value given in \cite{Ritzetal2001}.

\optdef{e}{1.0}  Flow enhancement factor.

\optdef{gk}{1.0}  Sets the flow law used in computing SIA velocity to Goldsby-Kohlstedt \cite{GoldsbyKohlstedt} and uses a constant grain size.  The option \verb|-gk| without an argument uses default grain size of 1 mm while \verb|-gk N| uses \verb|N| mm grains.  See \verb|-ice_type| for more complete option choice of flow law.

\opt{gk\und age}  Sets the flow law used in computing SIA velocity to Goldsby-Kohlstedt \cite{GoldsbyKohlstedt}, but uses the modeled age to compute the grain size; compare \verb|-gk|.  The age is used in a table from the Vostok core \cite{VostokCore} to compute a grain size.  This option should not be used unless the model age has stabilized after a long (e.g.~$\ge 100$ ka) run.

\optdef{ice\und type}{pb}  Allows choice of ice rheology, also known as the ``flow law''.  The options are in table \ref{tab:flowlaw} below.  Note that a ``flow law'' here means the function $F(\sigma,T,P,d)$ in the relation
	$$\dot \eps_{ij} = F(\sigma,T,P,d)\, \sigma_{ij}'$$
where $\dot \eps_{ij}$ is the strain rate tensor, $\sigma_{ij}'$ is the stress deviator tensor, $T$ is the ice temperature, $\sigma^2 = \frac{1}{2} \|\sigma_{ij}'\|_F$ so $\sigma$ is the second invariant of the stress deviator tensor, $P$ is the pressure, and $d$ is the grain size.  That is, we are addressing isotropic flow laws only, and one can choose the scalar function.  Note that the inverse form of such a flow law in needed for ice shelves and ice streams:
	$$\sigma_{ij}' = 2 \nu(\dot\eps,T,P,d)\,\dot \eps_{ij} $$
Here $\nu(\dot \eps,T,P,d)$ is the effective viscosity.  The need for this inverse form of the flow law explains the ``hybrid'' law \verb|-ice_type hybrid| (or \verb|-gk|).

\optdef{ice\und custom\und hardness}{1.9e8} Some ice types are customizable, run with \verb|-help| to see all the customizable options for your chosen ice type (since \verb|-help| displays many options, it is often useful to grep the output, as in \verb:pismv -ice_type custom -help | grep ice_:).  A common use the \verb|custom| ice type is to directly specify the hardness parameter in an ice shelf study.  The viscous stress term in the $x$-component (for example) of the SSA equations for ice shelves and ice streams is
	$$\ddx{}\left(2\nu H\left(2\ddx{u} + \ddy{v}\right)\right)$$
where 
	$$\nu = \frac{\bar B}{2} \left[\left(\ddx{u}\right)^2 + \left(\ddy{v}\right)^2 +
  \frac{1}{4} \left(\ddy{u} + \ddx{v}\right)^2 + \ddx{u}\ddy{v}\right]^{(1-n)/(2n)}.$$
Generally $\bar B$ is computed by a vertical-integral of a function of the temperature field, but it is constant for isothermal ice.  If \verb|-ice_custom_hardness| is used then $\bar B$ is set to the given value.  The value should have units of Pa $\text{s}^{1/n}$ where $n$ is the Glen exponent (see \verb|-ice_type|).  Note that \verb|-ice_type| is \verb|pb| (Paterson-Budd) by default for most runs so \verb|-ice_custom_hardness| is only available when \verb|-ice_type custom| is given or when the driver has changed the default ice type (such as with \verb|pismv -test I| and \verb|pismd -ross|).

In the case of \verb|pismd -ross|, which performs the EISMINT Ross ice shelf intercomparison, a constant value $\bar B = 1.9 \times 10^8 \, \text{Pa}\, \text{s}^{1/3}$ is the default \cite{MacAyealetal}.

\begin{table}[ht]
\caption{Choosing the rheology using \t{-ice\und type}.}\label{tab:flowlaw}
\small
\begin{tabular}{@{}llll}\hline
\textbf{Flow Law} & \textbf{Type} & \textbf{Comments and Reference} \\ \hline
Paterson-Budd law   &  \t{pb} &   Fixed Glen exponent $n=3$.  There is a split ``Arrhenius'' \\
\quad (usually the default) & & term $A(T) = A \exp(-Q/RT^*)$ where \\
  & & $(A = 3.615 \times 10^{-13}\, \text{s}^{-1}\, \text{Pa}^{-3}, Q = 6.0 \times 10^4\, \text{J}\, \text{mol}^{-1})$ if \\
  & & $T^* < 263$ K and $(A = 1.733 \times 10^{3}\, \text{s}^{-1}\, \text{Pa}^{-3}$, \\
  & & $Q = 13.9 \times 10^4\, \text{J}\, \text{mol}^{-1})$ if $T^* > 263$ K and \\
  & & where $T^*$ is the pressure-adjusted temperature \cite{PatersonBudd}.  \\
\emph{Cold} part of Paterson-Budd    &  \t{arr} &   Regardless of temperature, the $A$ and $Q$ values for $T^*<263$ K in \\
  & & the Paterson-Budd law apply.  This is the flow law \\
  & & used in the thermomechanically coupled exact solutions \\
  & & Tests \textbf{F} and \textbf{G} described in \cite{BBL,BB} \\
  & & and run by \verb|pismv -test F| and \verb|pismv -test G|.  \\
\emph{Warm} part of Paterson-Budd     &  \t{arrwarm} & Regardless of temperature, the $A$ and $Q$ values for $T^*>263$ K in \\
  & &  Paterson-Budd apply.    \\
Hooke law   &  \t{hooke} &  Fixed Glen exponent $n=3$.  Here \\
  & & $A(T) = A \exp(-Q/(RT^*) + 3C (T_r - T^*)^\kappa)$; values of \\
  & & constants as in \cite{Hooke,PayneBaldwin}.   \\
Hybrid of Goldsby-Kohlstedt &  \t{hybrid} &     Goldsby-Kohlstedt law with a combination of exponents  \\
  \qquad and Paterson-Budd & & from $n=1.8$ to $n=4$ \cite{GoldsbyKohlstedt} in grounded \\
  & & shallow ice approximation regions.  Paterson-Budd flow \\
  & & for ice streams and ice sheets. See mask for SIA \\
  & & versus stream versus shelf by \verb|-d m|. \\
Isothermal Glen & \t{custom} & Highly customizable version of the isothermal Glen flow law. \\
  & & Allows choice of exponent, hardness/softness parameters, and density. \\
\hline
\normalsize	
\end{tabular}
\end{table}

\opt{shelfext\und} When computing ice shelf and stream velocity, PISM enforces boundary conditions using a fictitious extension of the ice shelf over the entire domain.  This extension provides strength only, it does not change the mass, driving force, or location of the calving front.  By default, it's strength will be computed using the current ice type at reference thickness, temperature, and strain rate, customizable using \verb|-shelfext_H| (5 meters by default), \verb|-shelfext_T| (263.15 K), \verb|-shelfext_Du| (1 m/a per km).  The extension strength is used whenever ice thickness is less than the extension thickness to prevent the equations from becoming singular.  You can also specify the extension strength directly using \verb|-shelfext_force_nuH| with units in Pa s.  Finally, you can compute strength using a \verb|custom| ice type the ice used in the rest of PISM by giving \verb|-shelfext_use_private_ice|.  This option will gives you a \verb|custom| ice type which you can control via \verb|-shelfext_ice_custom_| (see \verb|-ice_type|).  All \verb|-shelfext| options are displayed in \verb|-help|.

\optdef{mu\und sliding}{0}  The sliding law parameter in SIA regions of the ice.  \emph{This kind of sliding is not recommended, which is why it is turned off by default.  See} \verb|-ssa| \emph{and} \verb|-plastic| \emph{for the recommended sliding model.}  This kind of sliding is used in experiments G and H of EISMINT II \cite{EISMINT00}, but note that executable \verb|pisms -eisII| ignors this parameter and uses the right amount of sliding for the given experiment.

\opt{surf\und vel\und to\und phi}  Computes till friction angle $\phi$=\texttt{tillphi} by inverting provided surface velocities in file.  Under development.  See \emph{Reference Manual} and source files \texttt{iMinverse.cc,iMinverseMat.cc}.

\optdef{topg\und to\und phi}{5.0,15.0,-1000.0,1000.0,10.0}  Sets till friction angle $\phi$=\texttt{tillphi} to piecewise-linear function of bed elevation.  Takes zero to five comma-separated arguments.  An example, in which sliding happens in the ``trough'', is 

\verb|pisms -eisII I -ssa -super -plastic -track_Hmelt -Mx 91 -My 91 -Mz 51 -quadZ \|

\verb|   -topg_to_phi 5.0,15.0,0.0,1000.0 -y 12000|

\noindent See \emph{Reference Manual}, source file \texttt{iMbasal.cc}, and \cite{BBssasliding}.


\subsubsect{Positive degree day model (PDD) parameters}

\opt{pdd\und rand}  Turns on the positive degree day model (which is off by default for \verb|pismr|, \verb|pisms|, and \verb|pismv|).  Use a monte carlo method based on a random number generator.  Note that if \verb|-pdd_std_dev 0.0| is set then the additional randomness is not active.  See subsection \ref{subsect:pdd}.

\opt{pdd\und rand\und repeatable}  Same effect as \verb|pdd_rand| but additionally sets the ``seed'' for the random number generator to a default.  This makes runs based on the monte carlo method repeatable.

\optdef{pdd\und factor\und ice}{0.008}  The amount of ice, measured in meters, which is melted per positive degree day.  In units of $\text{m}\!\phantom{|}^\circ\text{C}^{-1}\text{day}^{-1}$.  See subsection \ref{subsect:pdd}.

\optdef{pdd\und factor\und snow}{0.003}  The amount of snow, measured in meters ice-equivalent, which is melted per positive degree day.  In units of $\text{m}\phantom{|}^\circ\text{C}^{-1}\text{day}^{-1}$.  See subsection \ref{subsect:pdd}.

\optdef{pdd\und refreeze}{0.6}  Fraction of melted snow, from positive degree day melting, which locally refreezes as ice (and therefore adds to accumulation).  See subsection \ref{subsect:pdd}.

\optdef{pdd\und std\und dev}{5.0}  Standard deviation of temperature increment added each day to temperature cycle in positive degree day model.  Units of $\phantom{|}^\circ\text{C}$.  See subsection \ref{subsect:pdd}.

\optdef{pdd\und summer\und peak\und day}{243.0}  Julian day of peak summer temperature.  Default of August 1st is clearly not appropriate to Antarctica!  See subsection \ref{subsect:pdd}.

\optdef{pdd\und summer\und warming}{15.0}  Difference between peak summer temperature and mean annual temperature at each grid location.  Units of $\phantom{|}^\circ\text{C}$.  See subsection \ref{subsect:pdd}.  Note \verb|pgrn| ignors this option; see section \ref{sect:green}.


\subsubsect{Plastic till model parameters}

\optdef{plastic\und c0}{0.0}  Set the value of the till cohesion in the plastic till model.  The value is a pressure, given in kPa.  Only effective if used with \verb|-plastic| and \verb|-ssa|.

Note Schoof \cite{SchoofStream} formula (2.4) uses $c_0 = 0$.

\optdef{plastic\und pwfrac}{0.95}  Set what fraction of overburden pressure is assumed as the till pore water pressure.  Only relevant at basal points where there is a positive amount of basal water.  The value is a pure number.  Only effective if used with \verb|-plastic| and \verb|-ssa|.

\optdef{plastic\und reg}{0.01 m/a}    Set the value of $\eps$ regularization of plastic till; this is the second ``$\eps$'' in formula (4.1) in \cite{SchoofStream}.  Only effective if used with \verb|-plastic| and \verb|-ssa|.

\optdef{plastic\und phi}{30.0}  Set the till friction angle.  The value is an angle $\phi$, given in degrees, and the coefficient $\mu$ in formula (2.4) in \cite{SchoofStream} is computed from $\theta$ by this formula:
	$$\mu = \tan\left(\frac{\pi}{180} \theta\right).$$
Only effective if used with \verb|-plastic| and \verb|-ssa|.


\subsectstar{Options controlling the computational grid and box}

\opt{chebZ}  Specify Chebyshev-spaced grid in the vertical.  \emph{This grid is extremely fine near the base}, and choice \verb|-quadZ| is probably better justified (by current understanding of the thermocoupling and age problems) than is \verb|-chebZ|.  Use only in combination with the option \verb|-boot_from| or with executables \verb|pisms| and \verb|pismv|.  That is, use only when creating a vertical grid from scratch.  For a detailed description of the spacing of the grid, see the documentation on \verb|IceGrid::compute_vertical_levels()| in the \emph{PISM Reference Manual}.

\opt{Lx}  The x direction half-width of the computational box, in kilometers.  See section \ref{sect:usage}.

\opt{Ly}  The y direction half-width of the computational box, in kilometers.  See section \ref{sect:usage}.

\opt{Lz}  The height of the computational box for the ice (excluding the bedrock thermal model part).  See section \ref{sect:usage}.

\optdef{Mbz}{1}  Number of grid points in the bedrock for the bedrock thermal model.  The highest grid point corresponds to the base of the ice $z=0$, and so \t{Mbz}$>1$ is required to actually have bedrock thermal model.  Note this option is unrelated to the bed deformation model (glacial isostasy model); see option \verb|-bed_def| for that.

\optdef{Mx}{61}  Number of grid points in x horizontal direction.

\optdef{My}{61}  Number of grid points in y horizontal direction.

\optdef{Mz}{31}  Number of grid points in z (vertical) direction.

\opt{quadZ}  Specify quadratically-spaced grid in the vertical.  Use only in combination with the option \verb|-boot_from| or with executables \verb|pisms| and \verb|pismv|.  That is, use only when creating a vertical grid from scratch.  For a detailed description of the spacing of the grid, see the documentation on \verb|IceGrid::compute_vertical_levels()| in the \emph{PISM Reference Manual}.


\subsectstar{Options controlling numerical methods}

\subsubsect{General methods}

\optdef{adapt\und ratio}{0.12}  Adaptive time stepping ratio for the explicit scheme for the mass balance equation.

\opt{eta}  The surface gradient is usually computed in the obvious way by finite differences applied to the surface elevation $h$.  Specifically, we use the Mahaffy \cite{Mahaffy} scheme.  Alternatively, if this option is set we first transform the thickness $H$ by $\eta = H^{(2n+2)/n}$ and then differentiating the sum of the thickness and the bed:
	$$\grad h = \grad H + \grad b = \frac{n}{(2n+2)} \eta^{(-n-2)/(2n+2)} \nabla \eta + \nabla b.$$
Here $b$ is the bed elevation and $h$ is the surface elevation.  The transformation sometimes has the benefits that the surface values of the horizontal velocity and vertical velocity, and the driving stress, are better behaved near the margin.  See \cite{CDDSV} for the technical explanation of this transformation and compare \cite{SaitoMargin}.

\optdef{low\und temp}{200.0}  Set the temperature which PISM will regard as ``too low''.  Units in Kelvin.  Note that one kind of numerical error associated to the advection part of the conservation of energy scheme is for the maximum principle to be violated.  In that case temperatures appear at the next step which are outside the range of current temperatures.  PISM attempts to count such violations, and if the number is too great then the run is stopped.  See option \verb|-max_low_temps|.

\optdef{max\und dt}{60.0}  The maximum time-step in years.  The adaptive time-stepping scheme will make the time-step shorter than this as needed for stability, but not longer.  See section \ref{sect:usage}.

\optdef{max\und low\und temps}{10}  Specify the number (a nonnegative integer) of allowed low temp violations per time step.  Note these are reported in detail (i.e.~with location) if \verb|-verbose| is set.  Note that one kind of numerical error associated to the advection part of the conservation of energy scheme is for the maximum principle to be violated.  In that case temperatures appear at the next step which are outside the range of current temperatures.  PISM attempts to count such violations, and if the number is too great then the run is stopped.  See option \verb|-low_temp| for the cutoff low temperature.

\optdef{skip}{10}  Number of mass-balance steps, including SIA diffusivity updates, to perform before a the temperature, age, and SSA stress balance computations are done.  This is only effective if the time step is being limited by the diffusivity time step restriction associated to mass continuity using the SIA.  The maximum recommended value for \verb|-skip| is, unfortunately, dependent on the context.  The temperature field should be updated when the surface changes significantly, and likewise the basal sliding velocity if it comes (as it should) from the SSA calculation.


\subsubsect{Shelf and stream numerical method}

\optdef{ice\und reg\und schoof\und length}{1000 km}  Set the ``$L$'' in formula (4.1) in \cite{SchoofStream}.  To use the regularization described by Schoof, one must set \verb|-ssa_eps 0.0| to turn off the other regularization mechanism, otherwise there is a double regularization (the default except in \verb|pism -test I|).

\optdef{ice\und reg\und schoof\und vel}{1 m/a}  Set the \emph{first} ``$\eps$'' in formula (4.1) in \cite{SchoofStream}.  To deactivate Schoof's regularization, use \verb|-ice_reg_schoof_vel 0|.  To use the regularization described by Schoof, one must set \verb|-ssa_eps 0.0| to turn off the other regularization mechanism, otherwise there is a double regularization (the default except in \verb|pismv -test I|).  Use \verb|-plastic_reg| above to set the second ``$\eps$'' in formula (4.1) of \cite{SchoofStream}.

\opt{shelves\und drag\und too}  Ice streams are modeled as ``dragging ice shelves'' in PISM, as in either linear \cite{MacAyeal} or plastic \cite{SchoofStream} or pseudo-plastic basal resistance, according to options.  If this option is turned on then the floating ice shelves also have very slight resistance, according to a linear model $\tau_b = \beta u$ where $\beta = 1.8\times 10^5\, \text{Pa}\,\text{s}\,\text{m}^{-1}$.  This value is $10^4$ times smaller than the representative drag coefficient given for ice stream E in \cite{HulbeMacAyeal}.  Ice shelves usually have precisely zero basal resistance, but nonzero drag for the ice shelf is turned on by default in MISMIP; see section \ref{sect:simp}.

\optdef{ssa\und eps}{1e-15} The numerical scheme for the shallow shelf approximation  \cite{WeisGreveHutter} computes an effective viscosity which which depends on velocity and temperature.  After that computation, this constant is added to the effective viscosity (to keep it bounded away from zero).  The units are kg $\text{m}^{-1}\,\text{s}^{-1}$.  By default, the regularization in equation (4.1) of \cite{SchoofStream} is also active, use \verb|-ice_reg_schoof_vel 0| to deactivate Schoof's regularization. Turn off this lower bound mechanise by \verb|-ssa_eps 0.0| to exclusively use the Schoof regularization mechanism; see \verb|-ice_reg_schoof_vel| and \verb|-ice_reg_schoof_length| below.  Note \verb|-ssa_eps| is set to zero automatically when running \verb|pismv -test I|.

\opt{ssa\und external} We are experimenting with other solvers for the stream and shelf equations.  If given, this option exposes these experimental solvers.  Run with \verb:-ssa_external -help | grep ssa_: to see what options are available.

\optdef{ssa\und maxi}{300}  This option sets the maximum allowed number of nonlinear iterations in solving the shallow shelf approximation.  One should usually use option \verb|-ssa_rtol| to control convergence of the nonlinear iteration.

\optdef{ssa\und rtol}{1.0e-4}  The numerical scheme for the shallow shelf approximation \cite{WeisGreveHutter} does a nonlinear iteration wherein velocities (and temperatures) are used to compute a vertically-averaged effective viscosity which is used to solve the equations for horizontal velocity.  Then the new velocities are used to recompute an effective viscosity, and so on.  This option sets the relative change tolerance for the effective viscosity.

In particular, the nonlinear part of the iteration requires that successive values $\nu^{(k)}$ of the vertically-averaged effective viscosity satisfy
	$$\frac{\|(\nu^{(k)} - \nu^{(k-1)}) H\|_2}{\|\nu^{(k)} H\|_2} \le \text{ssa\und rtol}$$
in order to end the iteration with $\nu = \nu^{(k)}$.  See also \verb|-ksp_rtol|, a PETSc option below, as one may want to require a high relative tolerance for the linear iteration as well.


\subsectstar{Options special to verification and simplified geometry cases}


\subsubsect{Verification}

\optrestrict{pause}{pismd -ross,pismv -test I,pismv -test J}    Pause for given number of seconds at the end of the run when the results are displayed.

\optrestrict{no\und report}{pismv}  Do not report errors at the end of a verification run.

\optrestrict{eo}{pismv}  Only evaluate the exact solution (don't do numerical approximation at all).  See section \ref{sect:verif}.

\optdefrestrict{test}{A}{pismv}  Choose which verification test to run by giving its single character name.  See section \ref{sect:verif}.


\subsubsect{EISMINT II}

\optrestrict{bmr\und in\und cont}{pisms -eisII}  By default PISM includes the basal melt rate in the continuity equation.  The EISMINT II experiments specify that it should not be included \cite{EISMINT00}, so the default behavior of \verb|pisms -eisII| is to not include it.  This option makes \verb|pisms -eisII| behave like the generic PISM cases (e.g.~\verb|pismr|).

\optdefrestrict{eisII}{A}{pisms}  Choose single character name of EISMINT II \cite{EISMINT00} simplified geometry experiment.  Allowed values are A, B, C, D, E, F, G, H.

\optrestrict{Mmax}{pisms -eisII}  Set value of $M_{\text{max}}$ for EISMINT II.

\optrestrict{Rel}{pisms -eisII}    Set value of $R_{\text{el}}$ for EISMINT II.

\optrestrict{Sb}{pisms -eisII}    Set value of $S_b$ for EISMINT II.

\optrestrict{ST}{pisms -eisII}    Set value of $S_T$ for EISMINT II.

\optrestrict{Tmin}{pisms -eisII}    Set value of $T_{\text{min}}$ for EISMINT II.

\optrestrict{track\und Hmelt}{pisms -eisII}    Turn on the part of the conservation of energy model which accumulates (tracks) locally-stored basal melt water.


\subsubsect{EISMINT-Greenland}  

\noindent \emph{See section \ref{sect:green} to understand these options.  ``Specification'' refers to the EISMINT-Greenland specification in \cite{RitzEISMINT}.}

\optrestrict{ccl3}{pgrn -forcing}    Run EISMINT-Greenland climate control experiment.

\optrestrict{gwl3}{pgrn}    Run EISMINT-Greenland greenhouse warming scenario.

\optrestrict{have\und artm}{pgrn}  Use a surface temperature map in the input file, instead of elevation-latitude formula in specification.

\optrestrict{have\und bheatflx}{pgrn}  Use a geothermal flux map in the input file, instead of the constant value in the specification (namely $50\,\text{mW}\,\text{m}^{-2}$).

\optrestrict{no\und EI\und delete}{pgrn}  Do not remove Ellesmere Island and Iceland from computational domain.  I.e.~leave the mask alone and allow ice to spread onto these pieces of land; very unlikely for Iceland!

\optrestrict{no\und pdd}{pgrn}  Do not use a PDD (positive degree-day) model, despite EISMINT-Greenland specification.

\optrestrict{ssl2}{pgrn}    Run EISMINT-GREENLAND steady state experiment level 2.

\optrestrict{ssl3}{pgrn}    Run EISMINT-GREENLAND steady state experiment level 3.  Use with option \verb|-gk|: ``\verb|pgrn -ssl3 -gk|.


\subsubsect{EISMINT-Ross}

\optrestrict{pause}{pismd -ross,pismv -test I,pismv -test J}    Pause for given number of seconds at the end of the run when the results are displayed.

\optrestrict{ross}{pismd}    Run the EISMINT Ross ice shelf validation \cite{MacAyealetal}.  Requires data from \url{http://homepages.vub.ac.be/~phuybrec/eismint/iceshelf.html}.


\subsect{PETSC options for PISM users}\label{subsect:petscoptions}

All PETSc programs accept command line options which control how PETSc distributes jobs among parallel processors, how it solves linear systems, what additional information it provides, and so on.  The PETSc manual \cite{petsc-user-ref} is the complete reference on these options.  We list some here that are useful to PISM users.  They can be mixed in any order with PISM options.

Both for PISM and PETSc options, there are ways of avoiding the inconvenience of long commands with many runtime options.  Obviously, and as illustrated by examples in the previous sections, shell scripts can be set up to run PISM.  But PETSc also provides two mechanisms to give runtime options without retyping at each run command.

First, the environment variable \verb|PETSC_OPTIONS| can be set.  For example, a sequence of runs might need the same refined grid, and you might want to know if other options are read, ignored, or misspelled.  Set (in bash):

\verb|export PETSC_OPTIONS="-Mx 101 -My 101 -Mz 51 -quadZ -options_left"|

\noindent The runs 

\verb|$ pismv -test F -y 100|

\verb|$ pismv -test G -y 100|

\noindent then have the same refined grid in each run, and the runs report on which options were read.

Second, the file \verb|.petscrc| is always read, if present, from the directory where PISM (i.e.~the PETSc program) is started.  It can have a list of options, one per line.  For example, to get the same options as above, \verb|.petscrc| would contain these lines:

\verb|-Mx 101|

\verb|-My 101|

\verb|-Mz 51|

\verb|-quadZ|

\verb|-options_left|

\noindent Note that the first four lines give PISM options while the last has a generic PETSc option.

These two PETSc mechanisms can be used together.  (The effect of duplicate or conflicting options is not clear, however, and should be avoided.)
\bigskip

% "-da_processors_x M -da_processors_y N" should not be documented in this sub-appendix
% because they do not work.  the reason is that IceModelVec2 and IceModelVec3 put 
% the Mx, My dimensions in different arguments to the DACreate commands

\opt{display}  The option \verb|-display :0| seems to frequently be needed to let PETSc use Xwindows when running multiple processes.  \emph{It must be given as a \emph{final} option, after all the others.}

\opt{help}  Gives PISM help message and then a brief description of many PETSc options.

\opt{info}  Gives excessive information about PETSc operations during run.  Option \verb|-verbose| for PISM (above) is generally more useful, except possibly for debugging.

\optdef{ksp\und rtol}{1e-5}  For solving the SSA equations with high resolution on multiple processors, it is recommended that this be tightened (set lower than the default).  For example, 

\verb|$  mpiexec -n 8 pismv -test I -Mx 5 -My 769|

\noindent works poorly on a certain machine, but

\verb|$  mpiexec -n 8 pismv -test I -Mx 5 -My 769 -ksp_rtol 1e-10|

\noindent works fine.

\optdef{ksp\und type}{gmres}  Based on one processor evidence from \verb|pismv -test I|, the following are possible choices in the sense that they work and allow convergence at some reasonable rate: \t{cg}, \t{bicg}, \t{gmres}, \t{bcgs}, \t{cgs}, \t{tfqmr}, \t{tcqmr}, and \t{cr}.  It appears \t{bicg}, \t{gmres}, \t{bcgs}, and \t{tfqmr}, at least, are all among the best.

\opt{log\und summary}  At the end of the run gives a performance summary and also a synopsis of the PETSc configuration in use.

\opt{options\und left}  Shows an options table which will indicate if a user option was not read or was misspelled.

\optdef{pc\und type}{ilu}   Several options are possible, but for solving the ice stream and shelf equations we recommend only \t{bjacobi}, \t{ilu}, and \t{asm}.  Of these it is not currently clear which is fastest; they are all about the same for \verb|pismv -test I| with high tolerances (e.g.~\verb|-ssa_rtol 1e-7| \verb|-ksp_rtol 1e-12|).

\opt{v}   Show version number of PETSc.


\clearpage \newpage
\section{PISM viewers: Graphical and \Matlab}\label{sect:viewers}

\subsubsection*{Viewing the PISM state}  Basic graphical views of the changing state of a PISM ice model are available at the command line by using the options ``\t{-d}'' and ``\t{-dbig}'' with additional arguments.  For instance:\index{PISM!graphical views at runtime}\pismoptionindex{d} \pismoptionindex{dbig } \index{PISM!saving \Matlab variables}

\verb|$  pismv -test G -d hTf -dbig 0|

\noindent shows a map-plane views of surface elevation (``\t{h}''), temperature at the level specified by \t{-kd} (``\t{T}''), rate of change of thickness (``\t{f}'') and of horizontal ice speed at the surface (``\t{0}'', i.e.~zero).

The option \t{-d} is followed by a space and then a list of single-character names of the diagnostic viewers.  The option \t{-dbig} works exactly the same way, with the same list of single-character names available.  The bigger viewers take precedence, so that ``\t{-d hT -dbig T}'' shows only two viewers, namely a regular size viewer for surface elevation and a larger viewer for temperature.
\medskip

The same views of the PISM model can be saved \emph{at the end of the run} to a \Matlab-readable ASCII file by the same single character names.  (At this point, \emph{most} of the names are allowed; see the list below.)  We will call these ``\Matlab views''.  For instance,

\verb|$  pismv -test G -mato foo -matv hTf0|

\noindent will save surface elevation (``\t{h}''), temperature at the level specified by \t{-kd} (``\t{T}''), rate of change of thickness (``\t{f}'') and of horizontal ice speed at the surface (``\t{0}'') in an ASCII file \verb|foo.m|.  To use \verb|foo.m| at the \Matlab command line, make sure the \Matlab path includes the directory with \verb|foo.m|.  Then just do

\verb|>> foo|

\noindent You will be able to plot the surface elevation (for example) by

\verb|>> imagesc(x,y,flipud(H')), axis square, colorbar|

\noindent but you can also use the \Matlab tools \verb|contour|, \verb|surf|, and so on.  (\emph{The necessity to do} ``\verb|flipud(H')|'' \emph{to get the expected orientation, that is, the necessity of doing both do a transpose \emph{and} a} \verb|flipud|, \emph{is for various deep reasons too complicated to explain here.  Feel free to enquire, but \emph{sorry} in the meantime.})


\subsubsection*{Single character names (for each view)}  The single character diagnostic viewer and \Matlab views names are:
\newcommand{\notMat}{(\emph{NOT available as a} \Matlab \emph{view}.)\xspace\xspace}

\verb|0|:\quad Map-plane view of horizontal ice speed (magnitude of velocity) at the surface of the ice in meters per year.

\verb|1|:\quad Map-plane view of $x$-component of horizontal ice velocity at the \emph{surface} of the ice in meters per year.

\verb|2|:\quad Map-plane view of $y$-component of horizontal ice velocity at the \emph{surface} of the ice in meters per year.

\verb|3|:\quad Map-plane view of vertical ice velocity at the \emph{surface} of the ice in meters per year; positive values are upward velocities.

\verb|4|:\quad Map-plane view of $x$-component of horizontal ice velocity at the \emph{base} of the ice in meters per year.

\verb|5|:\quad Map-plane view of $y$-component of horizontal ice velocity at the \emph{base} of the ice in meters per year.

\verb|C|:\quad Map-plane view of basal till yield stress $\tau_c$, under plastic till ice stream model.  Units of kPa.

\verb|D|:\quad \notMat Map-plane view of diffusivity coefficient $D$ in mass balance equation in $\text{m}^2/s$.  Meaningful only in regions of shallow ice flow.

\verb|E|:\quad Map-plane view of age of the ice, in years.

\verb|F|:\quad Map-plane view of basal geothermal heat flux, in milliWatts per meter squared.

\verb|H|:\quad Map-plane view of thickness in meters.

\verb|I|:\quad Map-plane view of till friction angle in degrees.

\verb|L|:\quad Map-plane view of basal melt water \emph{thickness} in meters.

\verb|P|:\quad \notMat (\emph{ONLY available for }\t{pismv}.)  Map-plane view of comPensatory heating term $\Sigma_C$ in thermocoupled verification tests F and G.  Displayed at chosen elevation above base; see option \verb|-kd|.

\verb|Q|:\quad Map-plane view of basal driving stress $f_{\text{basal}} = \rho g H |\grad h|$.  Units of kPa.  Note that this quantity is the effective shear stress at the base in the SIA.  It is also the (magnitude of the) driving source term in the SSA, for both ice streams and ice shelves.  Compare to \verb|-d C|, the view of the till yield stress, when using the plastic till ice stream model.

\verb|R|:\quad Map-plane view of basal frictional heating in milliWatts per meter squared.

\verb|S|:\quad Map-plane view of strain heating term $\Sigma$ in temperature equation, in Kelvin per year.  Displayed at chosen elevation above base; see option \verb|-kd|.

\verb|T|:\quad Map-plane view of absolute ice temperature in Kelvin.  Displayed at chosen elevation above base; see option \verb|-kd|.

\verb|U|:\quad Map-plane view of vertically averaged horizontal velocity in the $x$-direction \emph{on the staggered grid} which is offset by positive one in $i$ direction;  in meters per year.  (\emph{Meaningful only in technical/numerical context}; use \verb|u| generally.)

\verb|V|:\quad Map-plane view of vertically averaged horizontal velocity in the $y$-direction \emph{on the staggered grid} which is offset by positive one in $j$ direction;  in meters per year.  (\emph{Meaningful only in technical/numerical context}; use \verb|v| generally.)

\verb|X|:\quad Map plane view of $x$-component of horizontal velocity, in meters per year.  Displayed at chosen elevation above base; see option \verb|-kd|.

\verb|Y|:\quad Map plane view of $y$-component of horizontal velocity, in meters per year.  Displayed at chosen elevation above base; see option \verb|-kd|.

\verb|Z|:\quad Map plane view of vertical velocity, in meters per year.  Displayed at chosen elevation above base; see option \verb|-kd|.

\verb|b|:\quad Map-plane view of bed elevation in meters above sea level.

\verb|c|:\quad Map-plane view of horizontal speed, namely the absolute value of the vertically-averaged horizontal velocity.  Displayed as log base ten of speed in meters per year.

\verb|e|:\quad Age in a vertical column (sounding); in years.  See \verb|-id|, \verb|-jd| to set sounding location.

\verb|f|:\quad Map-plane view of thickening rate of the ice, in meters per year.

\verb|h|:\quad Map-plane view of ice surface elevation in meters above sea level.

\verb|i|:\quad Map-plane view of vertically-averaged effective viscosity times thickness; on $i$ offset grid.  Only meaningful in ice streams and shelves.

\verb|j|:\quad Map-plane view of vertically-averaged effective viscosity times thickness; on $i$ offset grid.  Only meaningful in ice streams and shelves.

\verb|k|:\quad \notMat Iteration monitor for the Krylov subspace routines (KSP) in Petsc.  Shows norm of residual versus iteration number.  Has same effect as PETSc option \verb|-ksp_monitor_draw|.

\verb|l|:\quad Map-plane view of basal melt \emph{rate} in meters per year.

\verb|m|:\quad Map-plane view of mask for flow type:  \textbf{1} = grounded shallow ice sheet flow,  \textbf{2} = dragging ice shelf, \textbf{3} = floating ice shelf, \text{7} = ice free ocean (in original input file).

%\verb|N|:\quad Produces two viewers, namely the $i$ offset and $j$ offset grid versions of the rate of change of the vertically-averaged effective viscosity times thickness.  Only meaningful in ice streams and shelves.

\verb|n|:\quad Map-plane view of the log base ten of the vertically-averaged effective viscosity times thickness on the regular grid.  Only meaningful in ice streams and shelves.

\verb|p|:\quad Map-plane view of bed uplift rate in meters per year.

\verb|q|:\quad Map-plane view of basal sliding speed.  Displayed as log base ten of speed in meters per year.

\verb|r|:\quad Map-plane view of surface temperature in Kelvin.

\verb|s|:\quad Strain heating term $\Sigma$ in vertical column (sounding).  See \verb|-id|, \verb|-jd| to set sounding location.

\verb|t|:\quad Absolute ice temperature in vertical column (sounding).  Note this sounding extends into the bedrock, unlike the other soundings (e.g.~\verb|-d egsxyz|).  See \verb|-id|, \verb|-jd| to set sounding location.

\verb|u|:\quad Map-plane view of vertically averaged horizontal velocity in the $x$-direction;  in meters per year.

\verb|v|:\quad Map-plane view of vertically averaged horizontal velocity in the $y$-direction;  in meters per year.

\verb|x|:\quad $x$-component of horizontal velocity in vertical column (sounding).  See \verb|-id|, \verb|-jd| to set sounding location.

\verb|y|:\quad $y$-component of horizontal velocity in vertical column (sounding).  See \verb|-id|, \verb|-jd| to set sounding location.

\verb|z|:\quad Vertical velocity ($w$-component of velocity) in vertical column (sounding).  See \verb|-id|, \verb|-jd| to set sounding location.



\clearpage \newpage
\section{Python scripts for PISM modeling}\label{sect:scripts}

\newcommand{\scriptoptdef}[3]{\vspace{1mm}\noindent \large\texttt{-#1},\,\,\texttt{--#2=}\normalsize\,\,[\textsl{#3}]:\quad}

\newcommand{\scripthead}[1]{\subsubsection*{\Large{\texttt{#1}}}}

\newcommand{\opthead}{\smallskip \noindent\textsc{options}.\quad}

\scripthead{util/fill\und missing.py}\index{fill\und missing.py}  This script uses an approximation to Laplace's equation
	$$\grad^2 u = 0$$
to smoothly replace missing values in two-dimensional NetCDF variables with the average of the ``nearby'' non-missing values.

Section \ref{sect:green} gives an example of actual usage on the bed elevations in the EISMINT-Greenland data.  Here is a hypothetical example usage, of filling the missing values in the two variables \verb|topg| and \verb|usurf|, using a convergence tolerance of $10^{-4}$ and the initial guess of $100$, on data in the NetCDF file \verb|data.nc|:

\begin{verbatim}
fill_missing.py -f data.nc -v topg,usurf --eps=1.0e-4 \
                -i 100.0 -o data_smoothed.nc
\end{verbatim}
Note that \verb|-i| and \verb|-e| specify the initial guess and the convergence tolerance for \emph{all} the specified variables, so using these options only makes sense if all the variables have the same units. Moreover, making a good initial guess can noticeably reduce the time needed to fill in the holes, so we recommend processing variables one at a time.

\opthead  \verb|fill_missing.py| takes the following options.  They have both a short form and a long form, \emph{a la} GNU; the default is in brackets:

\scriptoptdef{e}{eps}{$1.0$}  Convergence tolerance for iteration to solve Laplace's equation.

\scriptoptdef{f}{file}{no default}  The full name of the NetCDF file from which to read variables for filling.

\scriptoptdef{o}{out\und file}{no default}  Full name of output file.

\scriptoptdef{i}{initial\und guess}{'mean'}  The initial guess used by the script; should be within the valid range of values. The default is the mean of all the \emph{present} values of a variable.

\scriptoptdef{v}{variables}{no default}  Comma separated list of variables for which to fill missing values.  Note that each of the listed variables must have missing values specified according to CF Metadata conventions. Namely, each of the listed variables must have one of the following: \verb|valid_range| or both of \verb|valid_min| and \verb|valid_max| defined if the values are in a specific range; one of \verb|valid_min| and \verb|valid_max| if values are greater (or less, respectively) than some value, or \verb|_FillValue|. Also note that \verb|_FillValue| is interpreted as \verb|valid_max| if it is positive and as \verb|valid_min| otherwise; see \href{http://www.unidata.ucar.edu/software/netcdf/guide_10.html#SEC76}{NetCDF User's Guide: Attributes} for details. The \verb|missing_value| is deprecated by the NetCDF User's Guide, but is supported for backward compatibility.


\scripthead{util/series.py}\index{series.py}  This Python script postprocesses the standard output of \verb|pismr|, \verb|pisms|, \verb|pgrn|, or \verb|pismv|, if it is stored in a text file, to generate a NetCDF file with a time series.\footnote{That is, it postprocesses standard output from the PISM \emph{evolution} executables.  Output from \texttt{pismd}, an executable for diagnostic runs, leads to no meaningful time series.}  This yields time series for ice sheet volume, area, melt fraction, thickness at the center of the grid, and temperature of the base of the ice at the center of the grid, in the default case.  Also the time series for the time step length itself is extracted.  The result is a one-dimensional NetCDF file.

An example usage is

\begin{verbatim}
$  pisms -eisII A -Mx 61 -My 61 -Mz 201 -y 5000 >> eisIIA.out
$  series.py -f eisIIA.out -o eisIIA_series.nc
$  ncview eisIIA_series.nc|
\end{verbatim}
Note that multiple runs can have their standard out concatenated, and \verb|series.py| will (generally) give reasonable behavior.  For example,

\begin{verbatim}
$  pisms -eisII A -i simp_exper.nc -y 1000 >> eisIIA.out
$  pisms -eisII A -i simp_exper.nc -y 1000 >> eisIIA.out
$  series.py -f eisIIA.out -o eisIIA_ser_more.nc
\end{verbatim}
gives a reasonable time series even though the file \verb|eisIIA.out| twice has the evidence of the run stopping, being saved, and restarting.  Note that the \verb|delta_t| variable in \verb|eisIIA_ser_more.nc| goes to zero when there is a restart; this is a feature not a bug.

An even more sophisticated usage is when a script runs PISM in several different ways and generates a long text file from standard out, say \verb|foo.txt|.  One can use \verb|less -N| to view the file with line numbers, and search backward and forwards  for ``PISM'' at each restart, with \verb|/PISM| or  \verb|?PISM| to find a range of line numbers for each run (for which a time series is desired).  Suppose we determine that we want line numbers 100 through 1234.  Then extract that range and run \verb|series.py|:

\begin{verbatim}
$ cat foo.txt | sed -n '100,1234p' >> extract.txt
$ series.py -f extract.txt -o desired_series.nc
\end{verbatim}
\opthead  \verb|series.py| takes the following options.  They have both a short form and a long form, \emph{a la} GNU; the default is in brackets:

\scriptoptdef{f}{file}{foo.txt} The full name of the text file.

\scriptoptdef{o}{out}{series\und out.nc} The full name of the output NetCDF file.


\scripthead{test/verifynow.py}\index{verifynow.py}  This Python script organizes the process of verifying PISM.  It specifies standard refinement paths for each of the tests described in section \ref{sect:verif}.  It runs the tests, times them, and summarizes the numerical errors reported at the end.

In a standard PISM installation, to run this script you will want to \verb|cd test/| and run the script there with ``\verb|./|'' or ``\verb|python|''.

Three example usages are \begin{itemize}
\item ``\verb|verifynow.py|'' without options will use one processor and do three levels of refinement; this command is equivalent to \verb|verifynow.py -n 1 -l 3 -t CGIJ|
\item ``\verb|verifynow.py -n 8 -l 5 -t J --prefix=bin/ --mpido=mpirun/|'' will use \verb|mpirun -np 8| \verb|bin/pismv| as the command and do five levels (the maximum) of refinement only on test J
\item ``\verb|verifynow.py -n 2 -l 3 -t CEIJGKL -u 1|'' uses the two cores on my laptop and runs in about two hours; the vertical spacing is not equal (its \verb|-quadZ|)
\item ``\verb|verifynow.py -n 40 -l 5 -t ABCDEFGIJKL|'' will use forty processors to do all possible verification as managed by \verb|verifynow.py|; don't run this unless you have a big computer and you are prepared to wait
\end{itemize}

\opthead  \verb|verifynow.py| takes the following options.  They have both a short form and a long form, \emph{a la} GNU; the default is in brackets:

\scriptoptdef{l}{levels}{3} specifies number of levels of refinement; $1,2,3,4,5$ are allowed values

\scriptoptdef{m}{mpido}{\texttt{mpiexec}} how to run PISM as an MPI program

\scriptoptdef{n}{nproc}{1} specify number of processors to use

\scriptoptdef{p}{prefix}{} where the PISM executable \verb|pismv| is located

\scriptoptdef{t}{tests}{CGIJ} which tests to run

\scriptoptdef{u}{unequal}{0} spacing in vertical: \verb|-u 0| is default equal spacing, \verb|-u 1| adds option \verb|-quadZ| to \verb|pismv| call, and \verb|-u 2| adds option \verb|-chebZ| to \verb|pismv| call; see documentation on options \verb|-quadZ| and  \verb|-chebZ|

\medskip
Note that timing information is also given in the \verb|verifynow.py| output.  Therefore performance, including parallel performance, can be assessed along with accuracy.

The exact meaning of the various errors reported by \verb|pismv|, which appear in a \verb|verifynow.py| output as well, is currently only documented in the source files \verb|pism/src/verif/iceCompModel.cc|, \verb|pism/src/verif/iCMthermo.cc|, and \verb|pism/src/verif/iceExactSSAModel.cc|.  


\scripthead{test/vnreport.py}\index{vnreport.py}  This Python script postprocesses the standard output of \verb|verifynow.py| above.  The output is converted into graphs using \verb|matplotlib|.  Example graphs are Figures \ref{fig:thickerrsB} through \ref{fig:temperrsK} in section \ref{sect:verif}.

In a standard PISM installation, to run this script you will want to \verb|cd test/| and run the script there with ``\verb|./|'' or ``\verb|python|''.

The basic use is this:

\begin{verbatim}
$  verifynow.py -n 2 -l 3 -t BGIK >> foo.txt
$  vnreport.py -f foo.txt -t B -e 'geometry' -o thickerrs
\end{verbatim}
(Figures \ref{fig:thickerrsB} through \ref{fig:temperrsK} in section \ref{sect:verif} were actually generated by a level five (``\verb|-l 5|'') \verb|verifynow.py| run, but that takes a lot of computer time.)

The \verb|verifynow.py| run will take a while.  The \verb|vnreport.py| run will (quickly) look at \verb|foo.txt| and extract the geometry (thickness) numerical errors and refinement path and build a \verb|.png| image like that in Figure \ref{fig:thickerrsB}.\footnote{A useful post-processing step on such \texttt{.png} images is to use one of the ImageMagick (\href{http://www.imagemagick.org/}{www.imagemagick.org}) tools to autocrop the white space: \texttt{mogrify -trim +repage thickerrs\und G.png}.  This degrades the quality of \texttt{.pdf} images, so it is not recommended for those.}  To generate a \verb|.pdf| image, add option \verb|-g pdf|.

The \verb|Makefile| in the documentation directory \verb|pism/doc/| gives more example usages.  In fact, \verb|vnreport.py| is primarily used to automate the creation of this manual.

\opthead  \verb|vnreport.py| takes the following options:

\scriptoptdef{e}{error}{geometry} which kind of error to look for; for example, with test E the valid possibilities are \verb|geometry| and \verb|'base vels'|

\scriptoptdef{f}{file}{foo.txt} name of the text file containing the \verb|verifynow.py| report

\scriptoptdef{g}{graphformat}{png} image file type; \verb|png| and \verb|pdf| are the two supported possiblities

\scriptoptdef{o}{out}{report} prefix of output file name; if ``\verb|-t G -o bar|'' then output file is named ``\verb|bar_G.pdf|''

\scriptoptdef{r}{pismrev}{0} PISM revision number to add to title of image; only displayed if positive ($>0$)

\scriptoptdef{t}{test}{A} the test for which to find the \verb|verifynow.py| report; only one value allowed

\scriptoptdef{x}{exclude}{} specify tags of errors to exclude from the figure


\scripthead{util/nc2mat.py}\index{nc2mat.py} This Python script reads specified variables from a NetCDF file and writes them to an output file in the MATLAB binary data file format (\verb|.mat|, supported by MATLAB version 5 and later). It depends on \verb|netcdf4-python| and SciPy.

\opthead \verb|nc2mat.py| takes the following options:

\scriptoptdef{o}{output}{same as input, with \t{.nc} replaced with \t{.mat}} output file name

\scriptoptdef{v}{variables}{all the variables} the list of variables to write to the output file

\scriptoptdef{e}{exclude}{no variables} the list of variables to exclude

Here are some examples:

\verb|nc2mat.py -e x,y,z ross.nc|

\noindent will read all the variables except \verb|x|, \verb|y| and \verb|z| from \verb|ross.nc| and write them to \verb|ross.mat|.

\verb|nc2mat.py -v thk,acab -o ross_matlab.mat ross.nc|

\noindent will read variables \verb|thk| and \verb|acab| from \verb|ross.nc| and write them to \verb|ross_matlab.nc|.

\verb|nc2mat.py ross.nc|

\noindent will read all the variables from \verb|ross.nc| and write them to \verb|ross.mat|.

Note that the options should go before the input file name. Also note that PISM saves all the variables using the single precision (type \verb|float|), while most MATLAB plotting functions expect data to have double precision (type \verb|double|), so one might need to convert them explicitly.

Assuming that \verb|ross.nc| contains data produced by a PISM run like ones in section \ref{sect:ross}, running

\verb|nc2mat.py -v cbar ross.nc|

\noindent and then typing
\begin{verbatim}
>> load ross.mat;
>> cbar = double(reshape(cbar, 147, 147));
>> pcolor(cbar);colorbar();
\end{verbatim}
in the MATLAB shell will produce a picture similar to Figure \ref{fig:rossspeed}.

\label{sect:index}
\printindex

\end{document}
